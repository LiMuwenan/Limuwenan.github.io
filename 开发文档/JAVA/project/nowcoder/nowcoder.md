# 1 简介

开发类牛客讨论区、

技术架构：

- Spring Boot
- Spring、Spring MVC、MyBatis
- Redis、Kafka、Elasticsearch：操作内存的数据库、消息队列、搜索引擎
- Spring Security、Spring Actuator



涉及到的知识点：

- [动态sql](# 2.1.4 接口映射文件)
- [帖子分页，标签动态激活](# 2.3.1 帖子分页)
- [注册逻辑，重用HTML](# 4.1 访问注册页面)
  - [发送邮件](# 3 发送邮件)
  - [用户激活逻辑](# 4.2 激活注册账号)
- [登录逻辑](# 5 登录)
  - [生成验证码](# 5.1 生成验证码)
  - [生成登录凭证](# 5.2 登录凭证)
  - [cookie应用](# 5.3.3 修改Controller)
  - [ajax请求的使用](# 5.5.2 ajax验证邮箱是否存在)
  - [拦截器使用](# 6.1 显示登录信息)
  - [多线程数据共享](# 6.1.4 创建HostHolder)
  - [上传文件逻辑](# 6.2 账号设置)
  - [输入输出流使用](# 5.6.1 创建UserController)
  - [自定义注解--检查登录状态](# 5.6 检查登录状态)
- [过滤敏感词](# 7.1 过滤敏感词)
  - [前缀树](# 7.1.1 前缀树)
- [帖子相关逻辑](# 7.3 帖子详情)
  - [事务管理](# 7.3.5 添加评论)
- [私信通知相关逻辑](# 8 私信)
- [统一异常处理](# 9 异常处理)
- [统一记录日志-AOP](# 10 日志记录)
- [点赞逻辑](# 11.1 点赞)
  - [redis简单使用](# 11.1.2 创建RedisKey工具类)
- [关注逻辑](# 11.3 关注和取消关注)
- [系统通知](# 14 发送系统通知)
  - [消息队列-kafka](# 14 发送系统通知)
- [Spring Security](# 15 权限控制)
  - [tymeleaf+security](# 16 置顶、加精、删除)
- [网站数据统计](# 17 网站数据统计)
- [任务执行调度](# 18 任务执行和调度)

# 2 开发首页

- 开发流程
  
  - 1次请求执行过程
  
- 分布实现
  - 开发社区首页，显示前10个帖子
  - 开发分页组件，分页显示所有帖子
  
  
  
  

有几个需要注意的问题：

- type,driver,url,username,password等参数配置在datasource下而不是druid下
- 一定要记得配置type
- 在mybatis中需要配置映射文件的位置

```yml
# datasource
spring: 
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource #一定要配啊
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/community?serverTimezone=Asia/Shanghai
    username: root
    password: 150621


# MyBatis
mybatis:
  mapper-locations: classpath:mybatis/*.xml # 映射文件位置
#  config-location: classpath:mybatis/mybatis-config.xml # 核心配置文件位置
  type-aliases-package: com.edu.ligen.nowcoder.entity # 别名配置
  configuration:
    use-generated-keys: true # 自增长主键
    map-underscore-to-camel-case: true # 驼峰下划线自动匹配

```



需要用到个各种表

```sql
-- MySQL dump 10.13  Distrib 8.0.15, for Win64 (x86_64)
--
-- Host: localhost    Database: community
-- ------------------------------------------------------
-- Server version	8.0.15

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
 SET NAMES utf8 ;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `comment`
--

DROP TABLE IF EXISTS `comment`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `comment` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) DEFAULT NULL,
  `entity_type` int(11) DEFAULT NULL,
  `entity_id` int(11) DEFAULT NULL,
  `target_id` int(11) DEFAULT NULL,
  `content` text,
  `status` int(11) DEFAULT NULL,
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`) /*!80000 INVISIBLE */,
  KEY `index_entity_id` (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `discuss_post`
--

DROP TABLE IF EXISTS `discuss_post`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `discuss_post` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` varchar(45) DEFAULT NULL,
  `title` varchar(100) DEFAULT NULL,
  `content` text,
  `type` int(11) DEFAULT NULL COMMENT '0-普通; 1-置顶;',
  `status` int(11) DEFAULT NULL COMMENT '0-正常; 1-精华; 2-拉黑;',
  `create_time` timestamp NULL DEFAULT NULL,
  `comment_count` int(11) DEFAULT NULL,
  `score` double DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `login_ticket`
--

DROP TABLE IF EXISTS `login_ticket`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `login_ticket` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `ticket` varchar(45) NOT NULL,
  `status` int(11) DEFAULT '0' COMMENT '0-有效; 1-无效;',
  `expired` timestamp NOT NULL,
  PRIMARY KEY (`id`),
  KEY `index_ticket` (`ticket`(20))
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `message`
--

DROP TABLE IF EXISTS `message`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `message` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `from_id` int(11) DEFAULT NULL,
  `to_id` int(11) DEFAULT NULL,
  `conversation_id` varchar(45) NOT NULL,
  `content` text,
  `status` int(11) DEFAULT NULL COMMENT '0-未读;1-已读;2-删除;',
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_from_id` (`from_id`),
  KEY `index_to_id` (`to_id`),
  KEY `index_conversation_id` (`conversation_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `user`
--

DROP TABLE IF EXISTS `user`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) DEFAULT NULL,
  `password` varchar(50) DEFAULT NULL,
  `salt` varchar(50) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `type` int(11) DEFAULT NULL COMMENT '0-普通用户; 1-超级管理员; 2-版主;',
  `status` int(11) DEFAULT NULL COMMENT '0-未激活; 1-已激活;',
  `activation_code` varchar(100) DEFAULT NULL,
  `header_url` varchar(200) DEFAULT NULL,
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_username` (`username`(20)),
  KEY `index_email` (`email`(20))
) ENGINE=InnoDB AUTO_INCREMENT=101 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2019-05-05 19:37:53

```

```sql
-- MySQL dump 10.13  Distrib 8.0.15, for Win64 (x86_64)
--
-- Host: localhost    Database: community
-- ------------------------------------------------------
-- Server version	8.0.15

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
 SET NAMES utf8 ;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Dumping data for table `comment`
--

LOCK TABLES `comment` WRITE;
/*!40000 ALTER TABLE `comment` DISABLE KEYS */;
INSERT INTO `comment` VALUES (1,111,1,228,0,'xxx',0,'2019-04-04 11:13:36'),(2,111,1,228,0,'yyy',0,'2019-04-04 11:13:40'),(3,111,1,228,0,'zzz',0,'2019-04-04 11:13:43'),(4,112,1,228,0,'haha',0,'2019-04-04 11:32:03'),(5,112,1,228,0,'111',0,'2019-04-04 11:32:51'),(6,112,1,228,0,'222',0,'2019-04-04 11:32:56'),(7,112,1,228,0,'333',0,'2019-04-04 11:33:00'),(8,112,1,229,0,'haha',0,'2019-04-05 14:33:17'),(9,111,1,228,0,'ok',0,'2019-04-08 03:53:19'),(10,131,1,228,0,'我是新人, 请多关照!',0,'2019-04-08 04:09:46'),(11,111,1,231,0,'别灌水',0,'2019-04-08 06:08:32'),(12,111,1,232,0,'Hello',0,'2019-04-08 07:58:17'),(13,132,2,12,0,'How are you?',0,'2019-04-08 07:58:42'),(14,111,2,12,0,'你好',0,'2019-04-08 08:27:31'),(15,132,2,12,0,'你吃了吗',0,'2019-04-08 08:30:56'),(16,111,2,12,132,'吃了',0,'2019-04-08 08:43:13'),(17,111,2,12,132,'你呢',0,'2019-04-08 08:46:21'),(18,111,1,232,0,'哎呀',0,'2019-04-08 09:15:46'),(19,132,2,18,0,'哈哈',0,'2019-04-08 09:16:00'),(21,111,2,18,132,'嗯嗯',0,'2019-04-08 09:18:30'),(22,132,2,18,111,'嘿嘿',0,'2019-04-08 09:18:48'),(23,111,1,232,0,'1',0,'2019-04-08 10:56:02'),(24,111,1,232,0,'2',0,'2019-04-08 10:56:05'),(25,111,1,232,0,'3',0,'2019-04-08 10:56:08'),(26,111,1,232,0,'4',0,'2019-04-08 10:56:10'),(27,111,1,232,0,'5',0,'2019-04-08 10:56:13'),(28,112,1,233,0,'bbb',0,'2019-04-10 03:10:33'),(29,111,2,28,0,'bbb',0,'2019-04-10 03:10:59'),(30,112,2,28,111,'ccc',0,'2019-04-10 03:11:15'),(31,113,1,233,0,'Spring Boot',0,'2019-04-13 06:48:02'),(32,113,1,233,0,'Kafka',0,'2019-04-13 06:56:50'),(33,119,1,233,0,'说的不错, 顶顶顶!!!',0,'2019-04-13 08:35:24'),(34,120,1,233,0,'说的透彻!',0,'2019-04-13 08:50:56'),(35,122,1,233,0,'大爱',0,'2019-04-13 08:52:03'),(36,124,1,233,0,'说道心坎里去了!!!',0,'2019-04-13 08:52:57'),(37,125,1,233,0,'完全赞同!',0,'2019-04-13 08:53:35'),(38,126,1,233,0,'就是就是',0,'2019-04-13 08:54:10'),(39,127,1,233,0,'支持楼主',0,'2019-04-13 08:54:53'),(40,128,1,233,0,'果断粉你',0,'2019-04-13 08:55:22'),(41,129,1,233,0,'很好',0,'2019-04-13 08:55:45'),(42,131,1,233,0,'厉害了',0,'2019-04-13 08:56:12'),(43,112,1,234,0,'哈哈',0,'2019-04-13 09:56:33'),(44,112,1,235,0,'哈哈',0,'2019-04-13 10:26:13'),(45,112,1,236,0,'haha',0,'2019-04-13 10:34:11'),(46,111,1,236,0,'hehe',0,'2019-04-13 10:35:33'),(47,113,2,46,0,'lala',0,'2019-04-13 10:36:05'),(48,112,1,237,0,'bbb',0,'2019-04-13 14:21:04'),(49,113,1,237,0,'ccc',0,'2019-04-13 14:23:01'),(50,114,1,237,0,'ddd',0,'2019-04-13 14:23:34'),(51,115,1,237,0,'eee',0,'2019-04-13 14:24:00'),(52,116,1,237,0,'fff',0,'2019-04-13 14:24:28'),(53,117,1,237,0,'ggg',0,'2019-04-13 14:24:56'),(54,118,1,237,0,'hhh',0,'2019-04-13 14:25:33'),(55,133,1,245,0,'haha',0,'2019-04-19 03:09:41'),(56,133,2,55,0,'hehe',0,'2019-04-19 03:09:46'),(57,133,2,55,133,'heihei',0,'2019-04-19 03:09:53'),(58,133,1,246,0,'hello',0,'2019-04-19 03:37:34'),(59,111,1,246,0,'gg',0,'2019-04-19 09:21:50'),(60,134,1,249,0,'kk',0,'2019-04-19 10:16:57'),(61,134,2,60,0,'gg',0,'2019-04-19 10:17:03'),(62,134,2,60,134,'ff',0,'2019-04-19 10:17:09'),(63,111,1,233,0,'public static void main(String[] args) {\r\n  System.out.println(&quot;Hello World.&quot;);\r\n}',0,'2019-04-23 04:34:03'),(64,111,1,246,0,'不错',0,'2019-04-23 07:30:47'),(65,111,1,233,0,'很好',0,'2019-04-23 07:31:13'),(66,137,1,270,0,'x',0,'2019-04-25 06:46:09'),(67,137,1,270,0,'y',0,'2019-04-25 06:46:13'),(68,137,1,270,0,'z',0,'2019-04-25 06:46:16'),(69,137,1,270,0,'a',0,'2019-04-25 06:46:25'),(70,137,1,270,0,'b',0,'2019-04-25 06:46:28'),(71,137,1,270,0,'c',0,'2019-04-25 06:46:31'),(72,137,2,66,0,'嗯嗯',0,'2019-04-25 06:46:43'),(73,137,2,66,0,'你好',0,'2019-04-25 06:46:48'),(74,137,2,66,0,'吃了',0,'2019-04-25 06:46:57'),(75,137,2,66,137,'你呢',0,'2019-04-25 06:47:05'),(76,138,1,271,0,'private',0,'2019-04-25 07:22:28'),(77,138,1,271,0,'protected',0,'2019-04-25 07:22:33'),(78,138,2,77,0,'void',0,'2019-04-25 07:22:43'),(79,138,2,77,138,'yes',0,'2019-04-25 07:22:50'),(80,111,1,272,0,'gg',0,'2019-04-26 07:42:54'),(81,111,2,80,0,'你好',0,'2019-04-26 07:43:26'),(82,111,2,80,0,'嗯嗯',0,'2019-04-26 07:43:33'),(83,111,2,80,111,'吃了',0,'2019-04-26 07:43:40'),(84,145,1,273,0,'嘿嘿',0,'2019-04-28 07:33:03'),(85,145,2,84,0,'你好',0,'2019-04-28 07:33:12'),(86,145,2,84,145,'嗯嗯',0,'2019-04-28 07:33:16'),(87,111,1,273,0,'不错',0,'2019-04-28 10:56:14'),(88,145,1,272,0,'xxx',0,'2019-05-06 03:37:28'),(89,146,1,234,0,'不错',0,'2019-05-10 02:35:01'),(90,146,2,43,0,'嗯嗯',0,'2019-05-10 02:35:09'),(91,112,2,43,0,'你好',0,'2019-05-10 02:35:29'),(92,113,1,234,0,'嘿嘿嘿',0,'2019-05-10 02:36:06'),(93,114,1,234,0,'啦啦啦',0,'2019-05-10 02:36:25'),(94,114,1,234,0,'yes',0,'2019-05-10 02:36:41'),(95,115,1,234,0,'很悬很悬',0,'2019-05-10 02:37:16'),(96,146,1,234,0,'行不行啊',0,'2019-05-10 04:39:16'),(97,146,2,96,0,'你呢',0,'2019-05-10 04:39:37'),(98,146,1,234,0,'天呐',0,'2019-05-10 04:40:08'),(99,146,1,234,0,'试试',0,'2019-05-10 04:40:32'),(100,146,1,234,0,'???',0,'2019-05-10 04:42:07'),(101,146,1,234,0,'why',0,'2019-05-10 04:46:22'),(102,146,1,234,0,'怎么回事',0,'2019-05-10 04:47:23'),(103,146,1,234,0,'hello',0,'2019-05-10 04:55:07'),(104,146,1,274,0,'顶起',0,'2019-05-15 03:34:32'),(105,111,2,104,0,'顶你',0,'2019-05-15 03:34:51'),(106,146,2,104,111,'谢谢兄弟',0,'2019-05-15 03:35:14'),(107,111,2,104,146,'其实我也想要offer',0,'2019-05-15 03:35:40'),(108,112,1,274,0,'哈哈',0,'2019-05-15 03:40:50'),(109,112,1,274,0,'???',0,'2019-05-15 03:45:53'),(110,111,1,274,0,'why',0,'2019-05-15 03:55:00'),(111,111,1,274,0,'没事了',0,'2019-05-15 04:00:37'),(112,111,1,274,0,'好了',0,'2019-05-15 07:05:03'),(113,111,1,274,0,'ok',0,'2019-05-15 07:26:52'),(114,111,1,274,0,'hello',0,'2019-05-15 07:27:06'),(115,111,1,274,0,'world',0,'2019-05-15 07:27:16'),(116,111,1,274,0,'quartz',0,'2019-05-15 07:35:20'),(117,111,1,274,0,'好的',0,'2019-05-15 09:09:09'),(118,111,1,274,0,'为啥',0,'2019-05-15 09:10:35'),(119,111,1,274,0,'666',0,'2019-05-15 09:15:43'),(120,111,1,274,0,'777',0,'2019-05-15 09:53:15'),(121,111,1,274,0,'888',0,'2019-05-15 09:53:52'),(122,111,1,274,0,'999',0,'2019-05-15 09:55:08'),(123,111,1,274,0,'111',0,'2019-05-15 09:55:39'),(124,111,1,274,0,'222',0,'2019-05-15 09:57:02'),(125,111,1,274,0,'333',0,'2019-05-15 09:57:20'),(126,111,1,274,0,'444',0,'2019-05-15 09:57:26'),(127,111,1,274,0,'555',0,'2019-05-15 09:57:31'),(128,111,1,274,0,'666',0,'2019-05-15 10:00:19'),(129,111,1,274,0,'777',0,'2019-05-15 10:00:25'),(130,111,1,274,0,'888',0,'2019-05-15 10:00:31'),(131,111,1,274,0,'999',0,'2019-05-15 10:00:37'),(132,111,1,274,0,'111',0,'2019-05-15 10:00:43'),(133,111,1,274,0,'111',0,'2019-05-15 10:01:34'),(134,111,1,274,0,'222',0,'2019-05-15 10:01:39'),(135,111,1,274,0,'333',0,'2019-05-15 10:01:45'),(136,111,1,274,0,'444',0,'2019-05-15 10:01:50'),(137,111,1,274,0,'555',0,'2019-05-15 10:01:55'),(138,111,1,274,0,'555',0,'2019-05-15 10:02:29'),(139,111,1,274,0,'333',0,'2019-05-15 10:18:20'),(140,111,1,274,0,'444',0,'2019-05-15 10:18:26'),(141,111,1,274,0,'555',0,'2019-05-15 10:18:31'),(142,111,1,274,0,'666',0,'2019-05-15 10:18:40'),(143,111,1,274,0,'aaa',0,'2019-05-15 10:26:59'),(152,111,1,275,0,'好吧，你赢了！',0,'2019-05-16 11:06:58'),(153,111,1,275,0,'222',0,'2019-05-16 11:07:05'),(154,111,1,275,0,'222',0,'2019-05-16 11:07:05'),(155,111,1,275,0,'333',0,'2019-05-16 11:07:11'),(156,111,1,275,0,'555',0,'2019-05-16 11:07:15'),(157,111,1,275,0,'555',0,'2019-05-16 11:07:38'),(158,111,1,275,0,'222',0,'2019-05-16 11:12:18'),(159,111,1,275,0,'333',0,'2019-05-16 11:12:24'),(160,111,1,275,0,'444',0,'2019-05-16 11:12:29'),(161,111,1,275,0,'555',0,'2019-05-16 11:12:35'),(162,111,1,275,0,'666',0,'2019-05-16 11:12:39'),(163,111,1,275,0,'777',0,'2019-05-16 11:12:45'),(164,149,1,276,0,'自己顶！！！',0,'2019-05-17 07:50:39'),(165,111,1,276,0,'欢迎！',0,'2019-05-17 07:51:00'),(166,112,1,276,0,'欢迎！',0,'2019-05-17 07:51:22'),(167,149,2,165,0,'谢谢',0,'2019-05-17 07:51:53'),(168,149,2,166,0,'谢谢',0,'2019-05-17 07:52:01'),(169,149,1,276,0,'感谢各位！',0,'2019-05-17 07:52:14'),(170,113,1,276,0,'欢迎你！',0,'2019-05-17 07:52:35'),(171,114,1,276,0,'哈哈',0,'2019-05-17 07:53:01'),(172,111,1,277,0,'111',0,'2019-05-17 09:07:11'),(173,111,1,277,0,'222',0,'2019-05-17 09:07:15'),(174,111,1,277,0,'333',0,'2019-05-17 09:07:19'),(175,111,1,277,0,'444',0,'2019-05-17 09:07:22'),(176,111,1,277,0,'555',0,'2019-05-17 09:07:25'),(177,111,1,277,0,'666',0,'2019-05-17 09:07:29'),(178,111,1,277,0,'777',0,'2019-05-17 09:07:34'),(179,111,1,277,0,'888',0,'2019-05-17 09:07:38'),(180,111,1,277,0,'999',0,'2019-05-17 09:07:43'),(181,111,1,277,0,'000',0,'2019-05-17 09:07:48'),(182,111,1,277,0,'111',0,'2019-05-17 09:07:53'),(183,111,1,277,0,'aaa',0,'2019-05-17 09:19:01'),(184,111,1,277,0,'bbb',0,'2019-05-17 09:25:37'),(188,111,1,277,0,'ccc',0,'2019-05-17 09:49:58'),(189,111,1,277,0,'ddd',0,'2019-05-17 09:52:50'),(190,111,1,277,0,'eee',0,'2019-05-17 10:03:41'),(191,111,1,277,0,'fff',0,'2019-05-17 10:04:43'),(192,111,1,277,0,'ggg',0,'2019-05-17 10:05:05'),(195,111,1,277,0,'hhh',0,'2019-05-17 10:10:41'),(196,111,1,277,0,'iii',0,'2019-05-17 10:12:10'),(197,111,1,277,0,'kkk',0,'2019-05-17 10:12:32'),(199,111,1,277,0,'xxx',0,'2019-05-17 10:21:36'),(200,111,1,277,0,'yyy',0,'2019-05-17 10:21:56'),(201,111,1,277,0,'zzz',0,'2019-05-17 10:22:31'),(202,111,1,277,0,'mmm',0,'2019-05-17 10:23:11'),(203,111,1,277,0,'nnn',0,'2019-05-17 10:25:09'),(204,111,1,277,0,'ttt',0,'2019-05-17 10:26:00'),(205,111,1,277,0,'aaa',0,'2019-05-17 10:26:46'),(206,111,1,277,0,'ddd',0,'2019-05-17 10:28:35'),(207,111,1,277,0,'ggg',0,'2019-05-17 10:29:04'),(208,111,1,277,0,'hhh',0,'2019-05-17 10:29:38'),(209,111,1,277,0,'vvv',0,'2019-05-17 10:30:29'),(210,111,1,277,0,'asd',0,'2019-05-17 10:33:21'),(211,111,1,277,0,'bbb',0,'2019-05-17 10:34:21'),(212,111,1,277,0,'qqq',0,'2019-05-17 10:34:45'),(213,111,1,277,0,'sada',0,'2019-05-17 10:35:18'),(214,111,1,277,0,'111',0,'2019-05-17 10:38:40'),(215,111,1,277,0,'222',0,'2019-05-17 10:39:15'),(216,149,1,280,0,'111',0,'2019-05-20 09:41:58'),(217,149,1,280,0,'222',0,'2019-05-20 09:42:20'),(218,149,1,280,0,'333',0,'2019-05-20 09:42:35'),(219,149,1,280,0,'444',0,'2019-05-20 09:42:48'),(220,149,1,280,0,'555',0,'2019-05-20 09:43:01'),(221,149,1,280,0,'666',0,'2019-05-20 09:43:19'),(222,149,1,280,0,'777',0,'2019-05-20 09:43:32'),(223,149,1,280,0,'888',0,'2019-05-20 09:43:36'),(224,149,1,280,0,'999',0,'2019-05-20 09:43:40'),(225,149,1,280,0,'000',0,'2019-05-20 09:43:48'),(226,149,1,280,0,'111',0,'2019-05-20 09:43:55'),(227,149,1,280,0,'222',0,'2019-05-20 09:44:10'),(228,149,1,280,0,'333',0,'2019-05-20 09:44:13'),(229,149,1,280,0,'444',0,'2019-05-20 09:44:16'),(230,149,1,280,0,'555',0,'2019-05-20 09:44:19'),(231,149,1,280,0,'666',0,'2019-05-20 09:44:25');
/*!40000 ALTER TABLE `comment` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Dumping data for table `discuss_post`
--

LOCK TABLES `discuss_post` WRITE;
/*!40000 ALTER TABLE `discuss_post` DISABLE KEYS */;
INSERT INTO `discuss_post` VALUES (109,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(110,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(111,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(112,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(113,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(114,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(115,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(116,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(117,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(118,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(119,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(120,'101','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(121,'102','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(122,'102','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(123,'102','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(124,'102','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(125,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(126,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(127,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(128,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(129,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(130,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(131,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(132,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(133,'103','因特网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(134,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(135,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(136,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(137,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(138,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(139,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(140,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(141,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(142,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(143,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(144,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(145,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(146,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(147,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(148,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(149,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(150,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(151,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(152,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(153,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(154,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(155,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(156,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(157,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(158,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(159,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(160,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(161,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(162,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(163,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(164,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(165,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(166,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(167,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(168,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(169,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(170,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(171,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(172,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(173,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(174,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(175,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(176,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:36',0,0),(177,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(178,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(179,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(180,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(181,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(182,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(183,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(184,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(185,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(186,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(187,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(188,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(189,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(190,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(191,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(192,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(193,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(194,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(195,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(196,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(197,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(198,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(199,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(200,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(201,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(202,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(203,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(204,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(205,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(206,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(207,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(208,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(209,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(210,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“寒冬”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(211,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(212,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(213,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(214,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(215,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(216,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(217,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的“哀嚎”与“悲惨遭遇”牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过“艰难”，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&19届，拯救0 offer！',0,0,'2019-04-04 03:53:37',0,0),(218,'111','haha','hahahaha',0,0,'2019-04-04 09:10:38',0,0),(219,'111','hehe','hehe',0,0,'2019-04-04 09:12:47',0,0),(220,'111','heihei','heihei',0,0,'2019-04-04 09:16:10',0,0),(221,'111','ddd','ddd',0,0,'2019-04-04 09:17:24',0,0),(222,'111','www','www',0,0,'2019-04-04 09:18:20',0,0),(223,'111','qqq','qqq',0,0,'2019-04-04 09:19:44',0,0),(224,'111','ggg','ggg',0,0,'2019-04-04 09:20:16',0,0),(225,'111','kkk','kkk',0,0,'2019-04-04 09:20:37',0,0),(226,'111','&lt;script&gt;alert(1);&lt;/script&gt;','&lt;script&gt;alert(1);&lt;/script&gt;',0,0,'2019-04-04 09:21:04',0,0),(227,'111','哈哈','***, ***, 快来呀!',0,2,'2019-04-04 09:21:42',0,0),(228,'111','ccc','ccc',0,0,'2019-04-04 09:37:38',9,0),(229,'112','lala','lalalalala',0,0,'2019-04-05 14:33:00',1,1709.0791812460477),(230,'131','新人报道','新人报道,请多关照!',0,0,'2019-04-08 04:09:17',0,0),(231,'132','灌水','新人灌水',0,0,'2019-04-08 06:08:11',1,0),(232,'132','发一个','发一个帖子, 哈哈!',0,1,'2019-04-08 07:57:57',7,1713.167317334748),(233,'111','Hello','Hello World',0,0,'2019-04-10 03:10:00',15,1715.2741578492637),(234,'111','玄学帖','据说玄学贴很灵验，求大佬捞捞我这个菜鸡给个机会！',1,0,'2019-04-13 09:54:04',13,1718.1335389083702),(235,'111','揭秘时尚科技的力量','它是最时尚的互联网公司之一，\n致力于帮助人们发现流行趋势；\n它是专注于科技的电商企业，\n力图让人们享受更优质的购物体验。',0,1,'2019-04-13 10:24:41',1,0),(236,'111','测试1','测试1',0,0,'2019-04-13 10:33:39',2,0),(237,'111','测试2','测试2',0,0,'2019-04-13 14:20:31',7,1717.9242792860618),(238,'111','中国','中华人民共和国',0,0,'2019-04-16 13:50:33',0,0),(239,'111','美国','美利坚合众国',0,0,'2019-04-16 13:50:44',0,0),(240,'111','日本','大日本帝国',0,0,'2019-04-16 13:51:01',0,0),(241,'111','华人','我爱中华人民共和国',0,0,'2019-04-16 14:22:19',0,0),(242,'111','爱国','我叫王爱国, 我爱中华人民共和国!',0,0,'2019-04-16 14:22:38',0,0),(243,'111','因特网哈哈','好啊',0,0,'2019-04-17 03:58:43',0,0),(244,'111','哎呀','好艰难啊好艰难!',0,0,'2019-04-17 03:59:00',0,0),(245,'111','Spring Boot整合Elasticsearch','Elasticsearch是一款分布式搜索引擎框架',0,0,'2019-04-17 08:27:58',1,0),(246,'133','Good','Good Morning',0,0,'2019-04-19 03:37:23',3,1723.5314789170423),(247,'133','haha','haha',0,0,'2019-04-19 09:25:27',0,0),(248,'134','lhh','aaa',0,0,'2019-04-19 10:15:25',0,0),(249,'134','&lt;script&gt;alert(1);&lt;/script&gt;','&lt;script&gt;alert(1);&lt;/script&gt;',0,0,'2019-04-19 10:16:02',1,0),(265,'103','互联网求职暖春计划','今年的就业形势，确实不容乐观。过了个年，仿佛跳水一般，整个讨论区哀鸿遍野！19届真的没人要了吗？！18届被优化真的没有出路了吗？！大家的&ldquo;哀嚎&rdquo;与&ldquo;悲惨遭遇&rdquo;牵动了每日潜伏于讨论区的牛客小哥哥小姐姐们的心，于是牛客决定：是时候为大家做点什么了！为了帮助大家度过&ldquo;寒冬&rdquo;，牛客网特别联合60+家企业，开启互联网求职暖春计划，面向18届&amp;19届，拯救0 offer！',0,0,'2019-04-25 02:14:05',0,0),(270,'138','xxx','xxx',0,0,'2019-04-25 06:45:18',6,1729.7923916894983),(271,'138','public','public static void main',0,0,'2019-04-25 07:22:16',2,1729.3802112417115),(272,'111','天涯','天呀',0,2,'2019-04-26 07:42:31',2,1730.3802112417115),(273,'145','哈哈','哈哈哈哈',0,0,'2019-04-28 07:32:45',2,1732.3802112417115),(274,'146','我要offer','跪求offer~~~',0,1,'2019-05-15 03:34:14',37,1750.6522463410033),(275,'11','我是管理员','我是管理员，你们都老实点！',1,1,'2019-05-16 10:58:44',12,1751.2900346113624),(276,'149','新人报道','新人报道，请多关照！',0,0,'2019-05-17 07:50:18',6,1751.806179973984),(277,'149','Spring Cache','Spring Cache RedisCacheManager',0,0,'2019-05-17 09:06:54',38,1752.5797835966168),(280,'149','事务','事务的4个特性，包括原子性、一致性、隔离性、持久性。',0,0,'2019-05-20 09:41:30',16,1755.2095150145426);
/*!40000 ALTER TABLE `discuss_post` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Dumping data for table `message`
--

LOCK TABLES `message` WRITE;
/*!40000 ALTER TABLE `message` DISABLE KEYS */;
INSERT INTO `message` VALUES (1,112,111,'111_112','你好',1,'2019-04-05 14:49:15'),(2,112,111,'111_112','在吗',1,'2019-04-06 13:34:29'),(3,112,111,'111_112','说话',1,'2019-04-06 13:34:29'),(4,112,111,'111_112','人呢',1,'2019-04-06 13:34:29'),(5,113,111,'111_113','Hello',1,'2019-04-06 13:35:02'),(6,113,111,'111_113','How are you?',1,'2019-04-06 13:35:02'),(7,113,111,'111_113','Are you ok?',1,'2019-04-06 13:35:02'),(8,114,111,'111_114','哈哈',1,'2019-04-06 13:35:24'),(9,114,111,'111_114','呵呵',1,'2019-04-06 13:35:24'),(10,114,111,'111_114','嘿嘿',1,'2019-04-06 13:35:24'),(11,115,111,'111_115','good',1,'2019-04-06 13:36:26'),(12,115,111,'111_115','yes',1,'2019-04-06 13:36:26'),(13,115,111,'111_115','perfect',1,'2019-04-06 13:36:26'),(14,115,111,'111_115','ah',1,'2019-04-06 13:36:26'),(15,116,111,'111_116','哎呀',1,'2019-04-06 13:36:54'),(16,116,111,'111_116','我发错了',1,'2019-04-06 13:36:54'),(17,117,111,'111_117','喂',1,'2019-04-06 13:37:17'),(18,118,111,'111_118','HI',1,'2019-04-06 13:59:16'),(19,118,111,'111_118','Hello',1,'2019-04-06 13:59:16'),(20,119,111,'111_119','AAA',1,'2019-04-06 14:00:16'),(21,119,111,'111_119','BBB',1,'2019-04-06 14:00:16'),(22,119,111,'111_119','CCC',1,'2019-04-06 14:00:16'),(23,112,111,'111_112','哥们',1,'2019-04-06 14:04:05'),(24,112,111,'111_112','出来',2,'2019-04-06 14:04:05'),(25,112,111,'111_112','商量点事',1,'2019-04-06 14:04:05'),(26,111,112,'111_112','干啥',2,'2019-04-06 15:22:07'),(27,111,112,'111_112','忙呢',2,'2019-04-06 15:22:07'),(28,111,112,'111_112','来呀',1,'2019-04-06 15:29:56'),(29,131,111,'111_131','你好',1,'2019-04-08 04:24:10'),(30,131,111,'111_131','haha',1,'2019-04-08 04:43:22'),(31,111,131,'111_131','hehe',1,'2019-04-08 04:50:56'),(32,131,111,'111_131','yeah',1,'2019-04-08 04:57:16'),(33,131,111,'111_131','aaa',1,'2019-04-08 04:58:03'),(34,111,131,'111_131','ttt',1,'2019-04-08 04:58:16'),(35,132,111,'111_132','为啥不让我灌水',1,'2019-04-08 06:08:55'),(36,111,132,'111_132','就是不让灌水',1,'2019-04-08 06:22:55'),(37,111,132,'111_132','以后注意啊',2,'2019-04-08 06:29:01'),(38,111,131,'111_131','啦啦啦',2,'2019-04-13 02:20:50'),(39,111,131,'111_131','嘎嘎嘎',0,'2019-04-13 02:21:03'),(92,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":112}',1,'2019-04-13 14:20:58'),(93,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":112}',1,'2019-04-13 14:21:04'),(94,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":112}',1,'2019-04-13 14:21:08'),(95,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":113}',1,'2019-04-13 14:22:58'),(96,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":113}',1,'2019-04-13 14:23:01'),(97,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":113}',1,'2019-04-13 14:23:04'),(98,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":114}',1,'2019-04-13 14:23:26'),(99,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":114}',1,'2019-04-13 14:23:34'),(100,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":114}',1,'2019-04-13 14:23:37'),(101,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":115}',1,'2019-04-13 14:23:57'),(102,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":115}',1,'2019-04-13 14:24:00'),(103,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":115}',2,'2019-04-13 14:24:02'),(104,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":116}',1,'2019-04-13 14:24:24'),(105,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":116}',1,'2019-04-13 14:24:28'),(106,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":116}',1,'2019-04-13 14:24:30'),(107,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":117}',1,'2019-04-13 14:24:52'),(108,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":117}',1,'2019-04-13 14:24:56'),(109,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":117}',1,'2019-04-13 14:24:59'),(110,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":118}',1,'2019-04-13 14:25:15'),(111,1,111,'comment','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":118}',1,'2019-04-13 14:25:33'),(112,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":118}',1,'2019-04-13 14:25:43'),(113,1,1,'follow','{\"entityType\":3,\"entityId\":1,\"userId\":133}',0,'2019-04-19 03:09:32'),(114,1,111,'comment','{\"entityType\":1,\"entityId\":245,\"postId\":245,\"userId\":133}',1,'2019-04-19 03:09:41'),(115,1,133,'comment','{\"entityType\":2,\"entityId\":55,\"postId\":245,\"userId\":133}',1,'2019-04-19 03:09:46'),(116,1,133,'comment','{\"entityType\":2,\"entityId\":55,\"postId\":245,\"userId\":133}',1,'2019-04-19 03:09:53'),(117,1,133,'like','{\"entityType\":1,\"entityId\":246,\"postId\":246,\"userId\":133}',1,'2019-04-19 03:37:28'),(118,1,133,'comment','{\"entityType\":1,\"entityId\":246,\"postId\":246,\"userId\":133}',1,'2019-04-19 03:37:34'),(119,111,131,'111_131','aaa',0,'2019-04-19 09:21:24'),(120,1,133,'like','{\"entityType\":1,\"entityId\":246,\"postId\":246,\"userId\":111}',0,'2019-04-19 09:21:45'),(121,1,133,'comment','{\"entityType\":1,\"entityId\":246,\"postId\":246,\"userId\":111}',0,'2019-04-19 09:21:50'),(122,1,134,'like','{\"entityType\":1,\"entityId\":249,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:16:48'),(123,1,134,'like','{\"entityType\":1,\"entityId\":249,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:16:50'),(124,1,134,'like','{\"entityType\":1,\"entityId\":249,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:16:52'),(125,1,134,'comment','{\"entityType\":1,\"entityId\":249,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:16:57'),(126,1,134,'like','{\"entityType\":2,\"entityId\":60,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:17:00'),(127,1,134,'comment','{\"entityType\":2,\"entityId\":60,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:17:04'),(128,1,134,'comment','{\"entityType\":2,\"entityId\":60,\"postId\":249,\"userId\":134}',1,'2019-04-19 10:17:09'),(129,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":134}',1,'2019-04-19 10:17:44'),(130,134,111,'111_134','hello',1,'2019-04-19 10:19:04'),(131,111,134,'111_134','nihao',0,'2019-04-19 10:19:30'),(132,1,111,'comment','{\"entityType\":1,\"entityId\":233,\"postId\":233,\"userId\":111}',1,'2019-04-23 04:34:03'),(133,1,133,'like','{\"entityType\":1,\"entityId\":246,\"postId\":246,\"userId\":111}',0,'2019-04-23 07:30:38'),(134,1,133,'comment','{\"entityType\":1,\"entityId\":246,\"postId\":246,\"userId\":111}',0,'2019-04-23 07:30:47'),(135,1,111,'like','{\"entityType\":1,\"entityId\":237,\"postId\":237,\"userId\":111}',1,'2019-04-23 07:31:00'),(136,1,111,'like','{\"entityType\":1,\"entityId\":233,\"postId\":233,\"userId\":111}',1,'2019-04-23 07:31:07'),(137,1,111,'comment','{\"entityType\":1,\"entityId\":233,\"postId\":233,\"userId\":111}',1,'2019-04-23 07:31:13'),(138,1,132,'like','{\"entityType\":1,\"entityId\":232,\"postId\":232,\"userId\":111}',0,'2019-04-23 07:33:12'),(139,1,112,'like','{\"entityType\":1,\"entityId\":229,\"postId\":229,\"userId\":111}',0,'2019-04-23 07:33:56'),(140,1,138,'comment','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:09'),(141,1,138,'comment','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:13'),(142,1,138,'comment','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:16'),(143,1,138,'comment','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:25'),(144,1,138,'comment','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:28'),(145,1,138,'comment','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:31'),(146,1,138,'comment','{\"entityType\":2,\"entityId\":66,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:43'),(147,1,138,'comment','{\"entityType\":2,\"entityId\":66,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:48'),(148,1,138,'comment','{\"entityType\":2,\"entityId\":66,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:46:57'),(149,1,138,'comment','{\"entityType\":2,\"entityId\":66,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:06'),(150,1,138,'like','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:21'),(151,1,138,'like','{\"entityType\":1,\"entityId\":270,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:25'),(152,1,138,'like','{\"entityType\":2,\"entityId\":66,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:27'),(153,1,138,'like','{\"entityType\":2,\"entityId\":72,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:30'),(154,1,138,'like','{\"entityType\":2,\"entityId\":73,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:30'),(155,1,138,'like','{\"entityType\":2,\"entityId\":74,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:31'),(156,1,138,'like','{\"entityType\":2,\"entityId\":75,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:32'),(157,1,138,'like','{\"entityType\":2,\"entityId\":67,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:33'),(158,1,138,'like','{\"entityType\":2,\"entityId\":68,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:34'),(159,1,138,'like','{\"entityType\":2,\"entityId\":69,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:36'),(160,1,138,'like','{\"entityType\":2,\"entityId\":70,\"postId\":270,\"userId\":138}',1,'2019-04-25 06:47:37'),(161,138,111,'111_138','hello',1,'2019-04-25 07:10:45'),(162,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":138}',1,'2019-04-25 07:10:57'),(163,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":138}',1,'2019-04-25 07:10:59'),(164,138,111,'111_138','heihei',1,'2019-04-25 07:12:48'),(165,138,111,'111_138','lala',1,'2019-04-25 07:12:58'),(166,1,138,'like','{\"entityType\":1,\"entityId\":271,\"postId\":271,\"userId\":138}',1,'2019-04-25 07:22:22'),(167,1,138,'comment','{\"entityType\":1,\"entityId\":271,\"postId\":271,\"userId\":138}',1,'2019-04-25 07:22:28'),(168,1,138,'comment','{\"entityType\":1,\"entityId\":271,\"postId\":271,\"userId\":138}',1,'2019-04-25 07:22:33'),(169,1,138,'comment','{\"entityType\":2,\"entityId\":77,\"postId\":271,\"userId\":138}',1,'2019-04-25 07:22:43'),(170,1,138,'like','{\"entityType\":2,\"entityId\":78,\"postId\":271,\"userId\":138}',1,'2019-04-25 07:22:46'),(171,1,138,'comment','{\"entityType\":2,\"entityId\":77,\"postId\":271,\"userId\":138}',1,'2019-04-25 07:22:50'),(172,138,111,'111_138','Hello aaa',1,'2019-04-25 07:23:27'),(173,138,111,'111_138','???',1,'2019-04-25 07:23:40'),(174,1,111,'like','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":111}',1,'2019-04-26 06:15:14'),(175,1,111,'like','{\"entityType\":2,\"entityId\":29,\"postId\":233,\"userId\":111}',1,'2019-04-26 07:17:54'),(176,1,112,'like','{\"entityType\":2,\"entityId\":30,\"postId\":233,\"userId\":111}',0,'2019-04-26 07:17:55'),(177,1,111,'like','{\"entityType\":2,\"entityId\":29,\"postId\":233,\"userId\":111}',1,'2019-04-26 07:17:57'),(178,1,112,'like','{\"entityType\":2,\"entityId\":30,\"postId\":233,\"userId\":111}',0,'2019-04-26 07:17:58'),(179,1,112,'like','{\"entityType\":2,\"entityId\":28,\"postId\":233,\"userId\":111}',0,'2019-04-26 07:17:58'),(180,1,111,'like','{\"entityType\":1,\"entityId\":272,\"postId\":272,\"userId\":111}',1,'2019-04-26 07:42:48'),(181,1,111,'comment','{\"entityType\":1,\"entityId\":272,\"postId\":272,\"userId\":111}',1,'2019-04-26 07:42:54'),(182,1,111,'comment','{\"entityType\":2,\"entityId\":80,\"postId\":272,\"userId\":111}',1,'2019-04-26 07:43:26'),(183,1,111,'comment','{\"entityType\":2,\"entityId\":80,\"postId\":272,\"userId\":111}',1,'2019-04-26 07:43:33'),(184,1,111,'comment','{\"entityType\":2,\"entityId\":80,\"postId\":272,\"userId\":111}',1,'2019-04-26 07:43:40'),(185,1,138,'follow','{\"entityType\":3,\"entityId\":138,\"userId\":111}',0,'2019-04-26 11:46:08'),(186,1,138,'follow','{\"entityType\":3,\"entityId\":138,\"userId\":111}',0,'2019-04-26 11:46:09'),(187,1,138,'like','{\"entityType\":1,\"entityId\":271,\"postId\":271,\"userId\":111}',0,'2019-04-26 11:46:17'),(188,1,138,'like','{\"entityType\":2,\"entityId\":77,\"postId\":271,\"userId\":111}',0,'2019-04-26 11:46:19'),(189,1,138,'like','{\"entityType\":2,\"entityId\":79,\"postId\":271,\"userId\":111}',0,'2019-04-26 11:46:21'),(190,1,138,'like','{\"entityType\":2,\"entityId\":78,\"postId\":271,\"userId\":111}',0,'2019-04-26 11:46:22'),(191,111,111,'111_111','cc',1,'2019-04-28 02:16:08'),(192,1,145,'like','{\"entityType\":1,\"entityId\":273,\"postId\":273,\"userId\":145}',1,'2019-04-28 07:32:57'),(193,1,145,'comment','{\"entityType\":1,\"entityId\":273,\"postId\":273,\"userId\":145}',1,'2019-04-28 07:33:03'),(194,1,145,'like','{\"entityType\":2,\"entityId\":84,\"postId\":273,\"userId\":145}',1,'2019-04-28 07:33:05'),(195,1,145,'comment','{\"entityType\":2,\"entityId\":84,\"postId\":273,\"userId\":145}',1,'2019-04-28 07:33:12'),(196,1,145,'comment','{\"entityType\":2,\"entityId\":84,\"postId\":273,\"userId\":145}',1,'2019-04-28 07:33:16'),(197,1,111,'follow','{\"entityType\":3,\"entityId\":111,\"userId\":145}',1,'2019-04-28 07:33:40'),(198,1,145,'follow','{\"entityType\":3,\"entityId\":145,\"userId\":111}',1,'2019-04-28 07:33:52'),(199,111,145,'111_145','你好',1,'2019-04-28 07:34:18'),(200,1,111,'like','{\"entityType\":1,\"entityId\":272,\"postId\":272,\"userId\":145}',1,'2019-04-28 08:11:42'),(201,1,111,'like','{\"entityType\":1,\"entityId\":272,\"postId\":272,\"userId\":145}',1,'2019-04-28 08:12:40'),(202,1,145,'like','{\"entityType\":1,\"entityId\":273,\"postId\":273,\"userId\":111}',1,'2019-04-28 10:56:03'),(203,1,145,'comment','{\"entityType\":1,\"entityId\":273,\"postId\":273,\"userId\":111}',1,'2019-04-28 10:56:14'),(204,1,145,'follow','{\"entityType\":3,\"entityId\":145,\"userId\":111}',1,'2019-04-28 10:56:18'),(205,1,111,'comment','{\"entityType\":1,\"entityId\":272,\"postId\":272,\"userId\":145}',0,'2019-05-06 03:37:28'),(206,145,111,'111_145','hello',0,'2019-05-06 03:37:39'),(207,111,112,'111_112','bbb',0,'2019-05-08 08:56:46'),(208,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 02:35:01'),(209,1,112,'comment','{\"entityType\":2,\"entityId\":43,\"postId\":234,\"userId\":146}',0,'2019-05-10 02:35:09'),(210,1,112,'comment','{\"entityType\":2,\"entityId\":43,\"postId\":234,\"userId\":112}',0,'2019-05-10 02:35:29'),(211,1,112,'like','{\"entityType\":2,\"entityId\":43,\"postId\":234,\"userId\":113}',0,'2019-05-10 02:36:00'),(212,1,146,'like','{\"entityType\":2,\"entityId\":89,\"postId\":234,\"userId\":113}',0,'2019-05-10 02:36:02'),(213,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":113}',0,'2019-05-10 02:36:06'),(214,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:25'),(215,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:41'),(216,1,112,'like','{\"entityType\":2,\"entityId\":43,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:44'),(217,1,111,'like','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:44'),(218,1,146,'like','{\"entityType\":2,\"entityId\":89,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:47'),(219,1,113,'like','{\"entityType\":2,\"entityId\":92,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:48'),(220,1,114,'like','{\"entityType\":2,\"entityId\":93,\"postId\":234,\"userId\":114}',0,'2019-05-10 02:36:50'),(221,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":115}',0,'2019-05-10 02:37:16'),(222,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:39:16'),(223,1,146,'comment','{\"entityType\":2,\"entityId\":96,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:39:37'),(224,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:40:08'),(225,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:40:55'),(226,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:42:53'),(227,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:46:50'),(228,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:46:50'),(229,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:47:29'),(230,1,111,'comment','{\"entityType\":1,\"entityId\":234,\"postId\":234,\"userId\":146}',0,'2019-05-10 04:55:34'),(231,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":146}',0,'2019-05-15 03:34:32'),(232,1,146,'like','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 03:34:46'),(233,1,146,'like','{\"entityType\":2,\"entityId\":104,\"postId\":274,\"userId\":111}',0,'2019-05-15 03:34:47'),(234,1,146,'comment','{\"entityType\":2,\"entityId\":104,\"postId\":274,\"userId\":111}',0,'2019-05-15 03:34:51'),(235,1,146,'comment','{\"entityType\":2,\"entityId\":104,\"postId\":274,\"userId\":146}',0,'2019-05-15 03:35:14'),(236,1,111,'like','{\"entityType\":2,\"entityId\":105,\"postId\":274,\"userId\":146}',0,'2019-05-15 03:35:16'),(237,1,146,'comment','{\"entityType\":2,\"entityId\":104,\"postId\":274,\"userId\":111}',0,'2019-05-15 03:35:40'),(238,1,146,'like','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":112}',0,'2019-05-15 03:40:46'),(239,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":112}',0,'2019-05-15 03:40:50'),(240,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":112}',0,'2019-05-15 03:45:53'),(241,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 03:55:07'),(242,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 03:55:16'),(243,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 04:00:37'),(244,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 07:05:03'),(245,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 07:26:53'),(246,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 07:27:06'),(247,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 07:27:16'),(248,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 07:35:20'),(249,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:09:09'),(250,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:10:35'),(251,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:15:44'),(252,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:53:26'),(253,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:53:54'),(254,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:55:08'),(255,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:55:39'),(256,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:57:02'),(257,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:57:20'),(258,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:57:26'),(259,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 09:57:31'),(260,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:00:19'),(261,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:00:25'),(262,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:00:31'),(263,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:00:37'),(264,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:00:43'),(265,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:01:34'),(266,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:01:39'),(267,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:01:45'),(268,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:01:50'),(269,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:01:55'),(270,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:02:29'),(271,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:18:20'),(272,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:18:26'),(273,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:18:31'),(274,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:18:40'),(275,1,146,'comment','{\"entityType\":1,\"entityId\":274,\"postId\":274,\"userId\":111}',0,'2019-05-15 10:26:59'),(276,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:06:59'),(277,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:07:05'),(278,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:07:06'),(279,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:07:11'),(280,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:07:15'),(281,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:07:38'),(282,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:12:18'),(283,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:12:24'),(284,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:12:29'),(285,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:12:35'),(286,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:12:39'),(287,1,11,'comment','{\"entityType\":1,\"entityId\":275,\"postId\":275,\"userId\":111}',0,'2019-05-16 11:12:45'),(288,1,149,'like','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":149}',1,'2019-05-17 07:50:30'),(289,1,149,'comment','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":149}',0,'2019-05-17 07:50:39'),(290,1,149,'comment','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":111}',1,'2019-05-17 07:51:00'),(291,1,149,'like','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":111}',1,'2019-05-17 07:51:02'),(292,1,149,'comment','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":112}',1,'2019-05-17 07:51:22'),(293,1,111,'like','{\"entityType\":2,\"entityId\":165,\"postId\":276,\"userId\":149}',0,'2019-05-17 07:51:40'),(294,1,112,'like','{\"entityType\":2,\"entityId\":166,\"postId\":276,\"userId\":149}',0,'2019-05-17 07:51:41'),(295,1,111,'comment','{\"entityType\":2,\"entityId\":165,\"postId\":276,\"userId\":149}',0,'2019-05-17 07:51:53'),(296,1,112,'comment','{\"entityType\":2,\"entityId\":166,\"postId\":276,\"userId\":149}',0,'2019-05-17 07:52:01'),(297,1,149,'comment','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":149}',1,'2019-05-17 07:52:14'),(298,1,149,'comment','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":113}',1,'2019-05-17 07:52:35'),(299,1,149,'comment','{\"entityType\":1,\"entityId\":276,\"postId\":276,\"userId\":114}',1,'2019-05-17 07:53:01'),(300,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:11'),(301,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:15'),(302,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:19'),(303,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:22'),(304,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:25'),(305,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:29'),(306,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:34'),(307,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:38'),(308,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:43'),(309,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:48'),(310,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:07:53'),(311,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:19:54'),(312,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:26:29'),(313,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:49:58'),(314,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 09:52:51'),(315,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:03:41'),(316,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:04:43'),(317,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:05:05'),(318,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:10:42'),(319,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:12:10'),(320,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:12:32'),(321,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:21:36'),(322,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:21:56'),(323,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:22:40'),(324,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:24:19'),(325,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:26:04'),(326,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:26:04'),(327,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:26:54'),(328,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:28:58'),(329,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:29:49'),(330,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:30:02'),(331,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:31:51'),(332,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:31:54'),(333,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:33:25'),(334,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:34:21'),(335,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:34:49'),(336,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:38:40'),(337,1,149,'comment','{\"entityType\":1,\"entityId\":277,\"postId\":277,\"userId\":111}',0,'2019-05-17 10:39:19'),(338,1,149,'like','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:41:37'),(339,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:41:58'),(340,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:42:20'),(341,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:42:35'),(342,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:42:48'),(343,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:01'),(344,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:19'),(345,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:32'),(346,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:36'),(347,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:40'),(348,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:48'),(349,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:43:55'),(350,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:44:10'),(351,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:44:13'),(352,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:44:16'),(353,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:44:19'),(354,1,149,'comment','{\"entityType\":1,\"entityId\":280,\"postId\":280,\"userId\":149}',0,'2019-05-20 09:44:25');
/*!40000 ALTER TABLE `message` ENABLE KEYS */;
UNLOCK TABLES;

--
-- Dumping data for table `user`
--

LOCK TABLES `user` WRITE;
/*!40000 ALTER TABLE `user` DISABLE KEYS */;
INSERT INTO `user` VALUES (1,'SYSTEM','SYSTEM','SYSTEM','nowcoder1@sina.com',0,1,NULL,'http://static.nowcoder.com/images/head/notify.png','2019-04-13 02:11:03'),(11,'nowcoder11','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder11@sina.com',1,1,NULL,'http://images.nowcoder.com/head/11t.png','2019-04-17 09:11:27'),(12,'nowcoder12','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder12@sina.com',1,1,NULL,'http://images.nowcoder.com/head/12t.png','2019-04-17 09:11:28'),(13,'nowcoder13','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder13@sina.com',1,1,NULL,'http://images.nowcoder.com/head/13t.png','2019-04-17 09:11:28'),(21,'nowcoder21','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder21@sina.com',2,1,NULL,'http://images.nowcoder.com/head/21t.png','2019-04-17 09:11:28'),(22,'nowcoder22','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder22@sina.com',2,1,NULL,'http://images.nowcoder.com/head/22t.png','2019-04-17 09:11:28'),(23,'nowcoder23','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder23@sina.com',2,1,NULL,'http://images.nowcoder.com/head/23t.png','2019-04-17 09:11:28'),(24,'nowcoder24','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder24@sina.com',2,1,NULL,'http://images.nowcoder.com/head/24t.png','2019-04-17 09:11:28'),(25,'nowcoder25','25ac0a2e8bd0f28928de3c56149283d6','49f10','nowcoder25@sina.com',2,1,NULL,'http://images.nowcoder.com/head/25t.png','2019-04-17 09:11:28'),(101,'liubei','390ba5f6b5f18dd4c63d7cda170a0c74','12345','nowcoder101@sina.com',0,1,NULL,'http://images.nowcoder.com/head/100t.png','2019-04-03 04:04:55'),(102,'guanyu','390ba5f6b5f18dd4c63d7cda170a0c74','12345','nowcoder102@sina.com',0,1,NULL,'http://images.nowcoder.com/head/200t.png','2019-04-03 04:04:55'),(103,'zhangfei','390ba5f6b5f18dd4c63d7cda170a0c74','12345','nowcoder103@sina.com',0,1,NULL,'http://images.nowcoder.com/head/100t.png','2019-04-03 04:04:55'),(111,'aaa','b8ca3cbc6fd57c78736c66611a7e7044','167f9','nowcoder111@sina.com',0,1,NULL,'http://images.nowcoder.com/head/111t.png','2019-04-03 07:31:19'),(112,'bbb','216dc48902665b6a6dba534717d49592','90ad0','nowcoder112@sina.com',0,1,NULL,'http://images.nowcoder.com/head/112t.png','2019-04-04 10:36:24'),(113,'ccc','511247cf6bf9cf3d37aef555d0dd9b75','fe290','nowcoder113@sina.com',0,1,NULL,'http://images.nowcoder.com/head/705t.png','2019-04-06 13:29:52'),(114,'ddd','d432b1aaec9197cb6e23ed8e335fe42f','fd1b1','nowcoder114@sina.com',0,1,NULL,'http://images.nowcoder.com/head/972t.png','2019-04-06 13:30:36'),(115,'eee','caca1fe634005d505afd82ef7874fc4f','0c8d2','nowcoder115@sina.com',0,1,NULL,'http://images.nowcoder.com/head/316t.png','2019-04-06 13:30:48'),(116,'fff','deda51913a3ae16d9915fc4c520ac4b6','19341','nowcoder116@sina.com',0,1,NULL,'http://images.nowcoder.com/head/180t.png','2019-04-06 13:31:00'),(117,'ggg','4e85bff4afbb34b2dd676f5e5737050f','9931d','nowcoder117@sina.com',0,1,NULL,'http://images.nowcoder.com/head/896t.png','2019-04-06 13:31:19'),(118,'hhh','8d4c0d490ea1585cd7973bb55bd39d07','e123d','nowcoder118@sina.com',0,1,NULL,'http://images.nowcoder.com/head/834t.png','2019-04-06 13:38:18'),(119,'iii','2214de584a27c7c28dd46a9505bfdc8b','f8880','nowcoder119@sina.com',0,1,NULL,'http://images.nowcoder.com/head/240t.png','2019-04-06 13:38:33'),(120,'jjj','9522866891d647323a7fb5c640b8fa37','12c25','nowcoder120@sina.com',0,1,NULL,'http://images.nowcoder.com/head/760t.png','2019-04-06 13:39:45'),(121,'kkk','5a80e7d897dec9b0aec2919fb42a158e','b8710','nowcoder121@sina.com',0,1,NULL,'http://images.nowcoder.com/head/358t.png','2019-04-06 13:41:34'),(122,'lll','fdc3616df634614bc0ffacee17f735bd','b067f','nowcoder122@sina.com',0,1,NULL,'http://images.nowcoder.com/head/70t.png','2019-04-06 13:45:36'),(123,'mmm','d9b57ddfa9faa06c581c803dc2811edb','f7014','nowcoder123@sina.com',0,1,NULL,'http://images.nowcoder.com/head/160t.png','2019-04-06 13:48:34'),(124,'nnn','f878b7181a95a3330d90198deab16aca','bbf47','nowcoder124@sina.com',0,1,NULL,'http://images.nowcoder.com/head/506t.png','2019-04-06 13:49:39'),(125,'ooo','f71e07cc9c6ebb9e8cfc1fc58265ff33','ff72a','nowcoder125@sina.com',0,1,NULL,'http://images.nowcoder.com/head/45t.png','2019-04-06 13:50:35'),(126,'ppp','e2f178c5076dabbb35b73da19774b271','5027b','nowcoder126.sina.com',0,1,NULL,'http://images.nowcoder.com/head/771t.png','2019-04-06 13:51:42'),(127,'qqq','d209b28b19fdcb4aafc3a795157a4651','3aebf','nowcoder127@sina.com',0,1,NULL,'http://images.nowcoder.com/head/492t.png','2019-04-06 13:52:29'),(128,'rrr','a6043995e741593540687d87c1ce40e8','c543c','nowcoder128@sina.com',0,1,NULL,'http://images.nowcoder.com/head/779t.png','2019-04-06 13:53:19'),(129,'sss','ae8754f0d791f9fea1627a1862c4de5f','d3641','nowcoder129@sina.com',0,1,NULL,'http://images.nowcoder.com/head/977t.png','2019-04-06 13:57:34'),(131,'ttt','d50960f067142c59cc3bdac61b87759f','72450','nowcoder131@sina.com',0,1,NULL,'http://images.nowcoder.com/head/677t.png','2019-04-08 04:05:49'),(132,'uuu','a80ba77157d2fd9c67dd3187907cef42','f1113','nowcoder132@sina.com',0,1,NULL,'http://images.nowcoder.com/head/278t.png','2019-04-08 06:07:04'),(133,'vvv','252c226ba0a601ec3fa4d7c58b2291d9','13211','nowcoder133@sina.com',0,1,NULL,'http://images.nowcoder.com/head/133t.png','2019-04-19 03:08:55'),(134,'www','3d3aeebb9cd302ae581dfa8fedd86ceb','dfc00','nowcoder134@sina.com',0,1,NULL,'http://images.nowcoder.com/head/134t.png','2019-04-19 10:13:57'),(137,'xxx','046291c11cdfb896aa7cd48714bb6352','968fc','nowcoder137@sina.com',0,1,NULL,'http://images.nowcoder.com/head/677t.png','2019-04-26 11:48:31'),(138,'yyy','046291c11cdfb896aa7cd48714bb6352','968fc','nowcoder138@sina.com',0,1,'69dcd69f4c0145058df820e90820ba1e','http://images.nowcoder.com/head/138t.png','2019-04-25 07:18:07'),(144,'zzz','07b83b7747ca08bc4b0153d5b8ce7519','21e8b','nowcoder144@sina.com',0,1,'107eb2cbb8454fbe96848790e6a730b1','http://images.nowcoder.com/head/144t.png','2019-04-26 08:59:50'),(145,'lhh','d980a16ea0b3c8a81062ee806e65a4bc','5abfc','nowcoder145@sina.com',0,1,'f217b637e9544e2a9b4a88f78c583d03','http://images.nowcoder.com/head/145t.png','2019-04-28 07:30:36'),(146,'lihonghe','100489ece9bacfa4d57eb5777b4d4643','00d7a','nowcoder146@sina.com',0,1,'5a61faee7af94e89ba7237b1277c9fed','http://images.nowcoder.com/head/146t.png','2019-04-29 03:47:24'),(149,'niuke','ebce124c4ba2de3be92dc9a3bc1ea75b','90196','nowcoder149@sina.com',0,1,'d7a5714a145b4461b5a4199cc5a0014f','http://images.nowcoder.com/head/149t.png','2019-05-17 07:48:11');
/*!40000 ALTER TABLE `user` ENABLE KEYS */;
UNLOCK TABLES;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2019-05-24 17:41:09

```

因为需要对数据库进行操作，所以我们需要导入几个包：

```xml
<!--jdbc场景-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
<!--数据库驱动，版本对应数据库版本-->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
    <version>8.0.21</version>
</dependency>

<!--mybatis-->
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.2.0</version>
</dependency>

<!--druid-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>1.1.17</version>
</dependency>
```



## 2.1 用户

### 2.1.1 用户表

```sql
--
-- Table structure for table `user`
--

DROP TABLE IF EXISTS `user`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) DEFAULT NULL,
  `password` varchar(50) DEFAULT NULL,
  `salt` varchar(50) DEFAULT NULL,
  `email` varchar(100) DEFAULT NULL,
  `type` int(11) DEFAULT NULL COMMENT '0-普通用户; 1-超级管理员; 2-版主;',
  `status` int(11) DEFAULT NULL COMMENT '0-未激活; 1-已激活;',
  `activation_code` varchar(100) DEFAULT NULL,
  `header_url` varchar(200) DEFAULT NULL,
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_username` (`username`(20)),
  KEY `index_email` (`email`(20))
) ENGINE=InnoDB AUTO_INCREMENT=101 DEFAULT CHARSET=utf8;
```

### 2.1.2 实体类

```java
public class User {
    private int id;
    private String username;
    private String password;
    private String salt;
    private String email;
    private int type; //0普通用户 1超级管理员 2版主
    private int status;//0未激活 1已激活
    private String activationCode;
    private String headerUrl;
    private Date createTime;
}
```

### 2.1.3 数据接口

```java
@Mapper
public interface UserMapper {

    User selectById(int id);

    User selectByUsername(String username);

    User selectByEmail(String email);

    int insertUser(User user);

    int updateStatus(int id,int status);

    int updateHeader(int id,String headerUrl);

    int updatePassword(int id,String password);
}
```

### 2.1.4 接口映射文件

需要注意几个问题：

- insert用户时，因为主键是自动增长的，所以我们不需要主动的插入id，id靠mysql生成。插入时有参数Keyproperty，这个值时user实体类的字段名称，就是说mysql自动生成主键之后，它应该将这个主键赋值给user的哪个字段

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.ligen.nowcoder.dao.UserMapper">

    <sql id="insertFields">
        username,password,salt,email,type,status,activation_code,header_url,create_time
    </sql>

    <sql id="selectFields">
        id,username,password,salt,email,type,status,activation_code,header_url,create_time
    </sql>

    <select id="selectById" resultType="User">
        select <include refid="selectFields"></include>
        from user
        where id=#{id}
    </select>

    <select id="selectByUsername" resultType="User">
        select <include refid="selectFields"></include>
        from user
        where username=#{username}
    </select>

    <select id="selectByEmail" resultType="User">
        select <include refid="selectFields"></include>
        from user
        where email=#{email}
    </select>

    <insert id="insertUser" parameterType="User" keyProperty="id">
        insert into user(<include refid="insertFields"></include>)
        values(#{username},#{password},#{salt},#{email},#{type},#{status},#{activationCode},#{headerUrl},#{createTime})
    </insert>

    <update id="updateStatus">
        update user set status = #{status} where id=#{id}
    </update>

    <update id="updateHeader">
        update user set header_url=#{headerUrl} where id=#{id}
    </update>

    <update id="updatePassword">
        update user set password=#{password} where id=#{id}
    </update>

</mapper>
```

### 2.1.5 service层接口与实现

接口

```java
public interface UserService {
    User selectById(int id);

    User selectByUsername(String username);

    User selectByEmail(String email);

    int insertUser(User user);

    int updateStatus(int id,int status);

    int updateHeader(int id,String headerUrl);

    int updatePassword(int id,String password);
}
```

实现

```java
@Service
public class UserServiceImpl implements UserService {

    @Autowired
    private UserMapper userMapper;

    @Override
    public User selectById(int id) {
        return userMapper.selectById(id);
    }

    @Override
    public User selectByUsername(String username) {
        return userMapper.selectByUsername(username);
    }

    @Override
    public User selectByEmail(String email) {
        return userMapper.selectByEmail(email);
    }

    @Override
    public int insertUser(User user) {
        return userMapper.insertUser(user);
    }

    @Override
    public int updateStatus(int id, int status) {
        return userMapper.updateStatus(id,status);
    }

    @Override
    public int updateHeader(int id, String headerUrl) {
        return userMapper.updateHeader(id,headerUrl);
    }

    @Override
    public int updatePassword(int id, String password) {
        return userMapper.updatePassword(id,password);
    }
}
```



## 2.2 帖子

### 2.2.1 帖子表

```sql
--
-- Table structure for table `discuss_post`
--

DROP TABLE IF EXISTS `discuss_post`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `discuss_post` (
  `id` int(11) NOT NULL AUTO_INCREMENT, --帖子id
  `user_id` varchar(45) DEFAULT NULL, -- 用户id
  `title` varchar(100) DEFAULT NULL, -- 帖子标题
  `content` text, -- 帖子内容
  `type` int(11) DEFAULT NULL COMMENT '0-普通; 1-置顶;', -- 帖子状态
  `status` int(11) DEFAULT NULL COMMENT '0-正常; 1-精华; 2-拉黑;', -- 
  `create_time` timestamp NULL DEFAULT NULL, -- 帖子创建时间
  `comment_count` int(11) DEFAULT NULL, -- 评论数
  `score` double DEFAULT NULL, -- 分数，进行排名
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
```

对数据源，数据库，mybatis进行一个配置application.xml



### 2.2.2 实体类

```java
public class DiscussPost {

    private int id;
    private int userId;
    private String title;
    private String content;
    private int type; //0普通 1置顶
    private int status; //0普通 1精华 2拉黑
    private Date createTime;
    private int commentCount;
    private double socre;

}
```

### 2.2.3 数据接口

有几个需要注意的问题：

- 我们在首页是直接查询所有帖子的，但是用户空间就需要展现该用户的所有帖子，所以在开发开始就可以添加一个userId参数，这样我们可以通过动态sql来进行开发，适应不同的场景
- offset和limit也是这个道理

```java
@Mapper
public interface DiscussPostDao {

    /**
     * 查询帖子所有信息，以下参数作为动态sql的条件
     * @param userId 用户id，当在用户页面查询用户发的帖时需要。userId为0则代表查询所有用户的帖子
     * @param offset
     * @param limit
     * @return
     */
    List<DiscussPost> selectDiscussPosts(@Param("userId") int userId, @Param("offset")int offset, @Param("limit") int limit);

    /**
     * 返回总共有多少帖子
     * @param userId
     * @return
     */
    int selectDiscussPostRows(@Param("userId") int userId);
    
}
```

### 2.2.4 接口映射文件

这个映射文件的位置在yml配置文件中进行了配置

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.ligen.nowcoder.dao.DiscussPostDao">

    <sql id="selectFields">
        id,user_id,title,content,type,status,create_time,comment_count,score
    </sql>

    <select id="selectDiscussPosts" resultType="com.edu.ligen.nowcoder.entity.DiscussPost">
        select <include refid="selectFields"></include>
        from discuss_post
        where status!=2
        <if test="userId!=0">
            and user_id = #{userId}
        </if>
        order by type desc,create_time desc
        limit #{offset},#{limit}
    </select>

    <select id="selectDiscussPostRows" resultType="int">
        select COUNT(id) from discuss_post
        <if test="userId!=0">
            where user_id=#{userId}
        </if>
    </select>

</mapper>
```

### 2.2.5 service层接口与实现

接口

```java
public interface DiscussPostService {
    /**
     * 查询帖子所有信息，以下参数作为动态sql的条件
     * @param userId 用户id，当在用户页面查询用户发的帖时需要。userId为0则代表查询所有用户的帖子
     * @param offset
     * @param limit
     * @return
     */
    List<DiscussPost> selectDiscussPosts(@Param("userId") int userId, @Param("offset")int offset, @Param("limit") int limit);

    /**
     * 返回总共有多少帖子
     * @param userId
     * @return
     */
    int selectDiscussPostRows(@Param("userId") int userId);
}
```

实现

```java
@Service
public class DiscussPostServiceImpl implements DiscussPostService {
    
    @Autowired
    private DiscussPostMapper discussPostMapper;
    
    @Override
    public List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit) {
        return discussPostMapper.selectDiscussPosts(userId, offset, limit);
    }

    @Override
    public int selectDiscussPostRows(int userId) {
        return discussPostMapper.selectDiscussPostRows(userId);
    }
}
```





## 2.3 访问首页

首页IndexController

```java
@Controller
public class IndexController {

    @Autowired
    private UserService userService;

    @Autowired
    private DiscussPostService discussPostService;

    @RequestMapping(value = {"/","/index"},method = RequestMethod.GET)
    public String index(Model model){
        //访问首页，我们需要列出帖子列表，其中包括帖子相关和用户相关，所以要对这两个表都进行查询
        List<DiscussPost> list = discussPostService.selectDiscussPosts(0, 0, 10);//需要查出所有的帖子，每页10条

        List<Map<String,Object>> discussPosts = new ArrayList<>();
        //每条帖子都有发贴用户的userId信息，所以根据这个id去查user表找到这个用户
        for (DiscussPost post : list) {
            Map<String,Object> map = new HashMap<>();
            map.put("post",post);
            User user = userService.selectById(post.getUserId());
            map.put("user",user);
            discussPosts.add(map);
        }

        model.addAttribute("discussPosts",discussPosts);

        return "index";
    }
}
```



帖子列表

```html
<!-- 帖子列表 -->
<ul class="list-unstyled">
    <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="map:${discussPosts}">
        <a href="site/profile.html">
            <img th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="用户头像" style="width:50px;height:50px;">
        </a>
        <div class="media-body">
            <h6 class="mt-0 mb-3">
                <a href="#" th:utext="${map.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
                <span class="badge badge-secondary bg-primary" th:if="${map.post.type==1}">置顶</span>
                <span class="badge badge-secondary bg-danger" th:if="${map.post.status==1}">精华</span>
            </h6>
            <div class="text-muted font-size-12">
                <u class="mr-3" th:utext="${map.user.username}">寒江雪</u> 发布于 <b th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b>
                <ul class="d-inline float-right">
                    <li class="d-inline ml-2">赞 11</li>
                    <li class="d-inline ml-2">|</li>
                    <li class="d-inline ml-2">回帖 7</li>
                </ul>
            </div>
        </div>						
    </li>
</ul>
```

需要注意几个问题：

- 这里使用到了遍历功能 `th:each`，该标签可以遍历从controller传输过来的数据，使用key值取值，`th:each="map:${discussPosts}`，这个map意味着列表中的每个值
- 时间格式化`th:text="${#dates.format(map.post.createTime,'yyyy-MM-dd HH:mm:ss')}"`



### 2.3.1 帖子分页

关于分页有很多小的细节：

- 对于setter进行边界值的过滤，非法值不能设置进去

- 服务端根据前端传回来的页面来返回该页的数据

- 本页页面页码，需要显示前后的页码，且页码不能溢出（负数或超出最大值）
- 到哪个页面就需要激活标签高亮
- 根据帖子的行数，计算分页后总共有多少页

**所以需要创建一个`Page`类来操作分页功能相关的东西**

```java
package com.edu.ligen.nowcoder.entity;

/**
 * 封装分页相关的信息
 */
public class Page {

    //当前页码
    private int current = 1;
    //显示上限
    private int limit = 10;
    //数据总数（用于计算总页数）
    private int rows;
    //查询路径（复用查询链接）
    private String path;

    public int getCurrent() {
        return current;
    }

    public void setCurrent(int current) {
        if (current >= 1) {
            this.current = current;
        }
    }

    public void setLimit(int limit) {
        if (limit >= 1 && limit <= 100) {
            this.limit = limit;
        }
    }

    public void setRows(int rows) {
        if (rows >= 0) {
            this.rows = rows;
        }
    }

    /**
     * 根据当前页码，算出当前页面的起始行，方便数据库查询
     *
     * @return
     */
    public int getOffset() {
        return (current - 1) * limit;
    }

    /**
     * 返回在当前总行数下总共有多少页
     *
     * @return
     */
    public int getTotal() {
        if (rows % limit == 0) {
            return rows / limit;
        } else {
            return rows / limit + 1;
        }
    }

    /**
     * 返回前两页的页码
     *
     * @return
     */
    public int getFrom() {
        int from = current - 2;
        return from < 1 ? 1 : from;
    }

    /**
     * 返回后两页的页码
     *
     * @return
     */
    public int getTo() {
        int to = current + 2;
        return to > getTotal() ? getTotal() : to;
    }
}

```

**Controller**

这个controller只需要再前面IndexController基础上稍加修改

- 给index方法添加了新的参数page
- 通过page获取offset和limit值

需要注意的问题：

- 前端的请求(/index?current=1)，将current自动封装进了page
- dispathcerServlet会自动的将Page类注入到Model里，我们不需要自己再手动注入

```java
@Controller
public class IndexController {

    @Autowired
    private UserService userService;

    @Autowired
    private DiscussPostService discussPostService;

    @RequestMapping(value = {"/","/index"},method = RequestMethod.GET)
    public String index(Model model, Page page){
        //dispathcerServlet会自动的将Page类注入到Model里，我们不需要自己再手动注入
        page.setRows(discussPostService.selectDiscussPostRows(0));
        page.setPath("/index");


        //访问首页，我们需要列出帖子列表，其中包括帖子相关和用户相关，所以要对这两个表都进行查询
        List<DiscussPost> list = discussPostService.selectDiscussPosts(0, page.getOffset(), page.getLimit());//需要查出所有的帖子，每页10条

        List<Map<String,Object>> discussPosts = new ArrayList<>();
        //每条帖子都有发贴用户的userId信息，所以根据这个id去查user表找到这个用户
        for (DiscussPost post : list) {
            Map<String,Object> map = new HashMap<>();
            map.put("post",post);
            User user = userService.selectById(post.getUserId());
            map.put("user",user);
            discussPosts.add(map);
        }

        model.addAttribute("discussPosts",discussPosts);

        return "index";
    }
}
```

**前端页面**

需要注意几个问题：

- `@{${page.path}(current=1)}`这种路径写法，最终可以拼接为`/index?current=1`，如果是多参数也可以拼接，并且服务器自动将该值封装进page对象
- `th:each="i:${#numbers.sequence(page.getFrom,page.to)}"`，`#numbers.sequence()`自动生成一个数列
- `th:class="|page-item ${page.current==i?'active':''}|"`，到哪个页面哪里就是激活的状态，这里用`||`括起来，静态值会一直显示，动态值通过三目运算符获得.上面的`disable`同理
- 最重要的一点，`page`里没有`total`对象，只有`getTotal`方法，但是再模板中可以通过`page.total`获取到总页数，用到的`getFrom`和`getTo`也可以用`page.from`和`page.to`代替
- `current`没有使用`page`前缀也可以将变量取出来
- 原因参考[springboot-thymeleaf模板引擎](..\..\Springboot\springboot入门.md\# 7 视图解析与模板引擎)

```java
<!-- 分页 -->
<nav class="mt-5" th:if="${page.rows>0}" th:if="${page.rows>0}">
    <ul class="pagination justify-content-center">
        <li class="page-item">
            <!--@{${page.path}(current=1)} 这种写法的最终路径是 /index?current=1，如果是多参数还可以拼接-->
            <a class="page-link" th:href="@{${page.path}(current=1)}">首页</a>
        </li>
        <li th:class="|page-item ${page.current==1?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current=${page.current-1})}">上一页</a>
        </li>
        <li th:class="|page-item ${page.current==i?'active':''}|" th:each="i:${#numbers.sequence(page.getFrom,page.to)}">
            <a class="page-link" th:href="@{${page.path}(current=${i})}" th:text="${i}">1</a>
        </li>
        <li th:class="|page-item ${page.current==page.total?'disabled':''}|">
            <a class="page-link" th:href="@{${page.path}(current=${page.current+1})}">下一页</a>
        </li>
        <li class="page-item">
            <a class="page-link" th:href="@{${page.path}(current=${page.getTotal})}">末页</a>
        </li>
    </ul>
</nav>
```





# 3 发送邮件

- 邮箱设置
  - 启用客户端SMTP服务
- Spring Email
  - 导入jar包
  - 邮箱参数配置
  - 使用JavaSendMail发送邮件
- 模板引擎
  - 使用thymeleaf发送HTML邮件



发送邮件我们使用到下面的依赖

```xml
<!--        email-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

对邮箱的参数进行配置

```yml
# Mail
spring:
  mail:
    host: smtp.126.com # 使用的邮箱域名
    port: 465 # 几乎所有默认465
    username: ligen0621@126.com
    password: ITGGUJLHXJUJNZLU # 邮箱授权码
    protocol: smtps # 访问协议
    properties:
      mail:
        smtp:
          enable: true # 访问时使用安全连接ssl
```



## 3.1 JavaSendMail

JavaSendMail类中有一个参数MimeMessage，该类代表了我们要发送邮件的所有信息，包括发件人，收件人，主题等等

同时spring提供了一个MimeMessageHelper类来帮助我们操作这个MimeMessage

另外还有一个send方法用来发送消息



需要注意几个问题：

- message需要用mailSender.createMimeMessage()方法创建，而不是new
- 设置完各种信息之后使用mailSender调用send发送邮件
  - 参数可以直接使用message或者使用helper.getMimeMessage()方法获得

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Component;

import javax.mail.MessagingException;
import javax.mail.internet.MimeMessage;


@Component
public class MailClientUntils {

    private static final Logger logger = LoggerFactory.getLogger(MailClientUntils.class);

    @Autowired
    private JavaMailSender mailSender;

    @Value("${spring.mail.username}")
    private String from;

    public void sendMail(String to,String subject,String text){
        MimeMessage message = mailSender.createMimeMessage();
        MimeMessageHelper helper = new MimeMessageHelper(message);
        logger.info("发件人==>{}",from);
        try {
            helper.setFrom(from);
            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(text,true);
            mailSender.send(helper.getMimeMessage());
        } catch (MessagingException e) {
            logger.error("发送邮件出错"+e.getMessage());
        }
    }
}
```

测试类

```java
@SpringBootTest
public class MailClientUntilsTest {

    @Autowired
    MailClientUntils mailClientUntils;

    @Test
    public void sendMailTest(){
        mailClientUntils.sendMail("807404872@qq.com","测试发送邮件","我是你的测试内容");
//        mailClientUntils.sendMail("ligen0621@126.com","测试发送邮件","我是你的测试内容");
    }
}
```



## 3.2 HTML邮件

使用模板引擎发送HTML格式邮件内容，收到邮件后内容根据模板变化



创建一个内容页面

```html
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>邮件测试</title>
</head>
<body>
    <div>
        <span>你好呀</span><br/>
        <div style="color:red" th:text="${name}"></div>
    </div>
</body>
</html>
```

测试类

```java
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.thymeleaf.TemplateEngine;
import org.thymeleaf.context.Context;

@SpringBootTest
public class MailClientUntilsTest {

    @Autowired
    MailClientUntils mailClientUntils;

    @Autowired
    TemplateEngine templateEngine;

    @Test
    public void sendHTMLTest(){
        Context context = new Context();
        context.setVariable("name","ligen");

        String text =  templateEngine.process("mail.html",context);
        mailClientUntils.sendMail("807404872@qq.com","测试发送邮件",text);
    }
}
```

需要注意几个问题：

- Context使用thymeleaf模板引擎包，并给context设置变量内容，这个变量key同页面的关键字
- 使用模板引擎templateEngine.process()方法设置要发送的页面和模板上下文环境，返回值是一个字符串，也就是模板页面填充过变量的结果



# 4 注册

- 访问注册页面
  - 点击顶部区域的链接，打开注册页面
- 提交注册数据
  - 通过表单提交验证
  - 服务端验证账号是否已经存在、邮箱是否已经注册
  - 服务端发送激活邮件
- 激活注册账号
  - 点击邮件中的链接，访问服务端的激活服务



**导入字符串处理包**

```xml
<!-- https://mvnrepository.com/artifact/org.apache.commons/commons-lang3 -->
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.12.0</version>
</dependency>
```



**创建工具类**

需要注意几个问题：

- UUID中包含`-`，一般我们都会替换掉
- `StringUntils`为Commons-lang3中的工具，这个`isBlank`方法可以对null，空串，空格串进行一个判断

```java
public class CommunityUntils {

    /**
     * 生成UUID
     * @return
     */
    public static String generateUUID(){
        return UUID.randomUUID().toString().replaceAll("-","");
    }

    /**
     * 对参数进行md5加密
     * @param key
     * @return
     */
    public static String md5(String key){
        //该方法判断空串，null，空格
        if (StringUtils.isBlank(key)){
            return null;
        }
        return DigestUtils.md5DigestAsHex(key.getBytes());
    }
}

```







## 4.1 访问注册页面



### 4.1.1 修改注册页面，并将头部，底部区域重用



### 4.1.2 在UserService中加入新的接口

```java
/**
 * 注册
 * @param user
 * @return
 */
Map<String,Object> register(User user);
```

### 4.1.3 接口实现

```java
@Service
public class UserServiceImpl implements UserService {

    //邮件客户端
    @Autowired
    private MailClientUtils mailClient;

    //模板引擎，用于发送模板邮件
    @Autowired
    private TemplateEngine templateEngine;

    @Autowired
    private UserMapper userMapper;

    //服务端邮件地址
    @Value("${community.path.domain}")
    private String domain;

    //项目路径
    @Value("${server.servlet.context-path}")
    private String contextPath;


    @Override
    public Map<String, Object> register(User user) {
        Map<String,Object> map = new HashMap<>();

        //用户对象不能为空
        if(user == null){
            map.put("usernameMsg","用户名不能为空");
            map.put("passwordMsg","密码不能为空");
            map.put("emailMsg","邮箱不能为空");
            throw new IllegalArgumentException("参数不能为空");
        }

        //判断用户名
        if(StringUtils.isBlank(user.getUsername())){
            map.put("usernameMsg","用户名不能为空");
            return map;
        }
        //判断密码
        if(StringUtils.isBlank(user.getPassword())){
            map.put("passwordMsg","密码不能为空");
            return map;
        }
        //判断邮箱
        if(StringUtils.isBlank(user.getEmail())){
            map.put("emailMsg","邮箱不能为空");
            return map;
        }

        //验证邮箱用户名是否已经存在
        User u = userMapper.selectByUsername(user.getUsername());
        if(u!=null){
            map.put("usernameMsg","该用户名已经存在");
        }
        u = userMapper.selectByEmail(user.getEmail());
        if(u!=null){
            map.put("emailMsg","该邮箱已被注册");
        }

        //注册用户，加盐加密
        user.setSalt(CommunityUtils.generateUUID().substring(0,5));//将UUID截取5位
        user.setPassword(CommunityUtils.md5(user.getPassword()+user.getSalt()));
        user.setType(0);//新用户位普通用户
        user.setStatus(0);//新用户未激活
        user.setActivationCode(CommunityUtils.generateUUID());//生成激活码
        user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
        user.setCreateTime(new Date());
        userMapper.insertUser(user);

        //发送激活邮件模板邮件
        Context context = new Context();

        //http://localhost:8080/community/activation/101/code
		String url = domain + contextPath + "/" + user.getId() + "/" + user.getActivationCode();
        context.setVariable("activeUrl",url);
        context.setVariable("username",user.getUsername());

        String content = templateEngine.process("mail/activation.html", context);
        mailClient.sendMail(user.getEmail(),"激活邮件",content);


        return map;
    }
}
```



### 4.1.4 创建controller

在LoginController中添加方法register用来处理注册请求

```java
/**
 * 注册，登录，忘记密码，修改密码
 */
@Controller
public class LoginController {

    @Autowired
    private UserService userService;

    @RequestMapping(value={"/register","/register.html"},method = RequestMethod.GET)
    public String getRegisterPage(){
        return "site/register";
    }


    /**
     * 对用户的注册表单进行处理
     * @param model
     * @param user
     * @return
     */
	@RequestMapping(value="/signup",method = RequestMethod.POST )
    public String signup(Model model, User user){
        Map<String,Object> map = userService.register(user);
        if(map.isEmpty()){//map为空意味着注册成功
            model.addAttribute("msg","您的账号已经注册成功，请前往邮箱进行激活!");
            model.addAttribute("target","/index.html");//发送给operater-result页面
            return "/site/operate-result";
        }else{    //注册失败
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            model.addAttribute("emailMsg",map.get("emailMsg"));
            return "/site/register";
        }
    }
}
```

### 4.1.5 注册页面表单

注意几个问题：

- 对已存在的账号和邮箱进行判断并返回到前端，springMVC将对象类型自动注入到model，基本类型不会
- 账号邮箱非法，通过`th:class="|form-control ${usernameMsg!=null?'is-invalid':''}|"`显示非法信息
- 未注册成功返回当前页面，保留前面填过的信息

```html
<!-- 内容 -->
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <h3 class="text-center text-info border-bottom pb-3">注&nbsp;&nbsp;册</h3>
        <form class="mt-5" th:action="@{/signup}" method="post">
            <div class="form-group row">
                <label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
                <div class="col-sm-10">
                    <input type="text" th:class="|form-control ${usernameMsg!=null?'is-invalid':''}|"
                           id="username" name="username"
                           th:value="${user!=null?user.username:''}"
                           placeholder="请输入您的账号!" required>
                    <div class="invalid-feedback" th:text="${usernameMsg}">
                        该账号已存在!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
                <div class="col-sm-10">
                    <input type="password" th:class="|form-control ${passwordMsg!=null?'is-invalid':''}|"
                           id="password" name="password"
                           th:value="${user!=null?user.password:''}"
                           placeholder="请输入您的密码!" required>
                    <div class="invalid-feedback" th:text="${passwordMsg}">
                        密码长度不能小于8位!
                    </div>							
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
                <div class="col-sm-10">
                    <input type="password" th:class="form-control"
                           id="confirm-password"
                           placeholder="请再次输入密码!" required>
                    <div class="invalid-feedback">
                        两次输入的密码不一致!
                    </div>
                </div>
            </div>
            <div class="form-group row">
                <label for="email" class="col-sm-2 col-form-label text-right">邮箱:</label>
                <div class="col-sm-10">
                    <input type="email" th:class="|form-control ${emailMsg!=null?'is-invalid':''}|"
                           id="email" name="email"
                           th:value="${user!=null?user.email:''}"
                           placeholder="请输入您的邮箱!" required>
                    <div class="invalid-feedback" th:text="${emailMsg}">
                        该邮箱已注册!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">立即注册</button>
                </div>
            </div>
        </form>				
    </div>
</div>
```

### 4.1.6 注册成功后页面

```html
<!-- 内容 -->
<div class="main">
    <div class="container mt-5">
        <div class="jumbotron">
            <p class="lead" th:text="${msg}">您的账号已经激活成功,可以正常使用了!</p>
            <hr class="my-4">
            <p>
                系统会在 <span id="seconds" class="text-danger">8</span> 秒后自动跳转,
                您也可以点此 <a id="target" th:href="@{${target}}" class="text-primary" >链接</a>, 手动跳转!
            </p>
        </div>
    </div>
</div>
```



## 4.2 激活注册账号

### 4.2.1 创建常量接口

方便复用

```java
/**
 * 常量工具类
 */
public interface CommunityConstant {

    /**
     * 激活失败
     * 未激活
     */
    int ACTIVATION_FAILED = 0;

    /**
     * 激活成功
     */
    int ACTIVATION_SUCCESS = 1;


    /**
     * 重复激活
     */
    int ACTIVATION_REPEAT = 2;
}

```

### 4.2.2 激活服务实现

如果要使用上面的常量，UserServiceImpl类需要实现上面的接口

```java
@Override
public int activation(int userId, String activationCode) {
    User user = userMapper.selectById(userId);
    //激活失败
    if(user==null){
        return ACTIVATION_FAILED;
    }else if(user.getStatus()== ACTIVATION_FAILED && user.getActivationCode().equals(activationCode)){
        //激活成功
        userMapper.updateStatus(user.getId(),ACTIVATION_SUCCESS);
        return ACTIVATION_SUCCESS;
    }else if(user.getStatus()==ACTIVATION_SUCCESS) {
        //重复激活
        return ACTIVATION_REPEAT;
    }
    return ACTIVATION_FAILED;
}
```



### 4.2.3 controller

在LoginController中添加激活访问

注意几个问题：

- 路径访问使用了RESTful风格

```java
/**
 * 使用RESTful风格传参，进行激活
 * //http://localhost:8080/community/activation/101/code
 * @param model
 * @param userId
 * @param activationCode
 * @return
 */
@RequestMapping(value="/activation/{userId}/{activationCode}",method=RequestMethod.GET)
public String avtivation(Model model, @PathVariable("userId") int userId,@PathVariable("activationCode") String activationCode){
    int result = userService.activation(userId,activationCode);
    if(result == ACTIVATION_SUCCESS){
        //激活成功，从结果页面返回到登录页
        model.addAttribute("msg","您的账号已经激活成功,可以正常使用了!");
        model.addAttribute("target","/login");
    }else if(result == ACTIVATION_FAILED){
        //激活失败，从结果页面返回首页
        model.addAttribute("msg","很遗憾！激活失败，请您重新检查！");
        model.addAttribute("target","/index");
    }else{
        //重复激活，从结果页面返回到登录页
        model.addAttribute("msg","您的账号已经激活成功,请勿重复激活！");
        model.addAttribute("target","/login");
    }
    return "/site/operate-result";
}
```



### 4.2.4 登录页面访问

加在LoginController中

```java
@RequestMapping(value={"/login","/login.html"},method = RequestMethod.GET)
public String login(){
    return "/site/login";
}
```



# 5 登录

- 访问登陆页面
- 登录
  - 验证账号，密码，验证码
  - 成功，生成登陆凭证，发放给客户端
  - 登录凭证可以用session，也可以数据库，为了后期方便redis，这里使用数据库
  - 失败，跳转回登录页
- 退出
  - 将凭证改为失效状态
  - 跳转至网站首页



## 5.1 生成验证码

- Kaptcha
  - 导入jar包
  - 编写Kaptcha配置类
  - 生成随机字符，生成图片

[参考Kaptcha笔记](..\..\..\库\kaptcha\kaptcha入门.md)



### 5.1.1 LoginController

在LoginController中加入获取验证码的请求

注意几个问题：

- 验证码属于敏感信息，因此使用session传输
- 直接使用response返回验证码信息，设置响应头方便浏览器处理信息，不加也能处理
- java7语言，try后面加小括号，里面的内容会自动到finnaly中执行

```java
/**
 * 获取验证码单独写一个请求，方便后面刷新验证码，用response单独返回
 * 该验证码属于敏感信息，所以使用session存储在服务端
 * @param response
 * @param session
 */
@RequestMapping(value = "/kaptcha",method = RequestMethod.GET)
public void getKaptcha(HttpServletResponse response, HttpSession session){
    //生成验证码
    String text = kaptcha.createText();
    BufferedImage image = kaptcha.createImage(text);

    //将验证码存入session
    session.setAttribute("kaptcha",text);

    // 将图片输出给浏览器
    response.setContentType("image/png");
       try(
                OutputStream os = response.getOutputStream();
                ) {
            ImageIO.write(image,"png",os);
        } catch (IOException e) {
            logger.error("验证码响应失败"+e.getMessage());
        }
}
```



### 5.1.2 修改login.html

**修改验证码图片的链接**

注意几个问题：

- 修改图片链接
- 增加id属性，方便js调用

```html
<div class="col-sm-4">
    <img th:src="@{/kaptcha}" id="kaptcha" style="width:100px;height:40px;" class="mr-2"/>
    <a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
</div>
```



**刷新验证码使用js实现**

注意几个问题：

- 使用jQuery实现刷新功能
- CONTEXT_PATH为在global.js中的全局变量，方便后期修改项目路径
- 拼接的路径带参数是因为有些浏览器在参数不变的情况下就认为你没有请求，不会给你返回想要的数据，无法刷新

```html
<script>
    function refresh_kaptcha(){
        var path = CONTEXT_PATH + "/kaptcha?p=" + Math.random();
        $("#kaptcha").attr("src",path);
    }
</script>
```



## 5.2 登录凭证

### 5.2.1 登录凭证表

```sql
--
-- Table structure for table `login_ticket`
--

DROP TABLE IF EXISTS `login_ticket`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `login_ticket` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `ticket` varchar(45) NOT NULL,
  `status` int(11) DEFAULT '0' COMMENT '0-有效; 1-无效;',
  `expired` timestamp NOT NULL,
  PRIMARY KEY (`id`),
  KEY `index_ticket` (`ticket`(20))
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
```

### 5.2.2 实体类

```java
public class LoginTicket {
    private int id;
    private int userId;
    private String ticket;
    private int status;//0有效，1无效
    private Date expired;//过期时间
}
```

### 5.2.3 数据接口

在真正的工程开发很少删除数据，只会让其失效，所以这个删除接口我并不实现它

```java
@Mapper
public interface LoginTicketMapper {

    //根据凭证找出所有信息
    LoginTicket selectByTicket(String ticket);

    //插入新凭证
    int insertLoginTicket(LoginTicket loginTicket);

    //更新凭证相关信息
    int updateLoginTicket(String ticket, int status);


    //删除凭证
    //真正的工程开发很少删除数据，只会让其失效
    int deleteLoginTicket(String ticket);
}
```

### 5.2.4 接口映射文件

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.ligen.nowcoder.dao.LoginTicketMapper">

    <sql id="selectFields">
        id,user_id,ticket,status,expired
    </sql>

    <sql id="insertFields">
        user_id,ticket,status,expired
    </sql>

    <select id="selectByTicket" resultType="com.edu.ligen.nowcoder.entity.LoginTicket">
        select <include refid="selectFields"></include> from login_ticket where ticket = #{ticket};
    </select>

    <insert id="insertLoginTicket" keyProperty="id" parameterType="com.edu.ligen.nowcoder.entity.LoginTicket">
        insert into login_ticket(<include refid="insertFields"></include>)
        values(#{userId},#{ticket},#{status},#{expired});
    </insert>

    <update id="updateLoginTicket">
        update login_ticket set status = #{status} where ticket = #{ticket}
    </update>

</mapper>
```

### 5.2.5 service层接口与实现

接口

```java
public interface LoginTicketService {

    //根据凭证找出所有信息
    LoginTicket selectByTicket(String ticket);

    //插入新凭证
    int insertLoginTicket(LoginTicket loginTicket);

    //更新凭证相关信息
    int updateLoginTicket(String ticket, int status);


    //删除凭证
    //真正的工程开发很少删除数据，只会让其失效
    int deleteLoginTicket(String ticket);
}
```

实现

```java
@Service
public class LoginTicketServiceImpl implements LoginTicketService {

    @Autowired
    private LoginTicketMapper loginTicketMapper;

    @Override
    public LoginTicket selectByTicket(String ticket) {
        return loginTicketMapper.selectByTicket(ticket);
    }

    @Override
    public int insertLoginTicket(LoginTicket loginTicket) {
        return loginTicketMapper.insertLoginTicket(loginTicket);
    }

    @Override
    public int updateLoginTicket(String ticket, int status) {
        return loginTicketMapper.updateLoginTicket(ticket, status);
    }

    @Override
    public int deleteLoginTicket(String ticket) {
        return 0;
    }
}
```

## 5.3 登录验证

### 5.3.1 新增接口

在LoginTicketService中新增接口方法

```java
/**
 * 登录验证业务
 * @param username 用户名
 * @param password 用户密码
 * @param expiredSeconds 过期时间，单位秒
 * @return
 */
Map<String,Object> login(String username,String password,long expiredSeconds);
```

### 5.3.2 接口实现

注意几个问题：

- 对用户名和密码进行空值处理
- 验证正确性，注意密码加盐加密，还要判断账号是否处理激活状态
- 最后生成凭证

```java
@Autowired
private LoginTicketMapper loginTicketMapper;

@Override
public Map<String, Object> login(String username, String password,long expiredSeconds) {
    Map<String,Object> map = new HashMap<>();

    //空值处理
    if(StringUtils.isBlank(username) || StringUtils.isEmpty(username)){
        map.put("usernameMsg","用户名不能为空");
        return map;
    }
    if(StringUtils.isBlank(password) || StringUtils.isEmpty(password)){
        map.put("passwordMsg","密码不能为空");
        return map;
    }

    //不为空，判断存在与否，正确与否
    User user = userMapper.selectByUsername(username);
    if(user==null){
        map.put("usernameMsg","该账号不存在");
        return map;
    }
    if(user.getStatus()==0){
    map.put("usernameMsg","该账号未激活");
    return map;
    }
    password = CommunityUtils.md5(password+user.getSalt());
    if(!(user.getPassword().equals(password))){
        //密码不对
        map.put("passwordMsg","账号或密码错误，请核对!");
        return map;
    }


    //账号密码正确，生成登录凭证
    LoginTicket loginTicket = new LoginTicket();
    loginTicket.setTicket(CommunityUtils.generateUUID());
    loginTicket.setStatus(0);
    loginTicket.setUserId(user.getId());
    loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds*1000));
    loginTicketMapper.insertLoginTicket(loginTicket);

    //凭证生成成功，只将凭证加入map，后来传给客户端
    map.put("ticket",loginTicket.getTicket());

    return map;
}
```

### 5.3.3 修改Controller

在LoginController中新增登录验证请求

需要注意的几个问题：

- 对验证码进行空值，错误判断
- session和cookie的使用
- cookie.setPath()为浏览器访问哪些路径会获得cookie

![](https://github.com/LiMuwenan/PicBed/blob/master/img/dev/java/project/nowcoder/Cookie.png?raw=true)

![](https://github.com/LiMuwenan/PicBed/blob/master/img/dev/java/project/nowcoder/session.png?raw=true)

```java
@Controller
public class LoginController implements CommunityConstant {

    private final static Logger logger = LoggerFactory.getLogger(LoginController.class);

    @Value("${server.servlet.context-path}")
    private String contextPath;

    @Autowired
    private LoginTicketService loginTicketService;


    @RequestMapping(value={"/login","/login.html"},method = RequestMethod.GET)
    public String getLoginPage(){
        return "/site/login";
    }


    /**
     * 对登录进行验证
     * @param username
     * @param password
     * @param code 验证码
     * @param model
     * @param rememberme 是否记住登录
     * @return
     */
    @RequestMapping(value = "/login",method = RequestMethod.POST)
    public String login(String username,String password,String code,
                        Model model, boolean rememberme,
                        HttpServletResponse response,HttpSession session){
        //检查验证码
        String kaptcha = (String) session.getAttribute("kaptcha");
        if(StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)){
            model.addAttribute("codeMsg","验证码错误");
            return "/site/login";
        }

        //检查账号
        long expiredSeconds = rememberme ? REMEMBER_EXPTRED : DEFAULT_EXPIRED;
        Map<String, Object> map = loginTicketService.login(username, password, expiredSeconds);

        if(map.containsKey("ticket")){//成功
            Cookie cookie = new Cookie("ticket",map.get("ticket").toString());
            cookie.setPath(contextPath);
            cookie.setMaxAge((int) expiredSeconds);
            response.addCookie(cookie);
            return "redirect:index";
        }else{//失败
            model.addAttribute("usernameMsg",map.get("usernameMsg"));
            model.addAttribute("passwordMsg",map.get("passwordMsg"));
            return "/site/login";
        }
    }
}
```





### 5.3.4 修改页面

对login.html进行修改

需要注意几个问题：

- `class="form-control"`的有效性会控制 `class="invalid-feedback"`的有效性
- 错误之后返回该页面需要携带原来填写的值
- 在`thymeleaf`模板中可以直接获取`request`的值，`${param.username}`

```html
<!-- 内容 -->
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <h3 class="text-center text-info border-bottom pb-3">登&nbsp;&nbsp;录</h3>
        <form class="mt-5" th:action="@{/login}" method="post">
            <div class="form-group row">
                <label for="username" class="col-sm-2 col-form-label text-right">账号:</label>
                <div class="col-sm-10">
                    <input type="text" th:class="|form-control ${usernameMsg!=null?'is-invalid':''}|"
                           name="username" id="username" th:value="${param.username}"
                           placeholder="请输入您的账号!" required>
                    <div th:class="invalid-feedback" th:text="${usernameMsg}">
                        该账号不存在!
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="password" class="col-sm-2 col-form-label text-right">密码:</label>
                <div class="col-sm-10">
                    <input type="password" th:class="|form-control ${passwordMsg!=null?'is-invalid':''}|"
                           name="password" id="password" th:value="${param.password}"
                           placeholder="请输入您的密码!" required>
                    <div class="invalid-feedback" th:text="${passwordMsg}">
                        密码不正确
                    </div>							
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="verifycode" class="col-sm-2 col-form-label text-right">验证码:</label>
                <div class="col-sm-6">
                    <input type="text" th:class="|form-control ${verifycodeMsg!=null?'is-invalid':''}|"
                           name="verifycode" id="verifycode" placeholder="请输入验证码!">
                    <div class="invalid-feedback" th:text="${verifycodeMsg}">
                        验证码不正确!
                    </div>
                </div>
                <div class="col-sm-4">
                    <img th:src="@{/kaptcha}" id="kaptcha" style="width:100px;height:40px;" class="mr-2"/>
                    <a href="javascript:refresh_kaptcha();" class="font-size-12 align-bottom">刷新验证码</a>
                </div>
            </div>				
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10">
                    <input type="checkbox" id="remember-me" name="rememberme"
                           th:checked="${param.rememberme}">
                    <label class="form-check-label" for="remember-me">记住我</label>
                    <a href="forget.html" class="text-danger float-right">忘记密码?</a>
                </div>
            </div>				
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">立即登录</button>
                </div>
            </div>
        </form>				
    </div>
</div>
```

## 5.4 注销

### 5.4.1 修改页面访问路径



### 5.4.2 修改Controller

在LoginController中增加方法

注意几个问题：

- Cookie中保存着该用户的登录凭证，我们可以通过@CookieValue注解获得该值

```java
/**
 * 注销登录请求
 * @param ticket
 * @return
 */
@RequestMapping(value = "/logout",method = RequestMethod.GET)
public String logout(@CookieValue("ticket") String ticket){
    loginTicketService.updateLoginTicket(ticket,1);
    return "redirect:/login";
}
```



## 5.5 忘记密码

### 5.5.1 忘记密码页面请求和响应

**页面**

forget.html

```html
<!-- 内容 -->
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <form class="mt-5" th:action="@{/reset}" method="post">
            <div class="form-group row">
                <label for="your-email" class="col-sm-2 col-form-label text-right">邮箱:</label>
                <div class="col-sm-10">
                    <input type="email" class="form-control" id="your-email" name="email"
                           onblur="javascript:isEmailValid();"
                           placeholder="请输入您的邮箱!" required>
                    <div class="invalid-feedback" id="emailvalid" th:text="${emailMsg}">
                        该邮
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="verifycode" class="col-sm-2 col-form-label text-right">验证码:</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="verifycode" name="verifycode"
                           placeholder="请输入验证码!">
                    <div class="invalid-feedback">
                        验证码不正确!
                    </div>
                </div>
                <div class="col-sm-4">
                    <a href="javascript:;" class="btn btn-info form-control"
                       id="getVerifycode">
                        获取验证码
                    </a>
                </div>
            </div>	
            <div class="form-group row mt-4">
                <label for="your-password" class="col-sm-2 col-form-label text-right">新密码:</label>
                <div class="col-sm-10">
                    <input type="password" class="form-control" id="your-password" placeholder="请输入新的密码!" required>
                    <div class="invalid-feedback">
                        密码长度不能小于8位!
                    </div>							
                </div>
            </div>							
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">重置密码</button>
                </div>
            </div>
        </form>				
    </div>
</div>
```

**LoginController**

```java
/**
 * 跳转到忘记密码页面
 * @return
 */
@RequestMapping(value = {"/forget","/forget.html"},method = RequestMethod.GET)
public String getForgetPage(){
    return "/site/forget";
}
```



### 5.5.2 ajax验证邮箱是否存在

注意几个问题：

- ajax在发送参数的时候需要有key，且必须和controller接受的参数名称一致
- sucess中是请求返回后进行处理的函数，data为返回的数据
- controller使用@ResponseBody注解返回数据

**ajax**

```html
<script>
    function isEmailValid(){
        var path = CONTEXT_PATH+"/email";
        var email = $("#your-email").val();
        console.log(email);
        $.ajax({
            url:path,
            data: {"email":email},
            success: function (data){
                if(data.toString() == "invalid"){
                    $("#your-email").attr("class","form-control is-invalid");
                    $("#emailvalid").html("该邮箱不存在！");
                }else if(data.toString() == "valid"){
                    $("#your-email").attr("class","form-control");
                }
            }
        })
    }
</script>
```

**LoginController**

```java
/**
 * ajax验证邮箱
 * @param email
 * @return
 */
@RequestMapping(value = "/email",method = RequestMethod.GET)
@ResponseBody
public String emailIsValide(String email){
    User user = userService.selectByEmail(email);
    String emailMsg = "";
    if(user==null){
        emailMsg = "invalid";
    }else{
        emailMsg = "valid";
    }
    return emailMsg;
}
```

### 5.5.3 向邮箱发送验证码



**页面发送按钮使用ajax**

```html
<div class="form-group row mt-4">
<label for="verifycode" class="col-sm-2 col-form-label text-right">验证码:</label>
    <div class="col-sm-6">
        <input type="text" class="form-control" id="verifycode" name="verifycode"
               placeholder="请输入验证码!">
        <div class="invalid-feedback">
            验证码不正确!
        </div>
    </div>
    <div class="col-sm-4">
        <a href="javascript:sendVerifycode();" class="btn btn-info form-control"
           id="getVerifycode">
            获取验证码
        </a>
    </div>
</div>	
<script>
    function sendVerifycode(){
        var path = CONTEXT_PATH + "/send";
        var email = $("#your-email").val();
        console.log(email);
        $.ajax({
            url: path,
            data: {"email":email},
            success: function (data){

            }
        });
    }
</script>
```

**LoginController**

在LoginController里调用UserServiceImpl进行业务

```java
/**
 * 发送验证码请求
 * @param email 接收邮箱，用于给这个邮箱发送验证码
 * @param session 将验证码存入session，方法取用
 * @return
 */
@RequestMapping(value = "/send",method = RequestMethod.GET)
@ResponseBody
public String generterVerifyCode(String email,HttpSession session){
    //直接生成一个6位的数字验证码并且发送到邮箱
    int status = userService.sendResetEmail(email,session);

    return String.valueOf(status);
}
```

**UserService接口**

```java
/**
 * 生成验证码，并且发送到邮箱
 * @param session 用来保存验证码
 * @return 0 失败 1 成功
 */
int sendResetEmail(String email, HttpSession session);
```

**UserServiceImpl实现**

需要注意的几个问题：

- 将verifycode的创建时间也加入session，方便做超时判断

```java
@Override
public int sendResetEmail(String email,HttpSession session) {
    User user = userMapper.selectByEmail(email);
    if(user==null)
        return 0;

    int verifycode = new Random().nextInt(99999) + 100000;
    
    session.setAttribute("verifycode",verifycode);
    session.setAttribute("verifycodeCreateTime",new Date());
    String url = domain + contextPath + "/forget";
    Context context = new Context();
    context.setVariable("username",user.getUsername());
    context.setVariable("verifycode",verifycode);
    context.setVariable("url",url);
    String content = templateEngine.process("mail/forget.html", context);
    mailClient.sendMail(email,"找回密码",content);

    return 1;
}
```

### 5.5.4 修改密码

**UserServie**接口

```java
/**
 * 重置密码
 * @param email
 * @param verifycode
 * @param password
 * @param session
 * @return
 */
int resetPassword(String email,String verifycode,String password,HttpSession session);
```

**UserServiceImpl**实现

需要注意几个问题：

- 对没发验证码但又提交了请求进行判断
- 验证过之后从session中删除验证码相关信息，减轻服务器压力

```java
@Override
public int resetPassword(String email, String verifycode, String password, HttpSession session) {
    Date currentDate = new Date();
    Date createDate = (Date) session.getAttribute("verifycodeCreateTime");

    //没发验证码 或 五分钟超时，验证码失效
    if(createDate!= null && currentDate.getTime()-createDate.getTime() > FIVE_MINUTE_MILLIS){
        return VERIFYCODE_OVERTIME;
    }
    //验证验证码
    String tmpSessionCode = session.getAttribute("verifycode").toString();
    if(!verifycode.equals(tmpSessionCode)){
        //验证码错误
        return VERIFYCODE_ERROR;
    }

    User user = userMapper.selectByEmail(email);
    password = CommunityUtils.md5(password + user.getSalt());
    userMapper.updatePassword(user.getId(),password);

    return VERIFYCODE_COORECT;
}
```

**LoginController**

```java
/**
 * 对验证码进行验证并修改密码
 * @param email
 * @param verifycode
 * @param password
 * @param session
 * @param model
 * @return
 */
@RequestMapping(value = "/reset",method = RequestMethod.POST)
public String resetPassword(String email,String verifycode,String password,
                            HttpSession session,Model model){
    int status = userService.resetPassword(email, verifycode, password, session);
    session.removeAttribute("verifycodeCreateTime");
    session.removeAttribute("verifycode");
    if(status==VERIFYCODE_OVERTIME){
        //失效失败
        model.addAttribute("verifycodeMsg","验证码已失效，请重新获取");
        return "/site/forget";
    }else if(status == VERIFYCODE_ERROR){
        //错误失败
        model.addAttribute("verifycodeMsg","验证码错误");
        return "/site/forget";
    }else{
        return "/site/login";
    }

}
```

**forget.html**

```html
<!-- 内容 -->
<div class="main">
    <div class="container pl-5 pr-5 pt-3 pb-3 mt-3 mb-3">
        <form class="mt-5" th:action="@{/reset}" method="post">
            <div class="form-group row">
                <label for="your-email" class="col-sm-2 col-form-label text-right">邮箱:</label>
                <div class="col-sm-10">
                    <input type="email" class="form-control" id="your-email" name="email"
                           onblur="javascript:isEmailValid();"
                           placeholder="请输入您的邮箱!" required>
                    <div class="invalid-feedback" id="emailvalid" th:text="${emailMsg}">
                        该邮
                    </div>
                </div>
            </div>
            <div class="form-group row mt-4">
                <label for="verifycode" class="col-sm-2 col-form-label text-right">验证码:</label>
                <div class="col-sm-6">
                    <input type="text" th:class="|form-control ${verifycodeMsg!=null?'is-invalid':''}|" id="verifycode" name="verifycode"
                           placeholder="请输入验证码!" required>
                    <div class="invalid-feedback" th:text="${verifycodeMsg}">
                        验证码不正确!
                    </div>
                </div>
                <div class="col-sm-4">
                    <a href="javascript:sendVerifycode();" class="btn btn-info form-control"
                       id="getVerifycode">
                        获取验证码
                    </a>
                </div>
            </div>	
            <div class="form-group row mt-4">
                <label for="your-password" class="col-sm-2 col-form-label text-right">新密码:</label>
                <div class="col-sm-10">
                    <input type="password" class="form-control" id="your-password" name="password"
                           placeholder="请输入新的密码!" required>
                    <div class="invalid-feedback">
                        密码长度不能小于8位!
                    </div>							
                </div>
            </div>							
            <div class="form-group row mt-4">
                <div class="col-sm-2"></div>
                <div class="col-sm-10 text-center">
                    <button type="submit" class="btn btn-info text-white form-control">重置密码</button>
                </div>
            </div>
        </form>				
    </div>
</div>
```



## 5.6 检查登录状态

用户在未登录的情况下，虽然看不到个人设置页面，但是他可以通过直接访问路径的方法来访问该页面。为了避免这个漏洞，我们需要增加一个拦截器方法来拦截这些请求



- 拦截器
  - 在方法前标注自定义注解
  - 拦截所有请求，只处理带该注解的方法
- 自定义注解
  - 常用元注解（创建自定义注解时需要）
    - @Target：在类、方法还是字段上作用
    - @Retention：编译时有效还是运行时有效
    - @Document：生成文档时显示该注解吗
    - @Inherited：当有类继承该类时，这个注解会被继承吗
  - 如何读取注解
    - Method.getDeclaredAnnotations()
    - Method.getAnnotation(Class<T\> annotationClass)

### 5.6.1 创建自定义注解

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface LoginRequired {
}
```

### 5.6.2 在需要拦截的方法上加注解

暂时需要在上传和设置页面加注解

### 5.6.3 创建检查登录状态拦截器

```java
@Component
public class LoginRequiredInterceptor implements HandlerInterceptor {

    @Autowired
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        if(handler instanceof HandlerMethod){//固定写法，从handler对象中获得是方法的那些
            HandlerMethod handlerMethod = (HandlerMethod) handler;
            Method method =  handlerMethod.getMethod();//获取方法
            LoginRequired loginRequired = method.getAnnotation(LoginRequired.class);//获取注解
            if(loginRequired != null && hostHolder.getValue() == null){
                //在需要登录的请求上没有用户登录过
                response.sendRedirect(request.getContextPath()+"/login");
                return false;
            }

        }
        return true;
    }
}
```

### 5.6.4 加入配置检查登录状态拦截器

在WebMvcConfig中进行配置，过滤静态资源



# 6 用户信息



## 6.1 显示用户信息

- 拦截器示例
  - 定义拦截器，实现HandlerInterceptor
  - 配置拦截器，指定拦截路径和排除路径
- 拦截器应用
  - 在请求开始时查询登录用户
  - 在本次请求中持有用户数据
  - 在模板视图上显示用户数据
  - 在请求结束时清理用户



<img src="https://raw.githubusercontent.com/LiMuwenan/PicBed/master/img/dev/java/project/nowcoder/login.png" style="zoom:67%;" />

这个流程是用户每次发送请求，都需要处理的一个过程，所以我们可以将这个过程放在拦截器中实现



### 6.5.1 创建拦截器

LoginTicketInterceptor

需要注意的几个问题：

- ThreadLocal处理用户进行多线程访问的问题

```java
@Component
public class LoginTicketInterceptor implements HandlerInterceptor {

    @Autowired
    private LoginTicketService loginTicketService;

    @Autowired
    private UserService userService;

    @Autowired
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //从cookie中取得凭证
        String ticket = CookieUtils.getValue(request,"ticket");

        if(ticket!=null){
            //有登录信息
            LoginTicket loginTicket = loginTicketService.selectByTicket(ticket);
            //检查凭证有效性
            if(loginTicket!=null && loginTicket.getStatus()==0 && loginTicket.getExpired().after(new Date())){
                //有效,根据凭证查询用户
                User user = userService.selectById(loginTicket.getUserId());
                //在本次请求中持有用户
                hostHolder.setValue(user);
            }
        }
        return true;
    }

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getValue();
        if(user!=null && modelAndView != null){
            modelAndView.addObject("loginUser",user);
        }
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        hostHolder.remove();
    }
}
```

### 6.5.2 创建Cookie工具

我们需要在上面的拦截器中使用Cookie，因为其中携带了用户的ticket，我们需要从中获取。但是HandlerInceptor的接口方法中没有cookie，所以我们可以创建一个cookie工具，方便我们从cookie中取值。这接口方法中有request，所以可以从这里取得cookie

```java
public class CookieUtils {

    /**
     * 通过key值从cookie中取得对应数据
     * @param request
     * @param key
     * @return 数据字符串
     */
    public static String getValue(HttpServletRequest request, String key ){
        //参数为空抛出异常
        if(request == null || key == null){
            throw new IllegalArgumentException("参数为空");
        }
        Cookie[] cookies = request.getCookies();
        if(cookies!=null){
            for (Cookie cookie:cookies) {
                if(cookie.getName().equals(key)){
                    return cookie.getValue();
                }
            }
        }
        return null;
    }
}
```

### 6.5.4 创建HostHolder

在浏览器访问服务器的过程中，是一个多对一的关系，每个用户访问浏览器，服务器都将启动一个线程，为了保证我们每个用户的线程数据安全，我们用 ThreadLocal类来处理线程问题。创建该类将用户的信息存放进去，避免了使用session时的线程问题

这个HostHolder在一次请求响应的过程 中是一直存在的

```java
/**
 * 持有用户信息，代替session对象，多线程安全
 */
@Component
public class HostHolder {

    private ThreadLocal<User>  users = new ThreadLocal<>();

    public void setValue(User user){
        users.set(user);
    }

    public User getValue(){
        return users.get();
    }

    public void remove(){
        users.remove();
    }
}
```

### 6.1.5 创建拦截器配置类

```java
/**
 * 拦截器配置类
 */
@Configuration
public class WebMvcConfig implements WebMvcConfigurer {

    @Autowired
    private LoginTicketInterceptor loginTicketInterceptor;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(loginTicketInterceptor)
                .excludePathPatterns("/**/*.js","/**/*.css","/**/*.png","/**/*.jpg","/**/*.jpeg");
    }
}
```

### 6.1.6 修改页面

用户信息我们在拦截器中使用`modelAndView.addObject("loginUser",user);`添加到了模板页面

index.html

需要注意的几个问题：

- 注册和登录按钮已经登录过就不显示
- 消息按钮没登录不会显示登录才显示
- 头像不会需要模板取值，如果loginUser为null，模板引擎会报错。如果在标签上面提前判断，例如如果为null就不显示该标签，则不会报错

```html
<!-- 头部 -->
<header class="bg-dark sticky-top" th:fragment="header">
    <div class="container">
        <!-- 导航 -->
        <nav class="navbar navbar-expand-lg navbar-dark">
            <!-- logo -->
            <a class="navbar-brand" href="#"></a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <!-- 功能 -->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item ml-3 btn-group-vertical">
                        <a class="nav-link" th:href="@{/index}">首页</a>
                    </li>
                    <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser!=null}">
                        <a class="nav-link position-relative" href="site/letter.html">消息<span class="badge badge-danger">12</span></a>
                    </li>
                    <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
                        <a class="nav-link" th:href="@{/register.html}">注册</a>
                    </li>
                    <li class="nav-item ml-3 btn-group-vertical" th:if="${loginUser==null}">
                        <a class="nav-link" th:href="@{/login.html}">登录</a>
                    </li>
                    <li class="nav-item ml-3 btn-group-vertical dropdown" th:if="${loginUser!=null}">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <img th:src="${loginUser.headerUrl:}" class="rounded-circle" style="width:30px;"/>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item text-center" th:href="@{/profile.html}">个人主页</a>
                            <a class="dropdown-item text-center" th:href="@{/setting.html}">账号设置</a>
                            <a class="dropdown-item text-center" th:href="@{/logout}">退出登录</a>
                            <div class="dropdown-divider"></div>
                            <span class="dropdown-item text-center text-secondary" th:utext="${loginUser.username}">nowcoder</span>
                        </div>
                    </li>
                </ul>
                <!-- 搜索 -->
                <form class="form-inline my-2 my-lg-0" action="site/search.html">
                    <input class="form-control mr-sm-2" type="search" aria-label="Search" />
                    <button class="btn btn-outline-light my-2 my-sm-0" type="submit">搜索</button>
                </form>
            </div>
        </nav>
    </div>
</header>
```

## 6.2 账号设置

- 上传文件
  - 请求：必须是post请求
  - 表单：enctype = "mutipart/form-data" 必须用这个属性
  - SpringMVC：通过 MutilpartFile 上传文件
- 开发流程
  - 访问账号设置页面
  - 上传头像
  - 获取头像

### 6.2.1 创建UserController

我们使用UserController来处理与用户有关的操作

需要注意的几个问题：

- 上传头像使用到的MutilpartFile属于SpringMVC框架中的类，所以我们直接在Controller中对它继续调用，而不是传入到service中进行操作，这样降低业务层和表现层的耦合性
- 注意判断文件名，文件类型，组合上传的文件在服务器中的保存路径，最终进行一个更新
- 头像请求，从服务器上获得文件输入流，然后用response输出流输出

```java
@Controller
@RequestMapping("/user")
public class UserController {

    private static final Logger logger = LoggerFactory.getLogger(UserController.class);

    @Value("${community.path.domain}")
    private String domain;

    @Value("${community.path.upload}")
    private String uploadPath;

    @Value("${server.servlet.context-path}")
    private String contextPath;

    @Autowired
    private UserService userService;

    @Autowired
    private HostHolder hostHolder;

    @RequestMapping(value = {"/setting","/setting.html"},method = RequestMethod.GET)
    public String getSettingPage(){

        return "/site/setting";
    }


    @RequestMapping(value = {"/profile","/profile.html"},method = RequestMethod.GET)
    public String getProfilePage(){

        return "/site/profile";
    }

    @RequestMapping(value = "/upload",method = RequestMethod.POST)
    public String upload(MultipartFile headerImage, Model model){
        //文件是否存在
        if(headerImage.isEmpty()){
            model.addAttribute("error","上传的文件不存在");
            return "/site/setting";
        }

        //提取文件名称
        String filename = headerImage.getOriginalFilename();
        if(StringUtils.isBlank(filename)){
            model.addAttribute("error","文件名不合法");
            return "/site/setting";
        }
        int dot = filename.lastIndexOf(".");
        if(dot==-1){//文件名没有后缀
            model.addAttribute("error","文件名不合法");
            return "/site/setting";
        }
        String suffix = filename.substring(dot) ;
        if(StringUtils.isBlank(suffix) || (!(".png".equalsIgnoreCase(suffix)) && !(".jpg".equalsIgnoreCase(suffix))&& !(".jpeg".equalsIgnoreCase(suffix)))){
            model.addAttribute("error","文件名不合法");
            return "/site/setting";
        }
        //文件名
        filename = CommunityUtils.generateUUID().substring(0,10) + suffix;
        //访问路径   http://localhost:8080/community/  user/header/xxx.png
        String headerPath = domain + contextPath + "/user/header/" + filename;
        File dest = new File(uploadPath + "/" + filename);//存放路径
        try {
            headerImage.transferTo(dest);//将上传的文件传入到File中，会直接保存到目标位置
        } catch (IOException e) {
            logger.error("上传文件失败" + e.getMessage());
            throw new RuntimeException("上传文件失败，服务器发生异常!",e);
        }

        //上传成功，进行设置
        User user = hostHolder.getValue();
        //这里没登陆上传设置会出错
        if(user==null){
            return "/index";
        }
        user.setHeaderUrl(headerPath);
        int status = userService.updateHeader(user.getId(), user.getHeaderUrl());
        if(status == 1){
            //更新成功
        }else{
            model.addAttribute("headerMsg","头像更新失败");
        }
        return "redirect:/index";
    }
    
        @RequestMapping(value = "/header/{filename}",method = RequestMethod.GET)
    public void getHeader(@PathVariable("filename") String filename, HttpServletResponse response){
        //服务器存放路径
        filename = uploadPath + "/" + filename;
        //文件后缀
        String suffix = filename.substring(filename.lastIndexOf("."));
        //响应图片
        response.setContentType("image/"+suffix.substring(1));//不要. 有可能出错
        try(
                FileInputStream fis = new FileInputStream(filename);
                OutputStream os = response.getOutputStream();
                ) {
            //图片可能比较大，我们采用按数据块输出
            byte[] buffer = new byte[1024];
            int b = 0;
            while((b = fis.read(buffer)) != -1){
                os.write(buffer,0,b);
            }
        } catch (FileNotFoundException e) {
            logger.error("读取头像失败"+e.getMessage());
        } catch (IOException e) {
            logger.error("输出头像失败"+e.getMessage());
        }

    }
}
```

### 6.2.2 修改设置页面

修改设置页面，获取上传失败等情况的信息

setting.html

需要注意的几个问题：

- 设置动态标签，获取错误信息
- form表单固定写法
- 上传文件框加入name属性

```html
<!-- 上传头像 -->
<h6 class="text-left text-info border-bottom pb-2">上传头像</h6>
<form class="mt-5" th:action="@{/user/upload}" method="post" enctype="multipart/form-data">
    <div class="form-group row mt-4">
        <label for="head-image" class="col-sm-2 col-form-label text-right">选择头像:</label>
        <div class="col-sm-10">
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="head-image" name="headerImage"
                       lang="es" required="">
                <label class="custom-file-label" for="head-image" data-browse="文件">选择一张图片</label>
            </div>
            <div style="color:red" th:if="${error!=null}" th:text="${error}">
                上传失败
            </div>
            <div style="color:red" th:if="${headerMsg!=null}" th:text="${headerMsg}">
                上传失败
            </div>

        </div>
    </div>
    <div class="form-group row mt-4">
        <div class="col-sm-2"></div>
        <div class="col-sm-10 text-center">
            <button type="submit" class="btn btn-info text-white form-control">立即上传</button>
        </div>
    </div>
</form>
```

### 6.2.3 修改密码

**在 UserService 中增加接口**

map用来携带错误信息返回给控制层

```java
/**
 * 在设置页面使用旧密码确认来修改密码
 * @param oldPassword
 * @param newPassword
 * @return
 */
Map<String,Object> resetPassword(String oldPassword, String newPassword);
```

**实现该接口**

```java
@Override
public Map<String, Object> resetPassword(String oldPassword, String newPassword) {
    Map<String,Object> map = new HashMap<>();
    if(StringUtils.isBlank(oldPassword)){
        map.put("oldPasswordMsg","旧密码不合法");
        return map;
    }
    if(StringUtils.isBlank(newPassword)){
        map.put("newPasswordMsg","新密码不合法");
        return map;
    }
    //从已登录的信息中拿到user
    User user = hostHolder.getValue();
    //密码错误
    if(!user.getPassword().equals(CommunityUtils.md5(oldPassword+user.getSalt()))){
        map.put("oldPasswordMsg","旧密码输入有误");
        return map;
    }

    //设置了新密码
    userMapper.updatePassword(user.getId(), CommunityUtils.md5(newPassword + user.getSalt()));

    return null;
}
```

**修改setting页面修改密码部分**

增加一些模板取值，动态class

还增加了 setting.js 用来判断两个新密码是否相同，这个js和register.js逻辑相同

```html
<!-- 修改密码 -->
<h6 class="text-left text-info border-bottom pb-2 mt-5">修改密码</h6>
<form class="mt-5" th:action="@{/user/reset}" method="post">
    <div class="form-group row mt-4">
        <label for="old-password" class="col-sm-2 col-form-label text-right">原密码:</label>
        <div class="col-sm-10">
            <input type="password" th:class="|form-control ${oldPasswordMsg!=null?'is-invalid':''}|"
                   id="old-password" name="oldPassword"
                   placeholder="请输入原始密码!" required>
            <div class="invalid-feedback" th:text="${oldPasswordMsg}">
                密码长度不能小于8位!
            </div>							
        </div>
    </div>
    <div class="form-group row mt-4">
        <label for="new-password" class="col-sm-2 col-form-label text-right">新密码:</label>
        <div class="col-sm-10">
            <input type="password" th:class="|form-control ${newPasswordMsg!=null?'is-invalid':''}|"
                   id="new-password" name="newPassword"
                   placeholder="请输入新的密码!" required>
            <div class="invalid-feedback" th:text="${newPasswordMsg}">
                密码长度不能小于8位!
            </div>							
        </div>
    </div>
    <div class="form-group row mt-4">
        <label for="confirm-password" class="col-sm-2 col-form-label text-right">确认密码:</label>
        <div class="col-sm-10">
            <input type="password" class="form-control" id="confirm-password" placeholder="再次输入新密码!" required>
            <div class="invalid-feedback">
                两次输入的密码不一致!
            </div>								
        </div>
    </div>				
    <div class="form-group row mt-4">
        <div class="col-sm-2"></div>
        <div class="col-sm-10 text-center">
            <button type="submit" class="btn btn-info text-white form-control">立即保存</button>
        </div>
    </div>
</form>				
</div>
</div>
```





# 7 发帖

## 7.1 过滤敏感词

- 前缀树
  - 名称：Trie、字典树、查找树
  - 特点：查找效率高、内存消耗大
  - 应用：字符串检索、词频统计、字符串排序

- 敏感词过滤
  - 定义前缀树
  - 根据敏感词初始化前缀树
  - 编写过滤敏感词的方法

过滤敏感词方法可能用经常重用，所以我们直接创建一个工具类，并且写上@Component组件使Springboot为我们自动注入

```java
/**
 * 敏感词过滤器
 */
@Component
public class SensitiveFilter {

}
```

### 7.1.1 前缀树

下面是前缀树的节点定义，因为是n叉树，所以使用map作为孩子节点的定义

```java
//前缀树
private class TrieNode{
    //关键词结束标记，是末尾
    private boolean isKeywordEnd =true;

    //孩子节点
    private Map<Character,TrieNode> childNodes = new HashMap<>();

    public boolean isKeywordEnd(){
        return this.isKeywordEnd;
    }

    public void setKeywordEnd(boolean keywordEnd){
        this.isKeywordEnd = keywordEnd;
    }

    //添加子节点
    public void addSubNode(Character c,TrieNode node){
        childNodes.put(c,node);
    }

    //获取子节点
    public TrieNode getSubNode(Character c){
        return childNodes.get(c);
    }
}
```
### 7.1.2 初始化前缀树

在resources文件夹下创建txt文件保存所有的敏感词，然后将其挨个加入到前缀树中

需要注意的几个问题：

- @PostConstruct注解可以使该方法在构造器之后立即执行
- 为了读取快速，我们将字节流转为字符流，又从字符流转为缓冲流
- 从类路径下读取文件的方式

```java
private static final Logger logger = LoggerFactory.getLogger(SensitiveFilter.class);

//替换符
private static final String REPLEACEMENT = "***";

private TrieNode root = new TrieNode();

//该注解意思是：该方法在构造器执行后就会被执行
//系统启动Filter类被加入容器初始化，同时会构造TrieNode，构造完后调用init
@PostConstruct
public void init(){

    try(
            InputStream fis = this.getClass().getClassLoader().getResourceAsStream("sensitive-words.txt");
            //字节流转字符流，字符流转缓冲流
            BufferedReader reader = new BufferedReader(new InputStreamReader(fis));
            ){
            String keyword;
            while((keyword = reader.readLine() )!=null){
                //添加到前缀树
                this.addKeyword(keyword);
            }
    }catch(IOException e){
        logger.error("敏感词文件读取失败"+e.getMessage());
    }

}

//将一个敏感词添加到前缀树中
private void addKeyword(String keyword){
    TrieNode tmpNode = root;
    for (int i = 0; i < keyword.length(); i++) {
        char c = keyword.charAt(i);
        TrieNode subNode = tmpNode.getSubNode(c);
        if(subNode == null){
            subNode = new TrieNode();
            tmpNode.addSubNode(c,subNode);

            //默认都是尾部，当有孩子节点被加入，则设置为false，不是尾部
            tmpNode.setKeywordEnd(false);
        }

        tmpNode = subNode;
    }
}
```

### 7.1.3 过滤实现

过滤的过程有点像kmp，不过我没有使用回溯

如果是敏感词，则打成星号，如果不是敏感词就直接过去了，虽然是双层循环，时间复杂度依旧是O(n)

判断敏感词时，同时判断这些敏感词是否被特殊字符分开，如果是特殊字符则跳过处理

```java
/**
 * 过滤敏感词
 * @param text 待过滤文本
 * @return 过滤后的文本
 */
public String filter(String text){
    if(StringUtils.isBlank(text)){
        return null;
    }
    //指针1，指向前缀树的节点
    TrieNode node = root;//开始在根节点
    //指针2，3，用来遍历字符串
    int begin = 0,index = 0;
    //过滤结果
    StringBuilder sb = new StringBuilder();
    //遍历字符串过滤
    for (int i = 0; i < text.length(); i++) {
        char c = text.charAt(i);
        sb.append(c);
        if(isSymbol(c)){
            //是特殊字符，直接跳过
            continue;
        }
        TrieNode tmpNode = node.getSubNode(c);
        begin = i;
        for(index = begin+1;index<text.length()&&tmpNode!=null;index++){
            if(isSymbol(text.charAt(index))){
                //是特殊字符，直接跳过
                continue;
            }
            tmpNode = tmpNode.getSubNode(text.charAt(index));
            if(tmpNode!=null && tmpNode.isKeywordEnd()){
                sb.deleteCharAt(sb.length()-1);
                sb.append(REPLEACEMENT);
                node = root;
                i=index;
                break;
            }
        }

    }

    return sb.toString();
}

/**
 * 判断是否为特殊符号（用户可能通过特殊符号规避敏感词过滤）
 * @param c
 * @return
 */
private boolean isSymbol(Character c){
    //是不是Ascii码字符，
    //0x2E80--0x9FFF 该范围是东亚文字范围
    return !CharUtils.isAsciiAlphanumeric(c);
}
```

## 7.2 发帖

- AJAX
  - Asynchronous JavaScript and XML
  - 异步的JavaScript与XML，不是新的技术，是新的术语
  - 使用AJAX可以动态刷新网页，而不需要刷新整个页面
  - 使用X代表XML，但是JSON目前更加普遍
- 示例
  - 使用jQuery发送AJAX请求
- 实践
  - 使用AJAX请求，实现发布帖子的功能



### 7.2.1 创建JSON格式工具

导入依赖

```xml
<!-- https://mvnrepository.com/artifact/com.alibaba/fastjson -->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.75</version>
</dependency>
```

使用到了fastjson工具

```java
/**
 * 将内容转化为json字符串
 * @param code 状态码
 * @param msg 消息
 * @param map 对象
 * @return
 */
public static String getJSONString(int code, String msg, Map<String,Object> map){
    JSONObject json = new JSONObject();
    json.put("code",code);
    json.put("msg",msg);
    if(map!=null){
        for(String key:map.keySet()){
            json.put(key,map.get(key));
        }
    }
    return json.toJSONString();
}

public static String getJSONString(int code, String msg){
   return getJSONString(code,msg,null);
}

public static String getJSONString(int code){
    return getJSONString(code,null,null);
}
```

### 7.2.3 数据层接口与实现

在DiscussPostMapper接口中新增接口

```java
 /**
 * 插入一条帖子信息
 * @param discussPost
 * @return
 */
int insertDiscussPost(DiscussPost discussPost);
```

在DiscussPostMapper.xml中实现接口

```java
<insert id="insertDiscussPost" parameterType="DiscussPost" keyProperty="id">
    insert into discuss_post (<include refid="insertFields"></include>)
    value (#{userId},#{title},#{content},#{type},#{status},#{createTime},#{commentCount},#{score});
</insert>
```

### 7.2.4 业务层接口与实现

省略接口定义

在DiscussPostServiceImpl中实现接口

需要注意的问题：

- 为了防止前端注入攻击，所以要使用工具类将HTML标签转义。这里使用的转义工具是SpringMVC提供的

```java
@Override
public int insertDiscussPost(DiscussPost discussPost) {
    if(discussPost==null){
        throw new IllegalArgumentException("参数不能为空");
    }

    //过滤HTML标签（注入风险）
    discussPost.setTitle(HtmlUtils.htmlEscape(discussPost.getTitle()));
    discussPost.setContent(HtmlUtils.htmlEscape(discussPost.getContent()));

    //过滤敏感词
    discussPost.setTitle(sensitiveFilter.filter(discussPost.getTitle()));
    discussPost.setContent(sensitiveFilter.filter(discussPost.getTitle()));

    return discussPostMapper.insertDiscussPost(discussPost);
}
```

### 7.2.5 表现层DiscussPostController

```java
@Controller
@RequestMapping("/discuss")
public class DiscussPostController {

    @Autowired
    private DiscussPostService discussPostService;

    @Autowired
    private HostHolder hostHolder;

    /**
     * 响应ajax请求，获取用户发布的帖子并插入数据库
     * @param content
     * @param title
     * @return
     */
    @RequestMapping(value = {"/add"},method = RequestMethod.POST)
    @ResponseBody
    public String addDiscussPost(String content,String title){
        User user = hostHolder.getValue();
        if(user==null){
            return CommunityUtils.getJSONString(403,"您还没有进行登录");
        }
        DiscussPost discussPost = new DiscussPost();
        discussPost.setUserId(user.getId());
        discussPost.setContent(content);
        discussPost.setTitle(title);
        discussPost.setCreateTime(new Date());

        discussPostService.insertDiscussPost(discussPost);
        //默认处理成功，报错情况将来统一处理

        return CommunityUtils.getJSONString(0,"发布成功");
    }

}
```



## 7.3 帖子详情

如果需要从首页查看一个帖子，帖子详情页面会有显示发贴用户，发帖时间，发帖内容，发帖标题，点赞回复数量，回复内容等

这里先将帖子标题内容时间用户展现出来

### 7.3.1 数据层接口与实现

我们需要根据帖子的id查到帖子的所有信息，同时关联到发贴用户。这里可以两个表联查，效率较高，实现复杂；先查帖子再查用户也可以，后面可以用redis优化

**在DiscussPostMapper中增加新接口**

```java
/**
 * 查询某一条帖子的具体信息
 * @param id 帖子id
 * @return
 */
DiscussPost selectDiscussPost(int id);
```

**在DiscussPostMapper.xml中实现该接口**

```xml
<select id="selectDiscussPost" resultType="com.edu.ligen.nowcoder.entity.DiscussPost">
    select <include refid="selectFields"></include>
    from discuss_post
    where id = #{id}
</select>
```

### 7.3.2 业务层接口与实现

这里简化记录，实现方法

直接返回，在controller中进行处理

```java
@Override
public DiscussPost selectDiscussPost(int id) {
    return discussPostMapper.selectDiscussPost(id);
}
```

### 7.3.3 表现层

前端使用RESTful风格传参，通过该id查找DiscussPost，再根据userId查找到user，一起返回到前端

```java
@RequestMapping(value = {"/detail/{discussPostId}"},method = RequestMethod.GET)
public String getDiscussPostDetail(Model model, @PathVariable("discussPostId") int postId){
    //根据路径传回的帖子id查询帖子相关
    DiscussPost post = discussPostService.selectDiscussPost(postId);
    if(post==null){
        model.addAttribute("msg","您查看的帖子可能已经被删除或者存在违规");
        model.addAttribute("target","/index");
    }else{
        User user = userService.selectById(post.getUserId());
        model.addAttribute("user",user);
        model.addAttribute("post",post);
    }
    
    return "site/discuss-detail";
}
```



### 7.3.4 显示评论

- 数据层
  - 根据实体查询一页评论数据
  - 根据实体查询评论数量
- 业务层
  - 处理查询评论的业务
  - 处理查询评论数量的业务
- 表现层
  - 显示帖子详情数据同时显示该帖子所有评论数据



**评论表**

```mysql
--
-- Table structure for table `comment`
--

DROP TABLE IF EXISTS `comment`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `comment` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) DEFAULT NULL,
  `entity_type` int(11) DEFAULT NULL, # 什么类型的评论（给视频？课程？帖子？帖子下的回复？）
  `entity_id` int(11) DEFAULT NULL, # 该类型的id
  `target_id` int(11) DEFAULT NULL,
  `content` text,
  `status` int(11) DEFAULT NULL,
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_user_id` (`user_id`) /*!80000 INVISIBLE */,
  KEY `index_entity_id` (`entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;


```

**根据上面的表新建实体类**

```java
public class Comment {
    private int id;
    private int userId;
    private int entityType;
    private int entityId;
    private int targetId;//指向性回复，给谁回复的
    private String content;
    private int status;//0普通 1精华 2拉黑
    private Date createTime;
}
```

**数据层接口与实现**

新建CommentMapper接口

```java
@Mapper
public interface CommentMapper {

    /**
     * 根据实体类型查询到所有帖子
     * @param entityType 实体类型：课程、帖子、用户评论
     * @param offset 偏置
     * @param limit 分页
     * @return
     */
    List<Comment> selectCommentsByEntity(int entityType,int entityId ,int offset,int limit);

    /**
     * 根据评论类型查询总共有多少条评论
     * @param entityType 实体类型
     * @param entityId
     * @return
     */
    int selectCommentRows(int entityType,int entityId);
}
```

新建CommentMapper.xml实现上面的接口

```java
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--通过namespace唯一指定语句-->
<mapper namespace="com.edu.ligen.nowcoder.dao.CommentMapper">

    <sql id="selectFields">
        id,user_id,entity_type,entity_id,target_id,content,status,create_time
    </sql>

    <select id="selectCommentsByEntity" resultType="Comment">
        select <include refid="selectFields"></include>
        from comment
        where status=0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
        order by create_time asc
        limit #{offset},#{limit};
    </select>

    <select id="selectCommentRows" resultType="int">
        select COUNT(id)
        from comment
        where status=0
        and entity_type = #{entityType}
        and entity_id = #{entityId}
    </select>

</mapper>
```

**业务层接口与实现**

新建CommentService接口

```java
public interface CommentService {

    /**
     * 根据实体类型查询到所有帖子
     * @param entityType 实体类型：课程、帖子、用户评论
     * @param offset 偏置
     * @param limit 分页
     * @return
     */
    List<Comment> selectCommentsByEntity(int entityType, int entityId , int offset, int limit);

    /**
     * 根据评论类型查询总共有多少条评论
     * @param entityType 实体类型
     * @param entityId 该类型的id
     * @return
     */
    int selectCommentRows(int entityType,int entityId);
}
```

新建实现类CommentServiceImpl

```java
@Service
public class CommentServiceImpl implements CommentService {

    @Autowired
    private CommentMapper commentMapper;
    
    @Override
    public List<Comment> selectCommentsByEntity(int entityType, int entityId, int offset, int limit) {
        return commentMapper.selectCommentsByEntity(entityType, entityId, offset, limit);
    }
    
    @Override
    public int selectCommentRows(int entityType, int entityId) {
        return commentMapper.selectCommentRows(entityType, entityId);
    }

}
```

**表现层**

需要注意的几个问题：

- 帖子的评论需要分页
- 查找帖子评论所需要的帖子id可以从帖子实体类中取到
- 先查找帖子的评论，再查找评论的评论（回复），对每条评论都要进行回复的查找。回复不需要分页，所以都查询出来（前端显示可以设置折叠），使用Integer.MAX_VALUE作为分页条件



对[7.2.5 表现层DiscussPostController](# 7.2.5 表现层DiscussPostController)的getDiscussPostDetail方法增加一些内容，用来显示评论

```java
@Autowired
private CommentService commentService;

@RequestMapping(value = {"/detail/{discussPostId}"},method = RequestMethod.GET)
    public String getDiscussPostDetail(Model model, @PathVariable("discussPostId") int postId, Page page){
        //根据路径传回的帖子id查询帖子相关
        DiscussPost post = discussPostService.selectDiscussPost(postId);
        if(post==null){
            model.addAttribute("msg","您查看的帖子可能已经被删除或者存在违规");
            model.addAttribute("target","/index");
        }else{
            //作者
            User user = userService.selectById(post.getUserId());
            model.addAttribute("user",user);
            model.addAttribute("post",post);

            //分页信息
            page.setLimit(5);//每页5个评论
            page.setPath("/discuss/detail/"+postId);//页码对应路径
            page.setRows(post.getCommentCount());//总共评论数
            //查找帖子的评论
            List<Comment> commentList = commentService.selectCommentsByEntity(ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());
            //Vo View Object ，用来显示到页面的对象
            List<Map<String,Object>> commentVoList = new ArrayList<>();
            if(commentList!=null){
                //对每条评论进行操作
                for (Comment comment : commentList) {
                    Map<String,Object> commentVo = new HashMap<>();
                    commentVo.put("comment",comment);
                    //页面还要展示用户的信息，评论里只有用户id，所以需要查询出来
                    commentVo.put("user",userService.selectById(comment.getUserId()));

                    //查询回复的列表
                    List<Comment> replyList = commentService.selectCommentsByEntity(ENTITY_TYPE_COMMENT, comment.getId(), 0, Integer.MAX_VALUE);
                    //回复的Vo列表
                    List<Map<String,Object>> replyVoList = new ArrayList<>();
                    if(replyList!=null){
                        for (Comment reply : replyList) {
                            Map<String,Object> replyVo = new HashMap<>();
                            replyVo.put("reply",reply);
                            replyVo.put("user",userService.selectById(reply.getUserId()));
                            //指向性回复
                            User target = reply.getTargetId() == 0 ? null : userService.selectById(reply.getTargetId());
                            replyVo.put("target",target);

                            replyVoList.add(replyVo);
                        }
                    }
                    commentVo.put("replyVo",replyVoList);

                    //查询到评论下的回复数量
                    int replyCount = commentService.selectCommentRows(ENTITY_TYPE_COMMENT, comment.getId());
                    commentVo.put("replyCount",replyCount);

                    commentVoList.add(commentVo);
                }
            }
            model.addAttribute("commentVo",commentVoList);
        }

        return "site/discuss-detail";
    }
```



**修改页面**

在[2.3 访问首页](# 2.3 访问首页)中我们只做了帖子的遍历，并没有设置显示帖子的回帖数量，在这一节我们加上

```html
<li class="d-inline ml-2">回帖 <span th:text="${map.post.commentCount}">7</span></li>
```

然后修改帖子详情页面，这里要修改的地方比较多

需要注意的几个问题：

- 帖子回复数量
- 回帖列表、其中的时间，用户名、头像、楼层数
- 回复列表、其中的时间，XXX回复XXX。回复按钮展开回复对象，这里是按照id将回复框和回复按钮绑定
- 分页功能，直接复用首页分页

```html
<!-- 回帖 -->
<div class="container mt-3">
   <!-- 回帖数量 -->
   <div class="row">
      <div class="col-8">
         <h6><b class="square"></b> <i th:text="${post.commentCount}">30</i>条回帖</h6>
      </div>
      <div class="col-4 text-right">
         <a href="#replyform" class="btn btn-primary btn-sm">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</a>
      </div>
   </div>
   <!-- 回帖列表 -->
   <ul class="list-unstyled mt-4">
      <!-- 第1条回帖 -->
      <li class="media pb-3 pt-3 mb-3 border-bottom" th:each="commentMap,status:${comments}">
         <a href="profile.html">
            <img th:src="${commentMap.user.headerUrl}" class="align-self-start mr-4 rounded-circle user-header" alt="用户头像" >
         </a>
         <div class="media-body">
            <div class="mt-0">
               <span class="font-size-12 text-success" th:utext="${commentMap.user.username}">掉脑袋切切</span>
               <span class="badge badge-secondary float-right floor">
                  <i th:text="${page.getOffset+status.count}">1</i>#
               </span>
            </div>
            <div class="mt-2" th:utext="${commentMap.comment.content}">
               这开课时间是不是有点晚啊。。。
            </div>
            <div class="mt-4 text-muted font-size-12">
               <span>发布于 <b th:text="${#dates.format(commentMap.comment.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</b></span>
               <ul class="d-inline float-right">
                  <li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
                  <li class="d-inline ml-2">|</li>
                  <li class="d-inline ml-2"><a href="#" class="text-primary">回复( <span th:text="${commentMap.replyCount}">0</span> )</a></li>
               </ul>
            </div>
            <!-- 回复列表 -->
            <ul class="list-unstyled mt-4 bg-gray p-3 font-size-12 text-muted">
               <!-- 第1条回复 -->
               <li class="pb-3 pt-3 mb-3 border-bottom" th:each="reply,replyStatus:${commentMap.replyVo}">
                  <div>
                     <span th:if="${reply.target==null}">
                        <b class="text-info" th:utext="${reply.user.username}">寒江雪</b>:&nbsp;&nbsp;
                     </span>
                     <span th:if="${reply.target!=null}">
                        <b class="text-info" th:utext="${reply.user.username}">sissi</b>回复
                        <b class="text-info" th:utext="${reply.target.username}">寒江雪</b>:&nbsp;&nbsp;
                     </span>
                     <span th:utext="${reply.reply.content}">这个是直播时间哈，觉得晚的话可以直接看之前的完整录播的~</span>
                  </div>
                  <div class="mt-3">
                     <span th:text="${#dates.format(reply.reply.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 15:32:18</span>
                     <ul class="d-inline float-right">
                        <li class="d-inline ml-2"><a href="#" class="text-primary">赞(1)</a></li>
                        <li class="d-inline ml-2">|</li>
                        <li class="d-inline ml-2"><a th:href="|#huifu-${replyStatus.count}|" data-toggle="collapse" class="text-primary">回复</a></li>
                     </ul>
                     <div th:id="|huifu-${replyStatus.count}|" class="mt-4 collapse">
                        <div>
                           <input type="text" class="input-size" th:placeholder="|回复${reply.user.username}|"/>
                        </div>
                        <div class="text-right mt-2">
                           <button type="button" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
                        </div>                            
                     </div>
                  </div>                      
               </li>
               <!-- 回复输入框 -->
               <li class="pb-3 pt-3">
                  <div>
                     <input type="text" class="input-size" placeholder="请输入你的观点"/>
                  </div>
                  <div class="text-right mt-2">
                     <button type="button" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
                  </div>
               </li>
            </ul>
         </div>
      </li>
   </ul>
   <!-- 分页 -->
   <nav class="mt-5" th:replace="index::pageNavigation">
      <ul class="pagination justify-content-center">
         <li class="page-item"><a class="page-link" href="#">首页</a></li>
         <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
         <li class="page-item active"><a class="page-link" href="#">1</a></li>
         <li class="page-item"><a class="page-link" href="#">2</a></li>
         <li class="page-item"><a class="page-link" href="#">3</a></li>
         <li class="page-item"><a class="page-link" href="#">4</a></li>
         <li class="page-item"><a class="page-link" href="#">5</a></li>
         <li class="page-item"><a class="page-link" href="#">下一页</a></li>
         <li class="page-item"><a class="page-link" href="#">末页</a></li>
      </ul>
   </nav>       
</div>
```



### 7.3.5 添加评论

- 数据层
  - 增加评论数据
  - 修改帖子的评论数量
- 业务层
  - 处理添加评论业务
  - 先增加评论、再更新帖子的评论数量
- 表现层
  - 处理添加评论数据的请求
  - 设置添加评论的表单

**数据层接口与实现**

CommentMapper中增加添加评论接口

```java
/**
 * 添加评论
 * @param comment
 * @return
 */
int insertComment(Comment comment);
```

在xml中实现

```xml
<insert id="insertComment">
    insert into comment(<include refid="insertFields"></include> )
    values(#{userId},#{entityType},#{entityId},#{targetId},#{content},#{status},#{createTime});
</insert>
```

因为插入一条评论之后还需要更改该帖子中评论总数的信息，所以还需要在DiscussPostMapper中增加新的接口

```java
/**
 * 添加评论后，更新该帖子的评论数量
 * @param id
 * @param commentCount
 * @return
 */
int updateCommentCount(int id,int commentCount);
```

在xml中实现

```xml
<update id="updateCommentCount" >
    update discuss_post set comment_count = #{commentCount} where id = #{id}
</update>
```

**业务层接口与实现**

在数据层我们在DiscussPostMapper中新增了接口，所以在业务层也需要添加相对应的接口

```java
/**
 * 添加评论后，更新该帖子的评论数量
 * @param id
 * @param commentCount
 * @return
 */
int updateCommentCount(int id,int commentCount);
```

实现该接口

```java
@Override
public int updateCommentCount(int id, int commentCount) {
    return discussPostMapper.updateCommentCount(id,commentCount);
}
```

有了这个业务方法则可以完成添加评论

[事务管理](..\..\..\MySQL\MySQL必知必会笔记.md\# 26 管理事务处理)

[代码编写方式](..\..\..\JAVA\Spring\Spring入门)

注意几个问题：

- 评论为空不能添加
- 对内容进行过滤
- 用到事务管理

```java
@Override
@Transactional(isolation = Isolation.READ_COMMITTED,propagation = Propagation.REQUIRED)
public int insertComment(Comment comment) {
    if(comment==null){
        throw new IllegalArgumentException("参数不能为空");
    }
    //添加评论，过滤敏感词,过滤标签
    comment.setContent(sensitiveFilter.filter(comment.getContent()));
    comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));
    int rows = commentMapper.insertComment(comment);

    //如果添加的不是回复还要更新帖子统计的评论数
    if(comment.getEntityType()==ENTITY_TYPE_POST){
        int count = commentMapper.selectCommentRows(comment.getEntityType(), comment.getEntityId());
        discussPostService.updateCommentCount(comment.getEntityId(),count);
    }

    return rows;
}
```

**表现层**

新增CommentController

使用post请求，路径带上帖子的id

```java
@Controller
@RequestMapping("/comment")
public class CommentController {

    @Autowired
    private CommentService commentService;

    @Autowired
    private HostHolder hostHolder;

    @RequestMapping(value = "/add/{discussPostId}",method = RequestMethod.POST)
    public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment){
        User user = hostHolder.getValue();
        //user可能为null，后面统一处理
        comment.setUserId(user.getId());
        comment.setStatus(0);
        comment.setCreateTime(new Date());
        commentService.insertComment(comment);

        return "redirect:/discuss/detail/" + discussPostId;
    }
}
```

修改页面

对帖子进行回复

- 添加表单请求路径和方法
- 添加两个隐藏域进行实体类型和id传值，对哪条帖子回复

```html
<!-- 回帖输入 -->
<div class="container mt-3">
   <form class="replyform" method="post" th:action="@{|/comment/add/${post.id}|}">
      <p class="mt-3">
         <a name="replyform"></a>
         <textarea placeholder="在这里畅所欲言你的看法吧!" name="content"></textarea>
         <input type="hidden" name="entityType" value="1">
         <input type="hidden" name="entityId" th:value="${post.id}">
      </p>
      <p class="text-right">
         <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;帖&nbsp;&nbsp;</button>
      </p>
   </form>
</div>
```

对评论的回复

- 实体类型和上面的不同

```html
<!-- 回复输入框 -->
<li class="pb-3 pt-3">
   <form method="post" th:action="@{|/comment/add/${post.id}|}">
      <div>
         <input type="text" class="input-size" name="content" placeholder="请输入你的观点"/>
         <input type="hidden" name="entityType" value="2">
         <input type="hidden" name="entityId" th:value="${commentMap.comment.id}">
      </div>
      <div class="text-right mt-2">
         <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
      </div>
   </form>
</li>
```

对回复的回复

- 再增加一个targetId来保存是给哪条回复的回复

```html
<form method="post" th:action="@{|/comment/add/${post.id}|}">
   <div th:id="|huifu-${replyStatus.count}|" class="mt-4 collapse">
      <div>
         <input type="text" class="input-size" name="content" th:placeholder="|回复${reply.user.username}|"/>
         <input type="hidden" name="entityType" value="2">
         <input type="hidden" name="entityId" th:value="${commentMap.comment.id}">
         <input type="hidden" name="targetId" th:value="${reply.user.id}">
      </div>
      <div class="text-right mt-2">
         <button type="submit" class="btn btn-primary btn-sm" onclick="#">&nbsp;&nbsp;回&nbsp;&nbsp;复&nbsp;&nbsp;</button>
      </div>
   </div>
</form>
```



# 8 私信

## 8.1 私信列表

- 私信列表
  - 查询当前用户的会话列表
  - 每个会话只显示一条最新的私信
  - 支持分页显示
- 私信详情
  - 查询某个会话所包含的私信
  - 支持分页显示

### 8.1.1 私信消息表

--
-- Table structure for table `message`
--

```sql
DROP TABLE IF EXISTS `message`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
 SET character_set_client = utf8mb4 ;
CREATE TABLE `message` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `from_id` int(11) DEFAULT NULL,
  `to_id` int(11) DEFAULT NULL,
  `conversation_id` varchar(45) NOT NULL,
  `content` text,
  `status` int(11) DEFAULT NULL COMMENT '0-未读;1-已读;2-删除;',
  `create_time` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `index_from_id` (`from_id`),
  KEY `index_to_id` (`to_id`),
  KEY `index_conversation_id` (`conversation_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
```

### 8.1.2 实体类

```java
public class Message {

    private int id;
    private int fromId;//1代表系统消息
    private int toId;
    private String conversationId;
    private String content;
    private int status;//0-未读;1-已读;2-删除
    private Date createTime;
}
```

### 8.1.3 数据层接口与实现

MessageMapper

需要注意的几个问题：

- 我们需要查询到私信的内容并显示最后一条消息，还需要查询当前在一个会话中有多少未读消息
- 当我们指定了会话id则查询该会话的未读消息，没有指定id则查询所有的消息

```java
@Mapper
public interface MessageMapper {

    /**
     * 查询当前用户的会话列表，每条会话只显示一条最新的消息
     * @param userId
     * @param offset
     * @param limit
     * @return
     */
    List<Message> selectConversations(int userId,int offset,int limit);

    /**
     * 查询用户当前会话数量
     * @param userId
     * @return
     */
    int selectConversationCount(int userId);

    /**
     * 查询某个会话中的消息
     * @param conversationId
     * @param offset
     * @param limit
     * @return
     */
    List<Message> selectLettersByConversationId(String conversationId,int offset,int limit);

    /**
     * 查询某个会话中的消息数量
     * @param conversationId
     * @return
     */
    int selectLetterCount(String conversationId);

    /**
     * 查询某个会话的未读消息数量
     * @param userId
     * @param conversationId
     * @return
     */
    int selectLetterUnreadCount(int userId,String conversationId);
}
```

MessageMapper.xml

需要注意的几个问题：

- 利用子查询。id最大代表是最新的消息，fromid=1是系统消息，对会话按照conversation进行分组，然后找到最大的id则是用户的最新消息。然后在这个id中查询到所有的消息展现在每个会话的列表上
- 按照conversationid分组，筛选出当前用户参与的会话，就得到所有会话数量
- 新的消息显示在前面
- 

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.edu.ligen.nowcoder.dao.MessageMapper">

    <sql id="selectFields">
        id,from_id,to_id,conversation_id,content,status,create_time
    </sql>

    <sql id="insertFields">
        from_id,to_id,conversation_id,content,status,create_time
    </sql>

    <select id="selectConversations" resultType="Message">
        select <include refid="selectFields"></include> from message
        where id in (
            select MAX(id) from message
            where from_id !=1 and status !=2
            and ( from_id = #{userId} or to_id = #{userId})
            group by conversation_id
        )
        order by id desc
        limit #{offset},#{limit}

    </select>
    
    <select id="selectConversationCount">
        select COUNT(distinct conversation_id) from message
        where status!=2 and from_id !=1 
        and (from_id = #{userId} or to_id = #{userId})
    </select>
    
    <select id="selectLettersByConversationId" resultType="Message">
        select <include refid="selectFields"></include> from message
        where status!=2 and from_id !=1 and conversation_id = #{conversationId}
        order by id desc 
        limit #{offset},#{limit}
    </select>
        <select id="selectLetterCount">
        select COUNT(id) from message
        where status!=2 and from_id !=1 and conversation_id = #{conversationId}
    </select>
    
    <select id="selectLetterUnreadCount">
        select COUNT(id) from message
        where status=0
        and from_id!=1
        and to_id = #{userId}
        <if test="conversationId!=null">
            and conversation_id = #{conversationId}
        </if>
    </select>

</mapper>
```

### 8.1.4 业务层接口与实现

MessageService接口

```java
public interface MessageService {
    /**
     * 查询当前用户的会话列表，每条会话只显示一条最新的消息
     * @param userId
     * @param offset
     * @param limit
     * @return
     */
    List<Message> selectConversations(int userId, int offset, int limit);

    /**
     * 查询用户当前会话数量
     * @param userId
     * @return
     */
    int selectConversationCount(int userId);

    /**
     * 查询某个会话中的消息
     * @param conversationId
     * @param offset
     * @param limit
     * @return
     */
    List<Message> selectLettersByConversationId(String conversationId,int offset,int limit);

    /**
     * 查询某个会话中的消息数量
     * @param conversationId
     * @return
     */
    int selectLetterCount(String conversationId);

    /**
     * 查询某个会话的未读消息数量
     * @param userId
     * @param conversationId
     * @return
     */
    int selectLetterUnreadCount(int userId,String conversationId);
}
```

MessageServiceImpl

```java
@Service
public class MessageServiceImpl implements MessageService {

    @Autowired
    private MessageMapper messageMapper;


    @Override
    public List<Message> selectConversations(int userId, int offset, int limit) {
        return messageMapper.selectConversations(userId, offset, limit);
    }

    @Override
    public int selectConversationCount(int userId) {
        return messageMapper.selectConversationCount(userId);
    }

    @Override
    public List<Message> selectLettersByConversationId(String conversationId, int offset, int limit) {
        return messageMapper.selectLettersByConversationId(conversationId, offset, limit);
    }

    @Override
    public int selectLetterCount(String conversationId) {
        return messageMapper.selectLetterCount(conversationId);
    }

    @Override
    public int selectLetterUnreadCount(int userId, String conversationId) {
        return messageMapper.selectLetterUnreadCount(userId, conversationId);
    }
}
```

### 8.1.5 表现层

需要注意的几个问题：

- 当前用户和某人的对话，这个人的id有可能在from中，也有可能在to中，这个要做一个判断
- 会话id可以直接从message中取出
- 页面修改用户名时间会话数等等

```java
@Controller
public class MessageController {

    @Autowired
    private MessageService messageService;

    @Autowired
    private UserService userService;

    @Autowired
    private HostHolder hostHolder;

    @RequestMapping(value = {"/letter/list"},method = RequestMethod.GET)
    @LoginRequired
    public String getLetterList(Model model, Page page){
        //获取当前用户
        User user = hostHolder.getValue();
        if(user==null){
            //转到首页登录
            return "redirect:/site/login";
        }
        //分页设置
        page.setPath("/letter/list");
        page.setRows(messageService.selectConversationCount(user.getId()));
        page.setLimit(5);

        List<Message> messageList = messageService.selectConversations(user.getId(),page.getOffset(), page.getLimit());
        List<Map<String,Object>> conversations = new ArrayList<>();
        if(messageList!=null){
            for (Message message : messageList) {
                Map<String,Object> conversation = new HashMap<>();
                conversation.put("conversation",message);
                conversation.put("letterCount",messageService.selectLetterCount(message.getConversationId()));
                conversation.put("unreadCount",messageService.selectLetterUnreadCount(user.getId(),message.getConversationId()));
                int targetId = user.getId() != message.getFromId() ? message.getFromId() : message.getToId();
                User target = userService.selectById(targetId);
                conversation.put("target",target);

                conversations.add(conversation);

            }
        }
        model.addAttribute("conversations",conversations);

        //查询未读消息数量
        int letterUnreadCount = messageService.selectLetterUnreadCount(user.getId(),null);
        model.addAttribute("totalUnread",letterUnreadCount);

        return "site/letter";
    }
}
```

**页面letter.html**

```html
<!-- 私信列表 -->
<ul class="list-unstyled">
   <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${conversations}">
      <span class="badge badge-danger" th:if="${map.unreadCount!=0}" th:text="${map.unreadCount}">3</span>
      <a th:href="@{|/user/profile/${map.target.id}|}">
         <img th:src="${map.target.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像" >
      </a>
      <div class="media-body">
         <h6 class="mt-0 mb-3">
            <span class="text-success" th:utext="${map.target.username}">落基山脉下的闲人</span>
            <span class="float-right text-muted font-size-12" th:text="${#dates.format(map.conversation.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
         </h6>
         <div>
            <a th:href="@{|/letter/detail/${map.conversation.conversationId}|}" th:utext="${map.conversation.content}">米粉车, 你来吧!</a>
            <ul class="d-inline font-size-12 float-right">
               <li class="d-inline ml-2"><a href="#" class="text-primary">共 <i th:text="${map.letterCount}">5</i> 条会话</a></li>
            </ul>
         </div>
      </div>
   </li>
</ul>
```

返回按钮使用js做

```html
<button type="button" class="btn btn-secondary btn-sm" onclick="back()">返回</button>

<script>
	function back(){
		location.href = CONTEXT_PATH + "/letter/list";
	}
</script>
```



## 8.2 私信详情

在MessageController中新增方法来处理详情请求

需要注意几个问题：

- 页面修改注意往来用户头像和用户名等等

```java
@RequestMapping(value = {"/letter/detail/{conversationId}"},method = RequestMethod.GET)
public String getLetterDetail(@PathVariable("conversationId") String conversationId,Page page, Model model){
    User user = hostHolder.getValue();
    //分页信息
    page.setRows(messageService.selectLetterCount(conversationId));
    page.setPath("/letter/detail/"+conversationId);
    page.setLimit(5);

    //从conversationId中获得目标id
    String[] fromto = conversationId.split("_");
    int from = Integer.parseInt(fromto[0]);
    int to = Integer.parseInt(fromto[1]);
    from = user.getId() == from ? to : from;
    User fromUser = userService.selectById(from);

    //私信列表
    List<Message> messageList = messageService.selectLettersByConversationId(conversationId, page.getOffset(), page.getLimit());
    List<Map<String,Object>> letters = new ArrayList<>();
    if (messageList!=null){
            for (Message message : messageList) {
                Map<String,Object> letter = new HashMap<>();
                letter.put("letter",message);
                //如果fromid与from相同，则显示来信方。否则显示自己
                if(message.getFromId()==from){
                    letter.put("fromUser",fromUser);
                }else{
                    letter.put("fromUser",user);
                }

                letters.add(letter);
            }
        }

    model.addAttribute("letters",letters);


    model.addAttribute("target",fromUser);
    return "site/letter-detail";
}
```

**修改页面letter-detail**

```html
<!-- 私信列表 -->
<ul class="list-unstyled mt-4">
   <li class="media pb-3 pt-3 mb-2" th:each="map:${letters}">
      <a href="profile.html">
         <img th:src="${map.fromUser.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像" >
      </a>
      <div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
         <div class="toast-header">
            <strong class="mr-auto" th:utext="${map.fromUser.username}">落基山脉下的闲人</strong>
            <small th:text="${#dates.format(map.letter.createTime)}">2019-04-25 15:49:32</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
               <span aria-hidden="true">&times;</span>
            </button>
         </div>
         <div class="toast-body" th:utext="${map.letter.content}">
            君不见, 黄河之水天上来, 奔流到海不复回!
         </div>
      </div>
   </li>
</ul>
```

## 8.3 发送私信

- 发送私信
  - 采用异步方式发送私信
  - 发送成功后刷新私信列表
- 设置已读
  - 访问私信详情时，将显示的私信设置为已读状态

### 8.3.1 数据层接口与实现

在MessageMapper中添加新的接口方法

一个是新增消息，另一个用来修改消息状态，并且传值为List

```java
/**
 * 新增消息
 * @param message
 * @return
 */
int insertMessage(Message message);

/**
 * 修改消息状态，已读或者删除
 * @param ids
 * @param status
 * @return
 */
int updateMessageStatus(List<Integer> ids,int status);
```

在MessageMapper.xml中实现该接口

需要注意的几个问题：

- 传值为list时如何使用foreach遍历

```xml
<insert id="insertMessage" parameterType="Message" keyProperty="id">
    insert into message(<include refid="insertFields"></include>)
    values(#{fromId},#{toId},#{conversationId},#{content},#{status},#{createTime});
</insert>

<update id="updateMessageStatus">
    update message set status = #{status}
    where id in
    <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</update>
```

### 8.3.2 业务层接口与实现

在MessageService接口中添加新接口

```java
/**
 * 新增消息
 * @param message
 * @return
 */
int insertMessage(Message message);

/**
 * 修改消息状态，已读或者删除
 * @param ids
 * @param status
 * @return
 */
int updateMessageStatus(List<Integer> ids,int status);
```

在MessageServiceImpl中实现接口

需要注意的几个问题：

- 对内容进行敏感词和标签过滤

```java
@Override
public int insertMessage(Message message) {
    message.setContent(sensitiveFilter.filter(message.getContent()));
    message.setContent(HtmlUtils.htmlEscape(message.getContent()));
    return messageMapper.insertMessage(message);
}

@Override
public int updateMessageStatus(List<Integer> ids, int status) {
    return messageMapper.updateMessageStatus(ids, status);
}
```

### 8.3.3 表现层

MessageController在该类中添加下面方法处理用户的发送消息请求

需要注意的几个问题：

- 前端使用ajax请求发送消息
- 在阅读消息详情方法中添加一个 List<Integer\>保存要修改阅读状态的消息。这个功能是在原阅读详细信息方法中新增的一部分功能

```java
/**
 * 处理发送消息
 * @param toName
 * @param content
 * @return
 */
@RequestMapping(value = {"/letter/send"},method = RequestMethod.POST)
@ResponseBody
public String sendMessage(String toName,String content){
    User toUser = userService.selectByUsername(toName);
    if(toUser==null){
        return CommunityUtils.getJSONString(1,"目标用户不存在");
    }
    //封装消息
    User user = hostHolder.getValue();
    Message message = new Message();
    message.setFromId(user.getId());
    message.setToId(toUser.getId());
    message.setConversationId(toUser.getId() < user.getId() ? toUser.getId()+"_"+ user.getId() :user.getId()+"_"+ toUser.getId());
    message.setContent(content);
    message.setStatus(0);
    message.setCreateTime(new Date());

    messageService.insertMessage(message);

    return CommunityUtils.getJSONString(0);
}


@RequestMapping(value = {"/letter/detail/{conversationId}"},method = RequestMethod.GET)
    public String getLetterDetail(@PathVariable("conversationId") String conversationId,Page page, Model model){
        User user = hostHolder.getValue();
        //分页信息
        page.setRows(messageService.selectLetterCount(conversationId));
        page.setPath("/letter/detail/"+conversationId);
        page.setLimit(5);

        //从conversationId中获得目标id
        String[] fromto = conversationId.split("_");
        int from = Integer.parseInt(fromto[0]);
        int to = Integer.parseInt(fromto[1]);
        from = user.getId() == from ? to : from;
        User fromUser = userService.selectById(from);

        //私信列表
        List<Message> messageList = messageService.selectLettersByConversationId(conversationId, page.getOffset(), page.getLimit());
        List<Map<String,Object>> letters = new ArrayList<>();

        //设置已读
        List<Integer> ids  = new ArrayList<>();

        if (messageList!=null){
            for (Message message : messageList) {
                Map<String,Object> letter = new HashMap<>();
                letter.put("letter",message);
                //如果fromid与from相同，则显示来信方。否则显示自己
                if(message.getFromId()==from){
                    letter.put("fromUser",fromUser);
                    if(message.getStatus() == 0)
                        ids.add(message.getId());
                }else{
                    letter.put("fromUser",user);

                }

                letters.add(letter);
            }
        }

        if(!ids.isEmpty()){
            int rows = messageService.updateMessageStatus(ids, 1);
        }

        model.addAttribute("letters",letters);
        model.addAttribute("target",fromUser);
        return "site/letter-detail";
    }
```

**修改页面**

发送消息的ajax业务

```js
$(function(){
    $("#sendBtn").click(send_letter);
    $(".close").click(delete_msg);
});

function send_letter() {
    $("#sendModal").modal("hide");
    var toName = $("#recipient-name").val();
    var content = $("#message-text").val();
    console.log($("#message-text"))
    $.post({
        url:CONTEXT_PATH + "/letter/send",
        data:{"toName":toName,"content":content},
        success:function (data){
            data = $.parseJSON(data);
            if(data.code==0){
                $("#hintBody").text("发送成功!");
            }else{
                $("#hintBody").text(data.msg);
            }
            $("#hintModal").modal("show");
            setTimeout(function(){
                $("#hintModal").modal("hide");
                window.location.reload();
            }, 2000);
        }
    });
}

function delete_msg() {
    // TODO 删除数据
    $(this).parents(".media").remove();
}
```

## 8.4 删除私信

删除私信时只需要将该私信的状态转变为 删除状态即可

因为表结构的问题，如果删除私信，则会双向删除

### 8.4.1 表现层

使用RESTful风格传入参数，conversationId用来提供重定向跳转，id为将要删除的消息的id

```java
@RequestMapping(value = {"/letter/delete/{conversationId}/{id}"},method = RequestMethod.GET)
public String deleteMessage(@PathVariable("conversationId") String conversationId,@PathVariable("id") int id){
    messageService.updateMessageStatus(Arrays.asList(id),2);
    return "redirect:/letter/detail/"+conversationId;
}
```

修改页面

letter-datail.html中为关闭按钮添加链接，直接访问

注意几个问题：

- 这里直接使用ajax请求的时候，因为有很多id一样的标签，jQuery取值会出错。没想到更好的办法，所以用这个方法做

```html
<button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
   <a aria-hidden="true" th:href="@{|/letter/delete/${map.letter.conversationId}/${map.letter.id}|}">&times;</a>
</button>
```



# 9 异常处理

[参考Springboot入门 10 错误处理](..\..\Springboot\Springboot入门.md)

- @ControllerAdvice
  - 用于修饰类，表示该类是Controller的全局配置类
  - 在此类中，可以对Controller进行如下三种全局配置
  - 异常处理方案、绑定数据方案、绑定参数方案
- @ExceptionHandler
  - 用于修饰方法，该方法会在Controller出现异常后被调用，用于处理捕获到的异常
- @ModelAttribute
  - 用于修饰方法，该方法会在Controller执行前被调用，用于为Model对象绑定参数
- @DataBinder
  - 用于修饰方法，该方法会在Controller执行前被被调用，用于绑定参数的转换器



## 9.1 创建Controller全局通知类

需要注意几个问题：

- @ControllerAdvice会自动扫描全部类，增加annotations让它只扫描带@Controller的类

- @ExceptionHandler可以指定捕获哪些异常，这里的Exception.class指定捕获所有异常
- 发生错误时，有可能是请求页面错误，也有可能是异步请求返回json错误。所以通过x-request-with来判断是否是异步请求，返回响应的错误信息



```java
@ControllerAdvice(annotations = Controller.class)
public class ExceptionAdvice {

    private static final Logger logger = LoggerFactory.getLogger(ExceptionAdvice.class);

    @ExceptionHandler({Exception.class})
    public void handlerException(Exception e , HttpServletRequest request, HttpServletResponse response) throws IOException {
        logger.error("服务器发生异常"+e.getMessage());
        for (StackTraceElement element : e.getStackTrace()){
            logger.error(element.toString());
        }
        String xRequestWith = request.getHeader("x-request-with");
        if("XMLHttpRequest".equals(xRequestWith)){
            //异步请求
            response.setContentType("application/plain;charset=utf-8");
            PrintWriter writer = response.getWriter();
            writer.write(CommunityUtils.getJSONString(1,"服务器异常!"));
        }else{
            response.sendRedirect(request.getContextPath()+"/error");
        }
    }
}
```

# 10 日志记录

[SpringAOP概念 # 9 AOP](..\..\Spring\Spring入门)

[AOP详解 -- csdn](https://blog.csdn.net/q982151756/article/details/80513340)

利用aop进行日志切入

需要注意的几个问题：

- 利用工具类从Request获得IP地址
- 通过切入点可以获得执行方法的类名和方法名

```java
@Component
@Aspect
public class ServiceLogAspect {

    private static final Logger logger = LoggerFactory.getLogger(ServiceLogAspect.class);

    @Pointcut("execution(* com.edu.ligen.nowcoder.service.*.*(..))")
    public void pointcut(){

    }

    @Before("pointcut()")
    public void before(JoinPoint joinPoint){
        //用户[ip],在[time]，访问了[com.edu.ligen.nowcoder.service.xxx()]
        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        String ip = request.getRemoteHost();
        String now = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date());
        String method = joinPoint.getSignature().getDeclaringTypeName() + "." + joinPoint.getSignature().getName();
        logger.info(String.format("用户[%s],在[%s]访问了[%s].",ip,now,method));
    }

}
```





导入redis依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

在application.yml中的简单配置

```yml
spring:
    redis:
      host: localhost
      database: 10
      port: 6379
```

redis配置类

```java
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String,Object> redisTemplate(RedisConnectionFactory factory){
        //为redis设置连接工厂，这样才能连接数据库
        RedisTemplate<String,Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);

        //设置key的序列化方式
        template.setKeySerializer(RedisSerializer.string());
        //设置value的序列化方式
        template.setValueSerializer(RedisSerializer.json());
        //设置hash的key的序列化方式
        template.setHashKeySerializer(RedisSerializer.string());
        //设置hash的value的序列化方式
        template.setHashValueSerializer(RedisSerializer.json());

        //更新配置
        template.afterPropertiesSet();
        return template;
    }
}
```

# 11 交流

## 11.1 点赞

- 点赞
  - 对帖子或者评论点赞
  - 第一次点赞，第二次取消
- 首页点赞数量
  - 统计帖子的点赞数量
- 详情页点赞数量
  - 统计点赞数量
  - 显示点赞状态

### 11.1.2 创建RedisKey工具类

该类用来生成RedisKey，方便进行redis操作

```java
public class RedisKeyUtil {

    private static final String SPLIT = ":";

    private static final String PREFIX_ENTITY_LIKE = "like:entity";

    /**
     * 对某个实体（帖子，评论，回复）的点赞
     * like:entity:entityType:entityId -> set(userId)
     * 存userId可以知道是哪些人点了赞
     * @param entityType
     * @param entityId
     * @return
     */
    public static String getEntityLikeKey(int entityType,int entityId){
        StringBuilder sb = new StringBuilder();
        sb.append(PREFIX_ENTITY_LIKE)
                .append(SPLIT)
                .append(entityType)
                .append(SPLIT)
                .append(entityId);
        return sb.toString();
    }
}
```

### 11.1.3 业务层接口和实现

这里采用的是redis数据库，直接跳过了数据层，在业务层中写

**接口**

```java
public interface LikeService {

    /**
     * 点赞功能
     * @param userId 当前点赞用户
     * @param entityType
     * @param entityId
     */
    void like(int userId,int entityType,int entityId);

    /**
     * 统计某个实体的点赞数量
     * @param entityType
     * @param entityId
     * @return
     */
    long selectEntityLikeCount(int entityType,int entityId);

    /**
     * 查询某个人对某个实体有没有点赞或者点踩
     * @param userId
     * @param entityType
     * @param entityId
     * @return
     */
    int selectEntityLikeStatus(int userId,int entityType,int entityId);
}
```

**实现**

```java
@Service
public class LikeServiceImpl implements LikeService {

    @Autowired
    private RedisTemplate redisTemplate;

    public void like(int userId, int entityType,int entityId){
        String likeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        boolean isMember =  redisTemplate.opsForSet().isMember(likeKey,userId);
        if(isMember){
            //已经存在则取消点赞
            redisTemplate.opsForSet().remove(likeKey,userId);
        }else{
            redisTemplate.opsForSet().add(likeKey,userId);
        }
    }

    @Override
    public long selectEntityLikeCount(int entityType, int entityId) {
        String likeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().size(likeKey);
    }

    @Override
    public int selectEntityLikeStatus(int userId, int entityType, int entityId) {
        String likeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
        return redisTemplate.opsForSet().isMember(likeKey,userId) ? 1 : 0;
    }
}
```

### 11.1.4 表现层

使用异步请求进行点赞的处理，前端使用ajax动态更新点赞数量

```java
@Controller
public class LikeController {

    @Autowired
    private LikeService likeService;
    
    @Autowired
    private HostHolder hostHolder;
    
    @RequestMapping(value = {"/like"},method = RequestMethod.POST)
    @ResponseBody
    public String like(int entityType,int entityId){
        User user = hostHolder.getValue();
        
        //点赞
        likeService.like(user.getId(),entityType,entityId);
        //统计点赞数量
        long likeCount = likeService.selectEntityLikeCount(entityType, entityId);
        //查询点赞状态
        int likeStatus = likeService.selectEntityLikeStatus(user.getId(), entityType, entityId);

        Map<String,Object> map = new HashMap<>();
        
        map.put("likeCount",likeCount);
        map.put("likeStatus",likeStatus);
        
        return CommunityUtils.getJSONString(0,null,map);
    }
}
```

**修改页面**

对赞部分进行如下修改：

- 增加onclick方法，传入值包含this，代表当前标签，供js使用
- 赞和数字用不同的标签包裹，进行动态调整

```
<li class="d-inline ml-2">
   <a href="javascript:;" th:onclick="|like(this,1,${post.id})|" class="text-primary">
      <b>赞</b> <i>11</i>
   </a>
</li>
```

**创建新的discuss.js**

将这个标签当作一个button，然后取到孩子标签对孩子标签进行动态设置

```js
function like(btn,entityType,entityId){

    $.post({
        url:CONTEXT_PATH + "/like",
        data:{"entityType":entityType,"entityId":entityId},
        success:function (data){
            data = $.parseJSON(data)
            if(data.code==0){
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus==1?'已赞':'赞');
            }else{
                alert(data.msg);
            }
        }
    })
}
```

### 11.1.5 补充修改

因为上面的操作保存到了redis中，但是原来写的controller并没有调用过redis相关业务，所以点赞过后再刷新又会回复到初始状态。现在对以下类或者方法进行修改补充

**首页赞显示**

修改IndexController的index方法

- 新注入

```java
@Autowired
private LikeService likeService;
```

- for循环中添加查询点赞数量的逻辑

```java
long likeCount = likeService.selectEntityLikeCount(ENTITY_TYPE_POST, post.getId());
map.put("likeCount",likeCount);
```

- 页面赞部分添加动态取值

```html
<li class="d-inline ml-2">赞 <span th:text="${map.likeCount}">11</span></li>
```

**帖子详情页面点赞显示**

修改discussPostController的getDiscussPostDetail方法

也要注入likeService

- 在分页信息前面插入下面的查询，修改的是帖子的点赞

```java
//点赞数量
long likeCount = likeService.selectEntityLikeCount(ENTITY_TYPE_POST, postId);
model.addAttribute("likeCount",likeCount);
//点赞状态
//用户没有登录也能访问该页面，直接返回0，不用再取user值
int likeStatus = hostHolder.getValue() == null ? 0 : likeService.selectEntityLikeStatus(hostHolder.getValue().getId(), ENTITY_TYPE_POST, postId);
model.addAttribute("likeStatus",likeStatus);
```

- 帖子赞修改

```java
<b th:text="${likeStatus==1?'已赞':'赞'}">赞</b> <i th:text="${likeCount}">11</i>
```

- 在comment for中添加下面的查询，修改的是评论的点赞

```java
//点赞数量
likeCount = likeService.selectEntityLikeCount(ENTITY_TYPE_COMMENT, comment.getId());
commentVo.put("likeCount",likeCount);
//点赞状态
//用户没有登录也能访问该页面，直接返回0，不用再取user值
likeStatus = hostHolder.getValue() == null ? 0 : likeService.selectEntityLikeStatus(hostHolder.getValue().getId(), ENTITY_TYPE_COMMENT, comment.getId());
commentVo.put("likeStatus",likeStatus);
```

- 评论赞修改

```html
<b th:text="${commentMap.likeStatus==1?'已赞':'赞'}">赞</b> <i th:text="${commentMap.likeCount}">(1)</i>
```

- 在reply for中添加下面的查询，修改的是回复的点赞

```java
//点赞数量
likeCount = likeService.selectEntityLikeCount(ENTITY_TYPE_COMMENT, reply.getId());
replyVo.put("likeCount",likeCount);
//点赞状态
//用户没有登录也能访问该页面，直接返回0，不用再取user值
likeStatus = hostHolder.getValue() == null ? 0 : likeService.selectEntityLikeStatus(hostHolder.getValue().getId(), ENTITY_TYPE_COMMENT, reply.getId());
replyVo.put("likeStatus",likeStatus);
```

- 回复赞修改

```html
<b th:text="${reply.likeStatus==1?'已赞':'赞'}">赞</b> <i th:text="${reply.likeCount}">(1)</i>
```

## 11.2 我收到的赞

- 重构点赞功能
  - 以用户为key，记录点赞数量
  - increment(key)，decrement(key)
- 开发个人主页
  - 以用户为key查询点赞数量

### 11.2.1 添加RedisKey

添加一个 `like:userId`，保存每个用户被点赞的数量

```java
private static final String PREFIX_USER_LIKE = "like:user";

/**
 * 对哪个对象进行了操作（点赞、关注等），不是当前登录用户
 * like:user -> set(userId)
 * @param userId
 * @return 关于该用户的key
 */
public static String getUserLikeKey(int userId){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_USER_LIKE)
            .append(SPLIT)
            .append(userId);
    return sb.toString();
}
```

### 11.2.2 业务层接口与实现

**LikeService接口**

因为要保存用户被点赞的数量，所以对原来的like进行一次重构，添加entityUserId参数用来指定被点赞的对象

```java
/**
* 点赞功能
* @param userId 当前点赞用户
* @param entityType
* @param entityId
* @param entityUserId 被点赞的目标用户
*/
void like(int userId,int entityType,int entityId,int entityUserId);

/**
 * 查询该用户被点赞了多少次
 * @param userId
 * @return
 */
int selectUserLikeCount(int userId);
```

**LikeServiceImpl中实现这两个方法**

重构了原来的like方法，并且添加了事务

需要注意的几个问题：

- redis事务中不能进行查询操作，redis会将操作保存在队列中，提交事务时一次性执行
- 返回数量时进行非法值检查

```java
public void like(int userId,int entityType,int entityId,int entityUserId){
//        String likeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
//        boolean isMember =  redisTemplate.opsForSet().isMember(likeKey,userId);
//        if(isMember){
//            //已经存在则取消点赞
//            redisTemplate.opsForSet().remove(likeKey,userId);
//        }else{
//            redisTemplate.opsForSet().add(likeKey,userId);
//        }

    //添加查询自己的所有点赞功能，进行事务重构
    redisTemplate.execute(new SessionCallback() {
        @Override
        public Object execute(RedisOperations operations) throws DataAccessException {
            String likeKey = RedisKeyUtil.getEntityLikeKey(entityType, entityId);
            String userLikeKey = RedisKeyUtil.getUserLikeKey(entityUserId);

            boolean isMember = redisTemplate.opsForSet().isMember(likeKey,userId);//该用户是否给该帖子、评论、回复点赞
                operations.multi();
                if(isMember){
                   operations.opsForSet().remove(likeKey,userId);
                   operations.opsForValue().decrement(userLikeKey);
                }else{
                    operations.opsForSet().add(likeKey,userId);
                    operations.opsForValue().increment(userLikeKey);
                }
    });
}

@Override
public int selectUserLikeCount(int userId) {
    String userLikeKey = RedisKeyUtil.getUserLikeKey(userId);
    Integer count = (Integer) redisTemplate.opsForValue().get(userLikeKey);
    return count == null ? 0 : count;
}
```

### 11.2.3 表现层

**UserController**

使用RESTful风格传入用户id，对该用户的点赞进行查询并返回。同时将user用户传到前端，将显示该用户的点赞头像等

```java
@LoginRequired
@RequestMapping(value = {"/profile/{userId}","/profile.html/{userId}"},method = RequestMethod.GET)
public String getProfilePage(Model model,@PathVariable("userId") int userId){
    int userLikeCount = likeService.selectUserLikeCount(userId);
    User user = userService.selectById(userId);
    model.addAttribute("userLikeCount",userLikeCount);
    model.addAttribute("user",user);
    return "/site/profile";
}
```

**profile页面**

五处修改，个人信息链接，用户名，注册时间，头像和点赞

```html
<a class="nav-link active" th:href="@{|/user/profile/${user.id}|}">个人信息</a>
<span th:utext="${user.username}">nowcoder</span>
<span>注册于 <i class="text-muted" th:text="${#dates.format(user.createTime,'yyyy-MM-dd HH:mm:ss')}">2015-06-12 15:20:12</i></span>
<img th:src="${user.headerUrl}" class="align-self-start mr-4 rounded-circle" alt="用户头像" style="width:50px;">

<span class="ml-4">获得了 <i class="text-danger" th:text="${userLikeCount}">87</i> 个赞</span>
```

**index页面**

个人主页链接，帖子列表的用户头像和个人主页链接

```html
<a class="dropdown-item text-center" th:href="@{|/user/profile/${loginUser.id}|}">个人主页</a>

<a th:href="@{|/user/profile/${map.user.id}|}">
    <img th:src="${map.user.headerUrl}" class="mr-4 rounded-circle" alt="用户头像" style="width:50px;height:50px;">
```

**discuss-detail页面**

主要修改个人主页链接

```html
<a th:href="@{|/user/profile/${user.id}|}">
<a th:href="@{|/user/profile/${commentMap.user.id}|}">
```

还要修改like方法的传值

```html
<a href="javascript:;" th:onclick="|like(this,1,${post.id},${post.userId})|" class="text-primary">
<a href="javascript:;" th:onclick="|like(this,2,${commentMap.comment.id},${commentMap.comment.userId})|" class="text-primary">
```

**修改discuss.js**

增加一个参数

```js
function like(btn,entityType,entityId,entityUserId){

    $.post({
        url:CONTEXT_PATH + "/like",
        data:{"entityType":entityType,"entityId":entityId,"entityUserId":entityUserId},
        success:function (data){
            data = $.parseJSON(data)
            if(data.code==0){
                $(btn).children("i").text(data.likeCount);
                $(btn).children("b").text(data.likeStatus==1?'已赞':'赞');
            }else{
                alert(data.msg);
            }
        }
    })
}
```

## 11.3 关注和取消关注

- 需求
  - 关注、取消关注
  - 统计用户的关注数、粉丝数
- 关键
  - 若A关注了B，则A是B的Follower，B是A的Followee
  - 关注的目标可以是用户、帖子、题目等，在实现时将这些目标抽象为实体

### 11.3.1 添加RedisKey

```java
private static final String PREFIX_FOLLOWEE = "followee";
private static final String PREFIX_FOLLOWER = "follower";

/**
 * 某个用户关注的实体
 * followee:userId:entityType -> zset(entityId,now)
 * @param userId 关注者
 * @param entityType 实体类型
 * @return
 */
public static String getFolloweeKey(int userId,int entityType){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_FOLLOWEE)
            .append(SPLIT)
            .append(userId)
            .append(SPLIT)
            .append(entityType);
    return sb.toString();
}

/**
 * 某个实体拥有的粉丝
 * follower:entityType:entityId -> zet(userId,now)
 * @param entityType
 * @param entityId
 * @return
 */
public static String getFollowerKey(int entityType,int entityId){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_FOLLOWER)
            .append(SPLIT)
            .append(entityType)
            .append(SPLIT)
            .append(entityId);
    return sb.toString();
}
```

### 11.3.2 业务层接口与实现

**新建FollowService业务接口**

```java
public interface FollowService {

    /**
     * 关注某个实体
     * @param userId
     * @param entityType
     * @param entityId
     */
    void follow(int userId,int entityType,int entityId);

    /**
     * 取消关注某个实体
     * @param userId
     * @param entityType
     * @param entityId
     */
    void unfollow(int userId,int entityType,int entityId);

}
```

**FollowServiceImpl接口实现**

使用业务方式来实现关注和取消关注功能

```java
@Service
public class FollowServiceImpl implements FollowService {

    @Autowired
    private RedisTemplate redisTemplate;

    @Override
    public void follow(int userId, int entityType, int entityId) {
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId,entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType,entityId);

                operations.multi();

                operations.opsForZSet().add(followeeKey,entityId,System.currentTimeMillis());
                operations.opsForZSet().add(followerKey,userId,System.currentTimeMillis());

                return operations.exec();
            }
        });
    }

    @Override
    public void unfollow(int userId, int entityType, int entityId) {
        redisTemplate.execute(new SessionCallback() {
            @Override
            public Object execute(RedisOperations operations) throws DataAccessException {
                String followeeKey = RedisKeyUtil.getFolloweeKey(userId,entityType);
                String followerKey = RedisKeyUtil.getFollowerKey(entityType,entityId);

                operations.multi();

                operations.opsForZSet().remove(followeeKey,entityId);
                operations.opsForZSet().remove(followerKey,userId);

                return operations.exec();
            }
        });
    }
}
```

### 11.3.3 表现层

**新建FollowController**

添加两个方法，关注和取消关注

```java
@Controller
public class FollowController {

    @Autowired
    private HostHolder hostHolder;

    @Autowired
    private FollowService followService;

    @RequestMapping(value = "/follow",method = RequestMethod.POST)
    @ResponseBody
    @LoginRequired
    public String follow(int entityType,int entityId){
        User user = hostHolder.getValue();

        followService.follow(user.getId(),entityType,entityId);

        return CommunityUtils.getJSONString(0,"已关注");
    }

    @RequestMapping(value = "/unfollow",method = RequestMethod.POST)
    @ResponseBody
    @LoginRequired
    public String unfollow(int entityType,int entityId){
        User user = hostHolder.getValue();

        followService.unfollow(user.getId(),entityType,entityId);

        return CommunityUtils.getJSONString(0,"已取消关注");
    }
}
```

**修改profile.html**

在关注标签前添加一个隐藏域用来传userId

```html
<input type="hidden" th:value="${user.id}"/>
<button type="button" class="btn btn-info btn-sm float-right mr-5 follow-btn">关注TA</button>
```

**profile.js**

```js
$(function(){
	$(".follow-btn").click(follow);
});

function follow() {
	var btn = this;
	if($(btn).hasClass("btn-info")) {
		// 关注TA
		$.post({
			url:CONTEXT_PATH + "/follow",
			data:{"entityType":3,"entityId":$(btn).prev().val()},
			success:function (data){
				data = $.parseJSON(data);
				if(data.code==0){
					//表示成功
					window.location.reload();
				}else{
					alert(data.msg);
				}
			}
		});
		// $(btn).text("已关注").removeClass("btn-info").addClass("btn-secondary");
	} else {
		// 取消关注
		$.post({
			url:CONTEXT_PATH + "/unfollow",
			data:{"entityType":3,"entityId":$(btn).prev().val()},
			success:function (data){
				data = $.parseJSON(data);
				if(data.code==0){
					//表示成功
					window.location.reload();
				}else{
					alert(data.msg);
				}
			}
		});
		// $(btn).text("关注TA").removeClass("btn-secondary").addClass("btn-info");
	}
}
```

## 11.4 显示关注和被关注

### 11.4.1 业务层接口与实现

**在FollowServie中添加几个接口**

```java
/**
 * 查询该用户关注的实体数量
 * @param userId
 * @param entityType
 * @return
 */
long selectFolloweeCount(int userId,int entityType);

/**
 * 查询该实体的粉丝数量
 * @param entityType
 * @param entityId
 * @return
 */
long selectFollowerCount(int entityType,int entityId);

/**
 * 查询该用户是否关注该实体
 * @param userId
 * @param entityType
 * @param entityId
 * @return
 */
boolean isFollowed(int userId,int entityType,int entityId);
```

**在FollowServiceImpl中实现这几个方法**

```java
@Override
public long selectFolloweeCount(int userId, int entityType) {
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
    return redisTemplate.opsForZSet().zCard(followeeKey);
}

@Override
public long selectFollowerCount(int entityType, int entityId) {
    String follower = RedisKeyUtil.getFollowerKey(entityType, entityId);
    return redisTemplate.opsForZSet().zCard(follower);
}

@Override
public boolean isFollowed(int userId, int entityType, int entityId) {
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, entityType);
    return redisTemplate.opsForZSet().score(followeeKey,entityId) != null;
}
```

### 11.4.2 表现层

**修改UserController**

这个controller里写了请求个人主页的请求，在该请求里添加关注相关信息

```java
@LoginRequired
@RequestMapping(value = {"/profile/{userId}","/profile.html/{userId}"},method = RequestMethod.GET)
public String getProfilePage(Model model,@PathVariable("userId") int userId){
    int userLikeCount = likeService.selectUserLikeCount(userId);
    User user = userService.selectById(userId);
    //点赞数量
    model.addAttribute("userLikeCount",userLikeCount);
    model.addAttribute("user",user);
    //关注数量
    long followeeCount = followService.selectFolloweeCount(userId, ENTITY_TYPE_USER);
    model.addAttribute("followee",followeeCount);
    //粉丝数量
    long followerCount = followService.selectFollowerCount(ENTITY_TYPE_USER, userId);
    model.addAttribute("follower",followerCount);
    //是否已关注
    boolean isFollowed = false;
    if(hostHolder.getValue()!=null){
        isFollowed = followService.isFollowed(hostHolder.getValue().getId(),ENTITY_TYPE_USER,userId);
    }
    model.addAttribute("isFollowed",isFollowed);
    return "/site/profile";
}
```

**修改页面**

进行了样式更改，关注内容更改，关注数量，粉丝数量更改

自己主页不用显示关注自己

```html
<!-- 个人信息 -->
<div class="media mt-5">
   <img th:src="${user.headerUrl}" class="align-self-start mr-4 rounded-circle" alt="用户头像" style="width:50px;">
   <div class="media-body">
      <h5 class="mt-0 text-warning">
         <span th:utext="${user.username}">nowcoder</span>
         <input type="hidden" th:value="${user.id}"/>
         <button type="button"
               th:class="|btn ${isFollowed==false?'btn-info':'btn-secondary'} btn-sm float-right mr-5 follow-btn|"
               th:text="|${isFollowed==false?'关注TA':'已关注'}|"
               th:if="${loginUser!=null&&loginUser.id!=user.id}">
            关注TA
         </button>
      </h5>
      <div class="text-muted mt-3">
         <span>注册于 <i class="text-muted" th:text="${#dates.format(user.createTime,'yyyy-MM-dd HH:mm:ss')}">2015-06-12 15:20:12</i></span>
      </div>
      <div class="text-muted mt-3 mb-5">
         <span>关注了 <a class="text-primary" href="followee.html" th:text="${followee}">5</a> 人</span>
         <span class="ml-4">关注者 <a class="text-primary" id="follower" href="follower.html" th:text="${follower}">123</a> 人</span>
         <span class="ml-4">获得了 <i class="text-danger" th:text="${userLikeCount}">87</i> 个赞</span>
      </div>
   </div>
</div>
```

## 11.5 显示关注列表

- 业务层
  - 查询某个用户关注的人，支持分页
  - 查询某个用户的粉丝，支持分页
- 表现层
  - 处理“查询关注的人”、“查询粉丝”请求
  - 编写“查询关注的人”、“查询粉丝”模板

### 11.5.1 业务层接口与实现

因为我们还要对分页进行支持，所以需要传入分页信息

**在FollowService中添加新接口**

```java
/**
 * 查询某个用户关注了谁
 * @param userId 用户id
 * @param offset 分页条件
 * @param limit 分页条件
 * @return
 */
List<Map<String,Object>> selectFollowees(int userId,int offset,int limit);

/**
 * 查询某个用户的关注者
 * @param userId 用户id
 * @param offset 分页条件
 * @param limit 分页条件
 * @return
 */
List<Map<String,Object>> selectFollowers(int userId,int offset,int limit);
```

**FollowServiceImpl实现**

需要注意几个问题：

- 在redis取值时注意边界
- 将关注者信息和关注内容都要加入map中

```java
@Override
public List<Map<String, Object>> selectFollowees(int userId, int offset, int limit) {
    String followeeKey = RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);
    //关注者id集合
    Set<Integer> targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, limit - offset - 1);

    if(targetIds==null)
        return null;
    List<Map<String, Object>> list = new ArrayList<>();
    for (Integer targetId : targetIds) {
        Map<String, Object> map = new HashMap<>();
        User user = userService.selectById(targetId);
        map.put("user",user);
        Double score = redisTemplate.opsForZSet().score(followeeKey, targetId);
        map.put("followTime",new Date(score.longValue()));
        list.add(map);
    }

    return list;
}

@Override
public List<Map<String, Object>> selectFollowers(int userId, int offset, int limit) {
    String followerKey = RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER,userId);
    //关注者id集合
    Set<Integer> targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, limit - offset - 1);

    if(targetIds==null)
        return null;
    List<Map<String, Object>> list = new ArrayList<>();
    for (Integer targetId : targetIds) {
        Map<String, Object> map = new HashMap<>();
        User user = userService.selectById(targetId);
        map.put("user",user);
        Double score = redisTemplate.opsForZSet().score(followerKey, targetId);
        map.put("followTime",new Date(score.longValue()));
        list.add(map);
    }

    return list;
}
```

### 11.5.2 表现层

**在FollowController中添加新方法**

需要注意的几个问题：

- 查询当前要查看用户，显示该用户的信息
- 在map中添加是否关注的信息

```java
@RequestMapping(value = {"/followee/{userId}","/followee.html/{userId}"},method = RequestMethod.GET)
public String getFollowee(@PathVariable("userId") int userId, Model model, Page page){
    User user = userService.selectById(userId);
    if(user==null){
        throw new RuntimeException("该用户不存在!");
    }
    model.addAttribute("user",user);

    //设置分页
    page.setLimit(5);
    page.setPath("/followee" + userId);
    page.setRows((int)(followService.selectFolloweeCount(userId,ENTITY_TYPE_USER)));

    List<Map<String,Object>> userList = followService.selectFollowees(userId, page.getOffset(),page.getLimit());
    if(userList!=null){
        for (Map<String, Object> map : userList) {
            User u = (User) map.get("user");
            //要查当前用户是否也关注了u用户
            map.put("isFollowed",isFollowed(u.getId()));
        }
    }
    model.addAttribute("users",userList);

    return "site/followee";
}

@RequestMapping(value = {"/follower/{userId}","/follower.html/{userId}"},method = RequestMethod.GET)
public String getFollower(@PathVariable("userId") int userId,Model model, Page page){
    User user = userService.selectById(userId);
    if(user==null){
        throw new RuntimeException("该用户不存在!");
    }
    model.addAttribute("user",user);

    //设置分页
    page.setLimit(5);
    page.setPath("/follower" + userId);
    page.setRows((int)(followService.selectFollowerCount(ENTITY_TYPE_USER,userId)));

    List<Map<String,Object>> userList = followService.selectFollowers(userId, page.getOffset(),page.getLimit());
    if(userList!=null){
        for (Map<String, Object> map : userList) {
            User u = (User) map.get("user");
            //要查当前用户是否也关注了u用户
            map.put("isFollowed",isFollowed(u.getId()));
        }
    }
    model.addAttribute("users",userList);
    return "site/follower";
}

private boolean isFollowed(int targetId){
    if(hostHolder.getValue()==null){
        return false;
    }
    return followService.isFollowed(hostHolder.getValue().getId(), ENTITY_TYPE_USER,targetId);
}
```

**修改页面**

profile.html

- 给关注人数添加链接

```html
<div class="text-muted mt-3 mb-5">
   <span>关注了 <a class="text-primary" th:href="@{|/followee/${user.id}|}" th:text="${followee}">5</a> 人</span>
   <span class="ml-4">关注者 <a class="text-primary" id="follower" th:href="@{|/follower/${user.id}|}" th:text="${follower}">123</a> 人</span>
   <span class="ml-4">获得了 <i class="text-danger" th:text="${userLikeCount}">87</i> 个赞</span>
</div>
```

followee.html和follower.html需要修改的地方很相似，只记录一个

- 修改关注的人和关注XXX的人标签链接，返回个人主页

```html
<!-- 选项 -->
<ul class="nav nav-tabs mb-3">
   <li class="nav-item">
      <a class="nav-link position-relative active" th:href="@{|/followee/${user.id}|}">
         <i class="text-info" th:utext="${user.username}">Nowcoder</i>
         关注的人
      </a>
   </li>
   <li class="nav-item">
      <a class="nav-link position-relative" th:href="@{|/follower/${user.id}|}">
         关注
         <i class="text-info" th:utext="${user.username}">Nowcoder</i>
         的人
      </a>
   </li>
</ul>
<a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0">返回个人主页&gt;</a>
```

- 关注列表中头像，时间，关注状态等
- 登录才显示关注，不显示自己的关注。按钮增加隐藏域出触发js

```html
<!-- 关注列表 -->
<ul class="list-unstyled">
    <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:each="map:${users}">
        <a th:href="@{|/user/profile/${map.user.id}|}">
            <img th:src="${map.user.headerUrl}" class="mr-4 rounded-circle user-header" alt="用户头像" >
        </a>
        <div class="media-body">
            <h6 class="mt-0 mb-3">
                <span class="text-success" th:utext="${map.user.username}">落基山脉下的闲人</span>
                <span class="float-right text-muted font-size-12">
                    关注于
                    <i th:text="${#dates.format(map.followTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</i>
                </span>
            </h6>
            <div>
                <input type="hidden" th:value="${user.id}"/>
                <button type="button"
                        th:class="|btn ${map.isFollowed==false?'btn-info':'btn-secondary'} btn-sm float-right follow-btn|"
                        th:text="${map.isFollowed==false?'关注TA':'已关注'}"
                        th:if="${loginUser!=null && loginUser.id!=map.user.id}">
                    关注TA
                </button>
            </div>
        </div>
    </li>
</ul>
```

# 12 优化登录模块

- 使用Redis存储验证码
  - 验证码需要频繁的访问与刷新，对性能要求较高
  - 验证码不需要永久保存，通常在很短的时间后就会失效
  - 分布式部署时，存在Session共享的问题
- 使用Redis存储初登录凭证
  - 处理每次请求时，都要查询用户的登录凭证，访问的频率非常高
- 使用Redis缓存用户信息
  - 处理每次请求时，都要根据凭证查询用户信息，访问的频率非常高

## 12.1 验证码

### 12.1.1 添加RedisKey

使用Redis替代session来保存验证码信息，增加一个kapatchaKey

```java
private static final String PREFIX_KAPTCHA = "kaptcha";
/**
 * 生成一个验证码key
 * @param owner 用户未登录，使用随机的字符串来验证用户，放在cookie中
 * @return
 */
public static String getKaptchaKey(String owner){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_KAPTCHA)
            .append(SPLIT)
            .append(owner);
    return sb.toString();
}
```

### 12.1.2 修改保存验证码过程

**修改LoginController**

- 注释掉session相关
- 添加一个cookie保存用户凭证，并设置过期时间
- 将该用户的验证码存入Redis

```java
/**
 * 获取验证码单独写一个请求，方便后面刷新验证码，用response单独返回
 * 该验证码属于敏感信息，所以使用session存储在服务端
 * @param response
 * @param session 使用session保存验证码凭证，重构后不需要session
 */
@RequestMapping(value = "/kaptcha",method = RequestMethod.GET)
public void getKaptcha(HttpServletResponse response/*, HttpSession session*/){
    //生成验证码
    String text = kaptcha.createText();
    BufferedImage image = kaptcha.createImage(text);

//        //将验证码存入session
//        session.setAttribute("kaptcha",text);

    //生成用户识别凭证，存至cookie
    String kaptchaOwner = CommunityUtils.generateUUID();
    Cookie cookie = new Cookie("kaptchaOwner",kaptchaOwner);
    cookie.setMaxAge(60);//设置过期时间,60秒
    cookie.setPath(contextPath);
    response.addCookie(cookie);

    //将凭证存入redis
    String kaptchaKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
    redisTemplate.opsForValue().set(kaptchaKey,text,60, TimeUnit.SECONDS);

    // 将图片输出给浏览器
    response.setContentType("image/png");
    try(
            OutputStream os = response.getOutputStream();
            ) {
        ImageIO.write(image,"png",os);
    } catch (IOException e) {
        logger.error("验证码响应失败"+e.getMessage());
    }
}
```

- 修改login方法检查验证码部分
- cookie可以直接通过注解参数@CookieValue("name")取值

```java
//检查验证码
//        String kaptcha = (String) session.getAttribute("kaptcha");
String kaptcha = "";
String kaptchaOwner = CookieUtils.getValue(request, "kaptchaOwner");
if(StringUtils.isNotBlank(kaptchaOwner)){
    //有该凭证
    String kaptchaKey = RedisKeyUtil.getKaptchaKey(kaptchaOwner);
    kaptcha = (String) redisTemplate.opsForValue().get(kaptchaKey);
}
```

- 使用注解取值会报错，修改一下

## 12.2 登录凭证

使用Redis存储凭证以后，我们的login_ticket表就相当于废弃了，同时在LoginTicketMapper上标注废弃注解@Deprecated

### 12.2.1 添加RedisKey

```java
private static final String PREFIX_LOGIN_TICKET = "login:ticket";
/**
 * 获得一个登录凭证key
 * @param ticket
 * @return
 */
public static String getLoginTicketKey(String ticket){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_LOGIN_TICKET)
            .append(SPLIT)
            .append(ticket);
    return sb.toString();
}
```

### 12.2.2 生成登陆凭证

LoginTicketServiceImpl中的login方法

```java
//账号密码正确，生成登录凭证
LoginTicket loginTicket = new LoginTicket();
loginTicket.setTicket(CommunityUtils.generateUUID());
loginTicket.setStatus(0);
loginTicket.setUserId(user.getId());
loginTicket.setExpired(new Date(System.currentTimeMillis()+expiredSeconds*1000));
//保存登录凭证
//        loginTicketMapper.insertLoginTicket(loginTicket);
String loginTicketKey = RedisKeyUtil.getLoginTicketKey(loginTicket.getTicket());
redisTemplate.opsForValue().set(loginTicketKey,loginTicket);//将对象自动序列化
```

修改其他方法

添加凭证、根据凭证查询、更新状态等

```java
@Override
public LoginTicket selectByTicket(String ticket) {
//        return loginTicketMapper.selectByTicket(ticket);
    String loginTicketKey = RedisKeyUtil.getLoginTicketKey(ticket);
    return (LoginTicket) redisTemplate.opsForValue().get(loginTicketKey);
}

@Override
public int insertLoginTicket(LoginTicket loginTicket) {
    String loginTicketKey = RedisKeyUtil.getLoginTicketKey(loginTicket.getTicket());
    redisTemplate.opsForValue().set(loginTicketKey,loginTicket);
    return 1;
//        return loginTicketMapper.insertLoginTicket(loginTicket);
}

@Override
public int updateLoginTicket(String ticket, int status) {
//        return loginTicketMapper.updateLoginTicket(ticket, status);
    String loginTicketKey = RedisKeyUtil.getLoginTicketKey(ticket);
    LoginTicket loginTicket = (LoginTicket) redisTemplate.opsForValue().get(loginTicketKey);
    loginTicket.setStatus(status);
    //修改状态
    redisTemplate.opsForValue().set(loginTicketKey,loginTicket);
    return 1;
}
```

## 12.3 缓存用户信息

用户信息还是保存在MySQL中，但是为了提高性能，我们将用户的信息保存在Redis中。

- 优先从缓存中取值
- 取不到时初始化缓存数据
- 数据变更时清除缓存数据，避免多线程错误

### 12.3.1 添加RedisKey

```java
/**
 * 获得一个用户的key
 * @param userId
 * @return
 */
public static String getUserKey(int userId){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_USER)
       		.append(SPLIT)
            .append(userId);
    return sb.toString();
}
```

### 12.3.2 缓存相关操作

在UserServiceImpl中添加三个方法

```java
//    1.优先从缓存中取值
private User getCache(int userId){
    String userKey = RedisKeyUtil.getUserKey(userId);
    return (User) redisTemplate.opsForValue().get(userKey);
}
//    2.取不到时初始化缓存数据
private User initCache(int userId){
    User user = userMapper.selectById(userId);
    String userKey = RedisKeyUtil.getUserKey(userId);
    redisTemplate.opsForValue().set(userKey,user,3600, TimeUnit.SECONDS);//3600秒缓存过期
    return user;
}
//    3.数据变更时清除缓存数据，避免多线程错误
private void updateCache(int userId){
    String userKey = RedisKeyUtil.getUserKey(userId);
    redisTemplate.delete(userKey);
}
```

### 12.3.3 重构原来的代码

**UserServiceImpl -> selectById方法**

修改获取用户方法

```java
@Override
public User selectById(int id) {
//        return userMapper.selectById(id);
    User user = getCache(id);
    if(user == null){
        user = initCache(id);
    }
    return user;
}
```

**UserServiceImpl -> activation方法**

更新前先清除缓存

```java
//激活成功
clearCache(userId);
userMapper.updateStatus(user.getId(),ACTIVATION_SUCCESS);
return ACTIVATION_SUCCESS;
```

**UserServiceImpl -> resetPassword(String email, String verifycode, String password, HttpSession session)方法**

更新密码前先清除缓存

```java
User user = userMapper.selectByEmail(email);
password = CommunityUtils.md5(password + user.getSalt());
clearCache(user.getId());
userMapper.updatePassword(user.getId(),password);
```

**UserServiceImpl -> resetPassword(String oldPassword, String newPassword)方法**

更新密码前先清除缓存

```java
//设置了新密码
clearCache(user.getId());
userMapper.updatePassword(user.getId(), CommunityUtils.md5(newPassword + user.getSalt()));
```

**在更新方法前添加删除缓存**

```java
@Override
public int updateStatus(int id, int status) {
    updateCache(id);
    return userMapper.updateStatus(id,status);
}

@Override
public int updateHeader(int id, String headerUrl) {
    updateCache(id);
    return userMapper.updateHeader(id,headerUrl);
}

@Override
public int clearPassword(int id, String password) {
    updateCache(id);
    return userMapper.updatePassword(id,password);
}
```

# 13 我的帖子与回复

在个人主页显示我的帖子，我的回复

修改profile.html页面

如果没有登录或者看别人的主页，就显示“他的帖子”，并不显示回复

```html
<!-- 选项 -->
<div class="position-relative">
   <ul class="nav nav-tabs">
      <li class="nav-item">
         <a class="nav-link active" th:href="@{|/user/profile/${user.id}|}">个人信息</a>
      </li>
      <li class="nav-item">
         <a class="nav-link" th:href="@{|/user/myPost/${user.id}|}" th:text="${loginUser!=null && loginUser.id==user.id ? '我的帖子':'他的帖子'}">我的帖子</a>
      </li>
      <li class="nav-item">
         <a class="nav-link" th:href="@{|/user/myReply/${user.id}|}" th:if="${loginUser!=null && loginUser.id==user.id}">我的回复</a>
      </li>
   </ul>
</div>
```

## 13.1 我的帖子

### 13.1.1 表现层

**修改UserController**

在该Controller中添加两个方法myPost和myReply用来返回我的帖子和回复的页面

在Controller前注入必要的组件

需要注意的几个问题：

- 使用原有的方法可以查询到总共有多少帖子
- 设置分页信息
- 查询到所有帖子，使用likeService方法查询到该帖子的获得赞数量

```java
@RequestMapping(value = {"/myPost/{userId}"},method = RequestMethod.GET)
public String myPost(@PathVariable("userId") int userId, Model model, Page page){
    User user = userService.selectById(userId);
    model.addAttribute("user",user);

    //分页信息
    int postCount = discussPostService.selectDiscussPostRows(userId);
    page.setRows(postCount);
    page.setPath("/user/myPost/" + userId);
    page.setLimit(5);

    //显示帖子
    List<DiscussPost> discussPosts = discussPostService.selectDiscussPosts(userId, page.getOffset(), page.getLimit());
    List<Map<String,Object>> discussPostVo = new ArrayList<>();
    if(discussPosts!=null){
        //添加赞信息
        for (DiscussPost discussPost : discussPosts) {
            Map<String,Object> post = new HashMap<>();
            post.put("discussPost",discussPost);
            long likeCount = likeService.selectEntityLikeCount(ENTITY_TYPE_POST, discussPost.getId());
            post.put("likeCount",likeCount);
            discussPostVo.add(post);
        }
    }
    model.addAttribute("discussPosts",discussPostVo);
    model.addAttribute("postCount",postCount);

    return "site/my-post";
}
```

**修改my-post.html**

- 修改个人信息，我的帖子，回复链接
- 发布帖子的数量
- 发布帖子的内容，时间，链接
- 分页处理

```html
<!-- 内容 -->
<div class="main">
   <div class="container">
      <!-- 选项 -->
      <div class="position-relative">
         <ul class="nav nav-tabs">
            <li class="nav-item">
               <a class="nav-link" th:href="@{|/user/profile/${user.id}|}">个人信息</a>
            </li>
            <li class="nav-item">
               <a class="nav-link active"
                  th:href="@{|/user/myPost/${user.id}|}"
                  th:text="${loginUser!=null && loginUser.id == user.id ? '我的帖子' : '他的帖子'}">
                  我的帖子
               </a>
            </li>
            <li class="nav-item">
               <a class="nav-link"
                  th:href="@{|/user/myReply/${user.id}|}"
                  th:if="${loginUser!=null && loginUser.id == user.id}">
                  我的回复
               </a>
            </li>
         </ul>
         <a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0">返回个人主页&gt;</a>
      </div>
      <!-- 我的帖子 -->
      <div class="mt-4">
         <h6><b class="square"></b> 发布的帖子(<b th:text="${postCount}">93</b>)</h6>
         <ul class="list-unstyled mt-4 pl-3 pr-3">
            <li class="border-bottom pb-3 mt-4" th:each="postVo:${discussPosts}">
               <div class="font-size-16 text-info">
                  <a th:href="@{|/discuss/detail/${postVo.discussPost.id}|}" class="text-info" th:utext="${postVo.discussPost.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
               </div>
               <div class="mt-1 font-size-14" th:utext="${postVo.discussPost.content}">
                  金三银四的金三已经到了，你还沉浸在过年的喜悦中吗？
                  如果是，那我要让你清醒一下了：目前大部分公司已经开启了内推，正式网申也将在3月份陆续开始，金三银四，春招的求职黄金时期已经来啦！！！
                  再不准备，作为19应届生的你可能就找不到工作了。。。作为20届实习生的你可能就找不到实习了。。。
                  现阶段时间紧，任务重，能做到短时间内快速提升的也就只有算法了，
                  那么算法要怎么复习？重点在哪里？常见笔试面试算法题型和解题思路以及最优代码是怎样的？
                  跟左程云老师学算法，不仅能解决以上所有问题，还能在短时间内得到最大程度的提升！！！                       
               </div>
               <div class="text-right font-size-12 text-muted">
                  赞 <i class="mr-3" th:text="${postVo.likeCount}">11</i> 发布于
                  <b th:text="${#dates.format(postVo.discussPost.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 10:10:10</b>
               </div>
            </li>
         </ul>
         <!-- 分页 -->
         <nav class="mt-5" th:replace="index::pageNavigation">
            <ul class="pagination justify-content-center">
               <li class="page-item"><a class="page-link" href="#">首页</a></li>
               <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
               <li class="page-item active"><a class="page-link" href="#">1</a></li>
               <li class="page-item"><a class="page-link" href="#">2</a></li>
               <li class="page-item"><a class="page-link" href="#">3</a></li>
               <li class="page-item"><a class="page-link" href="#">4</a></li>
               <li class="page-item"><a class="page-link" href="#">5</a></li>
               <li class="page-item"><a class="page-link" href="#">下一页</a></li>
               <li class="page-item"><a class="page-link" href="#">末页</a></li>
            </ul>
         </nav>             
      </div>          
   </div>
</div>
```

## 13.2 我的回复

### 13.2.1 表现层

逻辑同前

```java
@RequestMapping(value = {"/myReply/{userId}"},method = RequestMethod.GET)
public String myReply(@PathVariable("userId") int userId, Model model, Page page){
    User user = userService.selectById(userId);
    model.addAttribute("user",user);

    //分页信息
    //使用USER类型，entityId被userId赋值
    int replyCount = commentService.selectCommentRows(ENTITY_TYPE_USER,userId);
    page.setRows(replyCount);
    page.setPath("/user/myReply/" + userId);
    page.setLimit(5);

    //显示评论
    List<Comment> comments = commentService.selectCommentsByEntity(ENTITY_TYPE_USER, userId, page.getOffset(), page.getLimit());
    List<Map<String,Object>> commentVo = new ArrayList<>();
    //添加目标帖子信息
    if(comments!=null){
        for (Comment comment : comments) {
            Map<String,Object> map = new HashMap<>();
            map.put("comment",comment);
            DiscussPost discussPost = discussPostService.selectDiscussPost(comment.getEntityId());
            map.put("post",discussPost);
            commentVo.add(map);
        }
    }
    model.addAttribute("comments",commentVo);
    model.addAttribute("replyCount",replyCount);

    return "site/my-reply";
}
```

```html
<!-- 内容 -->
<div class="main">
   <div class="container">
      <!-- 选项 -->
      <div class="position-relative">
         <ul class="nav nav-tabs">
            <li class="nav-item">
               <a class="nav-link" th:href="@{|/user/profile/${user.id}|}">个人信息</a>
            </li>
            <li class="nav-item">
               <a class="nav-link"
                  th:href="@{|/user/myPost/${user.id}|}"
                  th:text="${loginUser!=null && loginUser.id == user.id ? '我的帖子' : '他的帖子'}">
                  我的帖子
               </a>
            </li>
            <li class="nav-item">
               <a class="nav-link active"
                  th:href="@{|/user/myReply/${user.id}|}"
                  th:if="${loginUser!=null && loginUser.id == user.id}">
                  我的回复
               </a>
            </li>
         </ul>
         <a th:href="@{|/user/profile/${user.id}|}" class="text-muted position-absolute rt-0">返回个人主页&gt;</a>
      </div>
      <!-- 我的回复 -->
      <div class="mt-4">
         <h6><b class="square"></b> 回复的帖子(<b th:text="${replyCount}">379</b>)</h6>
         <ul class="list-unstyled mt-4 pl-3 pr-3">
            <li class="border-bottom pb-3 mt-4" th:each="commentVo:${comments}">
               <div class="font-size-16 text-info">
                  <a th:href="@{|/discuss/detail/${commentVo.comment.entityId}|}" class="text-info" th:utext="${commentVo.post.title}">备战春招，面试刷题跟他复习，一个月全搞定！</a>
               </div>
               <div class="mt-1 font-size-14" th:utext="${commentVo.comment.content}">
                  顶顶顶!                        
               </div>
               <div class="text-right font-size-12 text-muted">
                  回复于 <b th:text="${#dates.format(commentVo.comment.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-15 10:10:10</b>
               </div>
            </li>
         </ul>
         <!-- 分页 -->
         <nav class="mt-5" th:replace="index::pageNavigation">
            <ul class="pagination justify-content-center">
               <li class="page-item"><a class="page-link" href="#">首页</a></li>
               <li class="page-item disabled"><a class="page-link" href="#">上一页</a></li>
               <li class="page-item active"><a class="page-link" href="#">1</a></li>
               <li class="page-item"><a class="page-link" href="#">2</a></li>
               <li class="page-item"><a class="page-link" href="#">3</a></li>
               <li class="page-item"><a class="page-link" href="#">4</a></li>
               <li class="page-item"><a class="page-link" href="#">5</a></li>
               <li class="page-item"><a class="page-link" href="#">下一页</a></li>
               <li class="page-item"><a class="page-link" href="#">末页</a></li>
            </ul>
         </nav>             
      </div>          
   </div>
</div>
```



# 14 发送系统通知

[使用Kafka进行系统通知的发送](..\..\..\库\kafka\kafka入门.md)

- 触发事件
  - 评论后
  - 点赞后
  - 关注后
- 处理事件
  - 封装事件对象
  - 开发事件的生产者
  - 开发事件的消费者

在application.yml中配置kafka

```yml
spring:
    kafka:
      bootstrap-servers: localhost:9092
      consumer:
        group-id: community-consumer-group
        enable-auto-commit: true # 消费者按照偏移量读取，是否将这个偏移量进行记录
        auto-commit-interval: 3000 # 自动提交怕频率 3 sec
```

## 14.1 封装事件对象

需要注意几个问题：

- 小技巧：将set方法的返回值设置为当前对象，这样就可以链式编程 .set().set()连续设置多个字段

```java
public class Event {

    private String topic; //事件类型、主题
    private int userId;//事件触发者
    private int entityType;//事件对象
    private int entityId;//事件对象id
    private int entityUserId;//事件对象属于哪个用户
    private Map<String,Object> data = new HashMap<>();//额外数据

    public Event() {
    }

    public Event(String topic, int userId, int entityType, int entityId, int entityUserId, Map<String, Object> data) {
        this.topic = topic;
        this.userId = userId;
        this.entityType = entityType;
        this.entityId = entityId;
        this.entityUserId = entityUserId;
        this.data = data;
    }

    public String getTopic() {
        return topic;
    }

    public Event setTopic(String topic) {
        this.topic = topic;
        return this;
    }

    public int getUserId() {
        return userId;
    }

    public Event setUserId(int userId) {
        this.userId = userId;
        return this;
    }

    public int getEntityType() {
        return entityType;
    }

    public Event setEntityType(int entityType) {
        this.entityType = entityType;
        return this;
    }

    public int getEntityId() {
        return entityId;
    }

    public Event setEntityId(int entityId) {
        this.entityId = entityId;
        return this;
    }

    public int getEntityUserId() {
        return entityUserId;
    }

    public Event setEntityUserId(int entityUserId) {
        this.entityUserId = entityUserId;
        return this;
    }

    public Map<String, Object> getData() {
        return data;
    }

    public Event setData(String key,Object value) {
        this.data.put(key,value);
        return this;
    }

    @Override
    public String toString() {
        return "Event{" +
                "topic='" + topic + '\'' +
                ", userId=" + userId +
                ", entityType=" + entityType +
                ", entityId=" + entityId +
                ", entityUserId=" + entityUserId +
                ", data=" + data +
                '}';
    }
}
```

## 14.2 新建常量

```java
/**
 * 主题：评论
 */
String TOPIC_COMMENT = "comment";

/**
 * 主题：点赞
 */
String TOPIC_LIKE = "like";

/**
 * 主题：关注
 */
String TOPIC_FOLLOW = "follow";

/**
 * 系统用户
 */
int SYSTEM_USER_ID = 1;
```

## 14.3 生产者与消费者

新建一个事件生产者，EventProducer.java

需要注意的几个问题：

- send消息的参数必须是字符串，一定要注意

```java
@Component
public class EventProducer {

    @Autowired
    private KafkaTemplate kafkaTemplate;

    //处理事件
    public void fireEvent(Event event){
        //将事件发送到指定得主题
        kafkaTemplate.send(event.getTopic(), JSONObject.toJSON(event).toString());
    }
}
```

新建一个事件消费者，EventConsumer.java

```java
@Component
public class EventConsumer implements CommunityConstant {

    private static final Logger logger = LoggerFactory.getLogger(EventConsumer.class);

    @Autowired
    private MessageService messageService;

    @KafkaListener(topics = {TOPIC_COMMENT,TOPIC_FOLLOW,TOPIC_LIKE})
    public void handleCommentMessage(ConsumerRecord record){
        if(record==null || record.value()==null){
            logger.error("消息内容为空");
            return;
        }
        Event event = JSONObject.parseObject(record.value().toString(),Event.class);
        if(event==null){
            logger.error("消息格式错误");
            return;
        }
        //发送站内通知
        Message message = new Message();
        message.setFromId(SYSTEM_USER_ID);//系统用户
        message.setToId(event.getEntityUserId());
        message.setConversationId(event.getTopic());
        message.setCreateTime(new Date());
		//将事件消息封装进内容
        Map<String,Object> content = new HashMap<>();
        content.put("userId",event.getUserId());
        content.put("entityType",event.getEntityType());
        content.put("entityId",event.getEntityId());

        if(!event.getData().isEmpty()){
            for (Map.Entry<String,Object> entry : event.getData().entrySet()){
                content.put(entry.getKey(), entry.getValue());
            }
        }
        message.setContent(JSONObject.toJSONString(content));
        messageService.insertMessage(message);
    }
}
```

## 14.4 在相应事件发生处调用生产者

需要注意的几个问题：

- 我们的日志记录AOP是切入到service方法上的，其中有一个获取request请求的方法。通过从controller处调用是有request方法的，但是我们如果使用了消息队列，这个时候没有request会报null错误
- 因此可以判断如果为null直接跳过不记录日志

### 14.4.1 评论事件

重构添加评论方法

需要注意几个问题：

- 目标用户id是通过查找查出来的，而不同得评论类型，其查找的表是不同的。所以判断一下
- 对评论进行了通过id查询，新增该业务

```java
@RequestMapping(value = "/add/{discussPostId}", method = RequestMethod.POST)
public String addComment(@PathVariable("discussPostId") int discussPostId, Comment comment) {
    User user = hostHolder.getValue();
    //user可能为null，后面统一处理
    comment.setUserId(user.getId());
    comment.setStatus(0);
    comment.setCreateTime(new Date());
    commentService.insertComment(comment);

    //处理评论事件
    Event event = new Event()
            .setTopic(TOPIC_COMMENT)
            .setEntityType(comment.getEntityType())
            .setEntityId(comment.getEntityId())
            .setUserId(user.getId())
            .setData("postId", discussPostId);
    //entityUserId需要查出来
    if (comment.getEntityType() == ENTITY_TYPE_POST) {
        //给帖子得评论，从帖子表查询
        DiscussPost target = discussPostService.selectDiscussPost(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    } else if (comment.getEntityType() == ENTITY_TYPE_COMMENT) {
        //对评论评论，即回复
        Comment target = commentService.selectCommentById(comment.getEntityId());
        event.setEntityUserId(target.getUserId());
    }
    eventProducer.fireEvent(event);

    return "redirect:/discuss/detail/" + discussPostId;
}
```

省略业务方法，只写Mapper

```java
/**
 * 根据id查询
 */
Comment selectCommentById(int id);
```

```xml
<select id="selectCommentById" resultType="Comment">
    select <include refid="selectFields"/> from comment where id = #{id}
</select>
```

### 14.4.2 点赞事件

需要注意的几个问题：

- 重构点赞方法，我们对帖子和评论都可以进行点赞，最终通知的链接都会转到该帖子，所以从前端多传回来一个postId
- 点赞进行通知，取消点赞就不需要通知了

```java
@RequestMapping(value = {"/like"},method = RequestMethod.POST)
@ResponseBody
public String like(int entityType,int entityId,int entityUserId,int postId){
    User user = hostHolder.getValue();

    //点赞
    likeService.like(user.getId(),entityType,entityId,entityUserId);
    //统计点赞数量
    long likeCount = likeService.selectEntityLikeCount(entityType, entityId);
    //查询点赞状态
    int likeStatus = likeService.selectEntityLikeStatus(user.getId(), entityType, entityId);

    Map<String,Object> map = new HashMap<>();

    map.put("likeCount",likeCount);
    map.put("likeStatus",likeStatus);

    //处理点赞事件
    //取消赞不用通知
    if(likeStatus==1){
        Event event = new Event()
                .setTopic(TOPIC_LIKE)
                .setUserId(user.getId())
                .setEntityType(entityType)
                .setEntityId(entityId)
                .setEntityUserId(entityUserId)
                .setData("postId",postId);
        eventProducer.fireEvent(event);
    }

    return CommunityUtils.getJSONString(0,null,map);
}
```

修改discuss-detail.html页面

在每一个调用like方法的参数列表中加入${post.id})

```html
th:onclick="|like(this,2,${reply.reply.id},${reply.reply.userId},${post.id})|"
```

修改discuss.js

添加postId

### 14.4.3 关注事件

重构follow方法

```java
@RequestMapping(value = "/follow",method = RequestMethod.POST)
@ResponseBody
@LoginRequired
public String follow(int entityType,int entityId){
    User user = hostHolder.getValue();

    followService.follow(user.getId(),entityType,entityId);

    //触发关注事件
    Event event = new Event()
            .setTopic(TOPIC_FOLLOW)
            .setUserId(user.getId())
            .setEntityType(entityType)
            .setEntityId(entityId)
            .setEntityUserId(entityId);
    eventProducer.fireEvent(event);

    return CommunityUtils.getJSONString(0,"已关注");
}
```



## 14.2 通知列表

- 通知列表
  - 显示评论、点赞、关注三种类型的通知
- 通知详情
  - 分页显示某一类主题包含的通知
- 未读消息
  - 在页面头部显示所有未读消息的数量

### 14.2.1 数据层接口与实现

在MessageMapper.java中新增三个接口

```java
/**
 * 查询某主题下最新的通知
 */
Message selectLatestNotice(int userId, String topic);

/**
 * 查询某个主题包含的数量
 */
int selectNoticeCount(int userId, String topic);

/**
 * 查询未读通知的数量
 */
int selectUnreadNoticeCount(int userId, String topic);
```

在MessageMapper.xml中实现这三个接口

```xml
<select id="selectLatestNotice" resultType="Message">
    select <include refid="selectFields"></include> from message
    where status!=2
    and from_id=1
    and to_id = #{userId}
    and conversation_id = #{topic}
    order by create_time desc
    limit 1;
</select>

<select id="selectNoticeCount" resultType="int">
    select COUNT(id) from message
    where status!=2
    and from_id=1
    and to_id = #{userId}
    and conversation_id = #{topic}
</select>

<select id="selectUnreadNoticeCount" resultType="int">
    select COUNT(id) from message
    where status=0
    and from_id=1
    and to_id = #{userId}
    <if test="topic!=null">
        and conversation_id = #{topic}
    </if>

</select>
```

### 14.2.2 业务层接口与实现

```java
@Override
public Message selectLatestNotice(int userId, String topic) {
    return messageMapper.selectLatestNotice(userId, topic);
}

@Override
public int selectNoticeCount(int userId, String topic) {
    return messageMapper.selectNoticeCount(userId, topic);
}

@Override
public int selectUnreadNoticeCount(int userId, String topic) {
    return messageMapper.selectUnreadNoticeCount(userId, topic);
}
```

### 14.2.3 表现层

在MessageController中新增方法

需要注意的几个问题：

- 需要将message内容存储的json字符串解析为map，方便从中读取数据
- 三种类型的通知
- 页面修改注意每种类型不能message，以及数据合法性的判断

```java
@RequestMapping(value = {"/notice/list"}, method = RequestMethod.GET)
public String getNoticeList(Model model){
    User user = hostHolder.getValue();

    //评论通知
    Message message = messageService.selectLatestNotice(user.getId(), TOPIC_COMMENT);
    if(message!=null){
        Map<String,Object> messageVo = new HashMap<>();
        messageVo.put("message",message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String,Object> data = JSONObject.parseObject(content, HashMap.class);
        messageVo.put("user",userService.selectById((Integer) data.get("userId")));
        messageVo.put("entityType",data.get("entityType"));
        messageVo.put("entityId",data.get("entityId"));
        messageVo.put("postId",data.get("postId"));

        int commentCount = messageService.selectNoticeCount(user.getId(), TOPIC_COMMENT);
        messageVo.put("commentCount",commentCount);

        int unreadCount = messageService.selectUnreadNoticeCount(user.getId(),TOPIC_COMMENT);
        messageVo.put("unreadCount",unreadCount);

        model.addAttribute("commentMessage",messageVo);
    }

    //点赞通知
    message = messageService.selectLatestNotice(user.getId(), TOPIC_LIKE);
    if(message!=null){
        Map<String,Object> messageVo = new HashMap<>();
        messageVo.put("message",message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String,Object> data = JSONObject.parseObject(content, HashMap.class);
        messageVo.put("user",userService.selectById((Integer) data.get("userId")));
        messageVo.put("entityType",data.get("entityType"));
        messageVo.put("entityId",data.get("entityId"));
        messageVo.put("postId",data.get("postId"));

        int likeCount = messageService.selectNoticeCount(user.getId(), TOPIC_LIKE);
        messageVo.put("likeCount",likeCount);

        int unreadCount = messageService.selectUnreadNoticeCount(user.getId(),TOPIC_LIKE);
        messageVo.put("unreadCount",unreadCount);

        model.addAttribute("likeMessage",messageVo);
    }

    //关注通知
    message = messageService.selectLatestNotice(user.getId(), TOPIC_FOLLOW);
    if(message!=null){
        Map<String,Object> messageVo = new HashMap<>();
        messageVo.put("message",message);

        String content = HtmlUtils.htmlUnescape(message.getContent());
        Map<String,Object> data = JSONObject.parseObject(content, HashMap.class);
        messageVo.put("user",userService.selectById((Integer) data.get("userId")));
        messageVo.put("entityType",data.get("entityType"));
        messageVo.put("entityId",data.get("entityId"));

        int followCount = messageService.selectNoticeCount(user.getId(), TOPIC_FOLLOW);
        messageVo.put("followCount",followCount);

        int unreadCount = messageService.selectUnreadNoticeCount(user.getId(),TOPIC_FOLLOW);
        messageVo.put("unreadCount",unreadCount);

        model.addAttribute("followMessage",messageVo);
    }

    //查询未读数量
    int letterUnreadCount = messageService.selectLetterUnreadCount(user.getId(),null);
    model.addAttribute("letterUnreadCount",letterUnreadCount);
    int noticeUnreadCount = messageService.selectUnreadNoticeCount(user.getId(),null);
    model.addAttribute("unreadNoticeCount",noticeUnreadCount);


    return "site/notice";
}
```

修改notice页面

```html
<!-- 内容 -->
<div class="main">
   <div class="container">
      <div class="position-relative">
         <!-- 选项 -->
         <ul class="nav nav-tabs mb-3">
            <li class="nav-item">
               <a class="nav-link position-relative" th:href="@{/letter/list}">
                  朋友私信
                  <span class="badge badge-danger" th:if="${letterUnreadCount!=0}" th:text="${letterUnreadCount}">3</span>
               </a>
            </li>
            <li class="nav-item">
               <a class="nav-link position-relative active" th:href="@{/notice/list}">
                  系统通知
                  <span class="badge badge-danger" th:if="${noticeUnreadCount!=0}" th:text="${noticeUnreadCount}">27</span>
               </a>
            </li>
         </ul>
      </div>
      <!-- 通知列表 -->
      <ul class="list-unstyled">
         <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${commentMessage!=null}">
            <span class="badge badge-danger" th:if="${commentMessage.unreadCount!=0}" th:text="${commentMessage.unreadCount}">3</span>
            <img src="http://static.nowcoder.com/images/head/reply.png" class="mr-4 user-header" alt="通知图标">
            <div class="media-body">
               <h6 class="mt-0 mb-3">
                  <span>评论</span>
                  <span class="float-right text-muted font-size-12"
                       th:text="${#dates.format(commentMessage.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
               </h6>
               <div>
                  <a th:href="@{|/discuss/detail/${commentMessage.postId}|}">用户 <i th:utext="${commentMessage.user.username}">nowcoder</i> 评论了你的<b>帖子</b> ...</a>
                  <ul class="d-inline font-size-12 float-right">
                     <li class="d-inline ml-2"><span class="text-primary">共 <i th:text="${commentMessage.commentCount}">3</i> 条会话</span></li>
                  </ul>
               </div>
            </div>
         </li>
         <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${likeMessage!=null}">
            <span class="badge badge-danger" th:if="${likeMessage.unreadCount!=0}" th:text="${likeMessage.unreadCount}">3</span>
            <img src="http://static.nowcoder.com/images/head/like.png" class="mr-4 user-header" alt="通知图标">
            <div class="media-body">
               <h6 class="mt-0 mb-3">
                  <span>赞</span>
                  <span class="float-right text-muted font-size-12"
                       th:text="${#dates.format(likeMessage.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
               </h6>
               <div>
                  <a th:href="@{|/discuss/detail/${likeMessage.postId}|}">用户 <i th:utext="${likeMessage.user.username}">nowcoder</i> 点赞了你的<b>帖子</b> ...</a>
                  <ul class="d-inline font-size-12 float-right">
                     <li class="d-inline ml-2"><span class="text-primary">共 <i th:text="${likeMessage.likeCount}">3</i> 条会话</span></li>
                  </ul>
               </div>
            </div>
         </li>
         <li class="media pb-3 pt-3 mb-3 border-bottom position-relative" th:if="${followMessage!=null}">
            <span class="badge badge-danger" th:if="${followMessage.unreadCount!=0}" th:text="${followMessage.unreadCount}">3</span>
            <img src="http://static.nowcoder.com/images/head/follow.png" class="mr-4 user-header" alt="通知图标">
            <div class="media-body">
               <h6 class="mt-0 mb-3">
                  <span>关注</span>
                  <span class="float-right text-muted font-size-12"
                       th:text="${#dates.format(followMessage.message.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-28 14:13:25</span>
               </h6>
               <div>
                  <a th:href="@{|/user/profile/${followMessage.user.id}|}">用户 <i th:utext="${followMessage.user.username}">nowcoder</i> 关注了你 ...</a>
                  <ul class="d-inline font-size-12 float-right">
                     <li class="d-inline ml-2"><span class="text-primary">共 <i th:text="${followMessage.followCount}">3</i> 条会话</span></li>
                  </ul>
               </div>
            </div>
         </li>
      </ul>
   </div>
</div>
```

## 14.3 通知详情

- 显示该类型的所有通知
- 查看消息之后设置已读

### 14.3.1 数据层接口与实现

在MessageMapper.java中新增接口

```java
/**
 * 查询该主题下的所有通知，支持分页
 */
List<Message> selectNotices(int userId,String topic,int offset,int limit);
```

实现接口

```xml
<select id="selectNotices" resultType="Message">
    select <include refid="selectFields"></include> from message
    where status!=2
    and from_id=1
    and to_id=#{userId}
    and conversation_id = #{topic}
    limit #{offset},#{limit}
</select>
```

### 14.3.2 业务层接口与实现

```java
@Override
public List<Message> selectNotices(int userId, String topic, int offset, int limit) {
    return messageMapper.selectNotices(userId, topic, offset, limit);
}
```

### 14.3.3 表现层

在MessageController.java中新增方法

```java
@RequestMapping(value = {"/notice/detail/{topic}"}, method = RequestMethod.GET)
public String getNoticeDetail(@PathVariable("topic") String topic, Model model, Page page) {
    User user = hostHolder.getValue();
    //设置分页
    page.setPath("/notice/detail/" + topic);
    page.setLimit(5);
    page.setRows(messageService.selectNoticeCount(user.getId(),topic));

    List<Message> notices = messageService.selectNotices(user.getId(), topic, page.getOffset(), page.getLimit());
    List<Map<String,Object>> noticeVoList = new ArrayList<>();
    //设置已读
    List<Integer> ids = new ArrayList<>();

    if(notices!=null){
        for (Message notice : notices) {
            Map<String,Object> map = new HashMap<>();
            map.put("notice",notice);
            String content = HtmlUtils.htmlUnescape(notice.getContent());
            HashMap<String,Object> data = JSONObject.parseObject(content, HashMap.class);
            map.put("user",userService.selectById((Integer) data.get("userId")));
            System.out.println(userService.selectById((Integer) data.get("userId")));
            map.put("entityType",data.get("entityType"));
            map.put("entityId",data.get("entityId"));
            map.put("postId",data.get("postId"));

            noticeVoList.add(map);
            if(notice.getStatus()==0){
                ids.add(notice.getId());
            }
        }
    }
    model.addAttribute("noticeVoList",noticeVoList);
    model.addAttribute("topic",topic);

    //设置已读
    if(!ids.isEmpty()){
        int rows = messageService.updateMessageStatus(ids, 1);
    }

    return "site/notice-detail";
}
```

修改notice.html页面

这里将三个通知整合到一起

需要注意的几个问题：

- 修改这种地方
- 但是不知道为什么关注页的点击查看取不到user的id，给用户名加链接标签都可以取到
- 最后还是给 topic 加了取值符号解决了问题

```java
<!-- 通知列表 -->
<ul class="list-unstyled mt-4">
    <li class="media pb-3 pt-3 mb-2" th:each="map:${noticeVoList}">
        <img src="http://static.nowcoder.com/images/head/notify.png" class="mr-4 rounded-circle user-header" alt="系统图标">
        <div class="toast show d-lg-block" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="mr-auto" > 落基山脉下的闲人</strong>
                <small th:text="${#dates.format(map.notice.createTime,'yyyy-MM-dd HH:mm:ss')}">2019-04-25 15:49:32</small>
                <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="toast-body">
                <span>用户 <a th:utext="${map.user.username}" th:href="@{|/user/profile/${map.user.id}|}">nowcoder</a>
                    <b th:text="${topic=='comment'?'评论':topic=='like'?'点赞':'关注'}">评论</b>了你<b th:if="${topic!='follow'}" th:text="${map.entityType==1?'帖子':'回复'}">的帖子</b>,
                    <a class="text-primary" th:href="@{${topic}!='follow'?'/discuss/detail/'+${map.postId}:'/user/profile/'+${map.user.id}}">点击查看</a>!
<!--									<a class="text-primary" th:if="${topic!='follow'}" th:href="@{|/discuss/detail/${map.postId}|}">点击查看</a>-->
<!--									<a class="text-primary" th:if="${topic=='follow'}" th:href="@{|/user/profile/${map.user.id}|}">点击查看</a>!-->
                </span>
            </div>
        </div>
    </li>
</ul>
```

## 14.4 首页消息通知

使用拦截器显示头部区域的消息通知数量

### 14.4.1 新增拦截器

```java
@Component
public class MessageInterceptor implements HandlerInterceptor {

    @Autowired
    private HostHolder hostHolder;

    @Autowired
    private MessageService messageService;

    @Override
    public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception {
        User user = hostHolder.getValue();
        if (user != null && modelAndView != null) {
            int letterUnreadCount = messageService.selectLetterUnreadCount(user.getId(), null);
            int noticeUnreadCount = messageService.selectUnreadNoticeCount(user.getId(), null);
            modelAndView.addObject("allUnreadCount", letterUnreadCount + noticeUnreadCount);
        }
    }
}
```

### 14.4.2 配置拦截器

配置在WebMvcConfig中

```java
@Autowired
private MessageInterceptor MessageInterceptor;

@Override
public void addInterceptors(InterceptorRegistry registry) {

    registry.addInterceptor(MessageInterceptor)
            .excludePathPatterns("/**/*.js","/**/*.css","/**/*.png","/**/*.jpg","/**/*.jpeg");
}
```

### 14.4.3 修改页面

修改index页面



# 15 权限控制

使用 Spring Security 框架实现权限控制

- 登录检查
  - 之前采用拦截器实现了登录检查，这是简单方案，现在废弃
- 授权配置
  - 对当前系统内包含的所有的请求，分配访问权限（普通用户、版主、管理员）
- 认证方案
  - 绕过Security认证流程，采用原来的认证方案
- CSFR配置
  - 防止CSRF攻击的基本原理，以及表单、AJAX相关配置

## 15.1 Security配置

将原来的LoginRequiredInterceptor注解掉

本来需要配置

- 忽略请求
- 认证
- 授权

因为我们认证想继续使用我们自己的认证方式，所以没有配置认证。但是因为Security需要知道用户有哪些权限，所以我们在UserService中添加一个获取权限的接口

```java
@Configuration
public class SecurityConfig extends WebSecurityConfigurerAdapter implements CommunityConstant {

    //放过请求
    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/resources/**");
    }

    //绕过security的认证，使用自己的认证
    //但是这样security并不能知道我的用户 有哪些权限
    //所以需要在UserService.java中新增权限接口,将用户的权限存入SecurityContext


    //授权
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests()
                .antMatchers(
                        "/user/setting",
                        "/user/upload",
                        "/discuss/add",
                        "/comment/add/**",
                        "/letter/**",
                        "/notice/**",
                        "/like",
                        "/follow",
                        "/unfollow"
                )
                .hasAnyAuthority(//访问以上路径需要有以下权限
                        AUTHORITY_USER,
                        AUTHORITY_ADMIN,
                        AUTHORITY_MODERATOR
                )
                .anyRequest().permitAll();//其余所有的请求都允许
        //权限不够时的处理
        http.exceptionHandling()
                .authenticationEntryPoint(new AuthenticationEntryPoint() {//没有登录时的处理
                    @Override
                    public void commence(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AuthenticationException e) throws IOException, ServletException {
                        //区别同步请求和异步请求
                        String xRequestWith = httpServletRequest.getHeader("x-requested-with");
                        if("XMLHttpRequest".equals(xRequestWith)){
                            //异步请求
                            httpServletResponse.setContentType("application/plain;charset=utf-8");
                            PrintWriter writer = httpServletResponse.getWriter();
                            writer.write(CommunityUtils.getJSONString(403,"你还没有登录!"));//异步请求返回一个json
                        }else{
                            //同步请求
                            httpServletResponse.sendRedirect(httpServletRequest.getContextPath()+"/login");
                        }
                    }
                })
                .accessDeniedHandler(new AccessDeniedHandler() {//登录了权限不足
                    @Override
                    public void handle(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, AccessDeniedException e) throws IOException, ServletException {
                        //区别同步请求和异步请求
                        String xRequestWith = httpServletRequest.getHeader("x-requested-with");
                        if("XMLHttpRequest".equals(xRequestWith)){
                            //异步请求
                            httpServletResponse.setContentType("application/plain;charset=utf-8");
                            PrintWriter writer = httpServletResponse.getWriter();
                            writer.write(CommunityUtils.getJSONString(403,"你没有访问此功能的权限!"));//异步请求返回一个json
                        }else{
                            //同步请求
                            httpServletResponse.sendRedirect(httpServletRequest.getContextPath()+"/denied");
                        }
                    }
                });
        //security会自动拦截名为/logout的请求，进行退出请求
        //但是现在我不想执行默认的logout，只想用自己的
        //此时对security的拦截退出拦截路径做一个配置，让它不生效
        http.logout()
                .logoutUrl("/securitylogout");
    }
}
```

## 15.2 权限存储

我们需要将登录过的用户的权限存入到SecurityContext中

**在LoginTicketInterceptor的preHandle方法中添加一个获取权限存入的流程**

```java
@Override
public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
    //从cookie中取得凭证
    String ticket = CookieUtils.getValue(request,"ticket");

    if(ticket!=null){
        //有登录信息
        LoginTicket loginTicket = loginTicketService.selectByTicket(ticket);
        //检查凭证有效性
        if(loginTicket!=null && loginTicket.getStatus()==0 && loginTicket.getExpired().after(new Date())){
            //有效,根据凭证查询用户
            User user = userService.selectById(loginTicket.getUserId());
            //在本次请求中持有用户
            hostHolder.setValue(user);

            //构建用户认证的结果，并且存入SecurityContext，以便于Security进行授权
            Authentication authentication = new UsernamePasswordAuthenticationToken(
                    user,user.getPassword(), userService.getAuthorities(user.getId()));
            SecurityContextHolder.setContext(new SecurityContextImpl(authentication));
        }
    }
    return true;
}
```

**退出的话将其删掉（出错了）**

afterCompletion是每次模板渲染完成后都会执行，所以每次请求完成后都会有清理工作

我们还需要在退出请求中也清理数据

```java
@Override
public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
    hostHolder.remove();
	
    //SecurityContextHolder.clearContext();
}
```

错误现象：先访问首页，再访问权限页面。第一次访问需要登录权限的服务可以正常访问，第二次访问时就会提示我们登录

排错：如果在每次模板渲染后删除掉SecurityContextHolder的信息，会导致用户凭证被删除，然后在访问需要凭证的服务时，Security获取不到凭证从而提示需要登录。

解决错误：删除afterCompletion中的SecurityContextHolder.clearContext();

内在原因：因为Security底层是由Filter实现的，我们应用权限的获取写在Interceptor中。第一次我们访问index获取到了授权信息将其保存到了SecurityContextHolder中，页面渲染完成调用了afterCompletion删除掉了这个信息，当我们再次访问需要授权的页面时，Filter先于Interceptor工作认为我们没有授权将我们阻止了。（不知道为什么第一次访问需要登录权限的服务可以正常访问，按道理从首页获取后也应该删除啊）

**退出请求**

LoginController

```java
/**
 * 注销登录请求
 * @param ticket
 * @return
 */
@RequestMapping(value = "/logout",method = RequestMethod.GET)
public String logout(@CookieValue("ticket") String ticket){
    loginTicketService.updateLoginTicket(ticket,1);
    SecurityContextHolder.clearContext();
    return "redirect:/login";
}
```

## 15.3 获取权限

UserService接口

```java
/**
 * 获取用户有哪些权限
 * @param userId
 * @return
 */
Collection<? extends GrantedAuthority> getAuthorities(int userId);
```

实现

```java
@Override
public Collection<? extends GrantedAuthority> getAuthorities(int userId) {
    User user = this.selectById(userId);
    List<GrantedAuthority> list = new ArrayList<>();
    list.add(new GrantedAuthority() {
        @Override
        public String getAuthority() {
            switch(user.getType()){
                case 1:
                    return AUTHORITY_ADMIN;
                case 2:
                    return AUTHORITY_MODERATOR;
                default:
                    return AUTHORITY_USER;
            }
        }
    });
    return list;
}
```

## 15.4 CSRF配置

CSRF：钓鱼网站盗取用户的cookie信息，并代替用户向服务器发送请求，从而达到窃取资源的目的

Security底层给用户返回表单页面的时候附带一个隐藏的Token，当用户提交表单时有这个Token，那么就是正常的；如果没有，则说明这是伪造信息。



如果是异步请求就需要自己处理,哪个异步请求需要安全设置，就加在哪个页面

下面我们需要在发帖时进行安全保护，所以在index.html和index.js中设置

### 15.4.1 异步请求

**页面头部生成令牌**

```html
<!--    访问该页面时，在此处生成一个CSRF令牌-->
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
```

**将令牌加入异步请求头**

```js
//发送ajax请求之前，将CSRF设置到消息头中
var token = $("meta[name='_csrf']").attr("content");//获得meta标签name为_csrf的content属性值
var header = $("meta[name='_csrf_header']").attr("content");
$(document).ajaxSend(function(e,xhr,options){
   xhr.setRequestHeader(header,token);//key-value
});
```

# 16 置顶、加精、删除

- 功能实现
  - 点击置顶，修改帖子的类型
  - 点击加精、删除，修改帖子的状态
- 权限管理
  - 版主可以执行置顶、加精操作
  - 管理员可以执行删除操作
- 按钮显示
  - 版主可以看到置顶、加精按钮
  - 管理员可以看到删除按钮

我们将使用权限管理来进行管理模板的按钮使用权限。tymeleaf对security有支持，需要额外导包

```java
<dependency>
    <groupId>org.thymeleaf.extras</groupId>
    <artifactId>thymeleaf-extras-springsecurity5</artifactId>
</dependency>
```

## 16.1 数据层接口与实现

**在DiscussPostMapper中添加接口**

```java
/**
 * 根据id修改帖子类型
 * @param id
 * @param type 0普通 1置顶
 * @return
 */
int updateType(int id,int type);

/**
 * 根据id修改帖子类型
 * @param id
 * @param status 0普通 1精华 2拉黑
 * @return
 */
int updateStatus(int id,int status);
```

**实现接口**

```xml
<update id="updateType">
    update discuss_post set type = #{type} where id = #{id}
</update>

<update id="updateStatus">
    update discuss_post set status = #{status} where id = #{id}
</update>
```

## 16.2 业务层接口与实现

**在DiscussPostServiceImpl中实现**

```java
@Override
public int updateType(int id, int type) {
    return discussPostMapper.updateType(id, type);
}

@Override
public int updateStatus(int id, int status) {
    return discussPostMapper.updateStatus(id, status);
}
```

## 16.3 表现层

**在DiscussPostController中添加三个方法**

将这些操作给用户发送通知

produce发送通知，consumer读取通知，添加主题

```java
@KafkaListener(topics = {TOPIC_COMMENT,TOPIC_FOLLOW,TOPIC_LIKE,TOPIC_TOP,TOPIC_DELETE,TOPIC_HIGHLIGHT})
```

```java
//置顶
@RequestMapping(value = "/top",method = RequestMethod.POST)
@ResponseBody
public String setTop(int entityId,int entityUserId){
    int row = discussPostService.updateType(entityId, POST_TYPE_TOP);

    //发送系统通知
    Event event = new Event()
            .setTopic(TOPIC_TOP)
            .setUserId(hostHolder.getValue().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(entityId)
            .setEntityUserId(entityUserId);
    eventProducer.fireEvent(event);


    return CommunityUtils.getJSONString(row);
}

//加精
@RequestMapping(value = "/highlight",method = RequestMethod.POST)
@ResponseBody
public String setHighlight(int entityId,int entityUserId){
    int row = discussPostService.updateStatus(entityId, POST_STATUS_HIGHLIGHT);

    //发送系统通知
    Event event = new Event()
            .setTopic(TOPIC_HIGHLIGHT)
            .setUserId(hostHolder.getValue().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(entityId)
            .setEntityUserId(entityUserId);
    eventProducer.fireEvent(event);

    return CommunityUtils.getJSONString(row);
}

//删除
@RequestMapping(value = "/delete",method = RequestMethod.POST)
@ResponseBody
public String deletePost(int entityId,int entityUserId){
    int row = discussPostService.updateStatus(entityId, POST_STATUS_BLACK);

    //发送系统通知
    Event event = new Event()
            .setTopic(TOPIC_DELETE)
            .setUserId(hostHolder.getValue().getId())
            .setEntityType(ENTITY_TYPE_POST)
            .setEntityId(entityId)
            .setEntityUserId(entityUserId);
    eventProducer.fireEvent(event);

    return CommunityUtils.getJSONString(row);
}
```

**修改页面**

给这三个按钮增加id，方便jQuery取值

```html
<button type="button" class="btn btn-danger btn-sm" id="topBtn" th:text="${post.type==0?'置顶':'取消置顶'}">置顶</button>
<button type="button" class="btn btn-danger btn-sm" id="highlightBtn" th:text="${post.status==0?'加精':'取消加精'}">加精</button>
<button type="button" class="btn btn-danger btn-sm" id="deleteBtn">删除</button>
```

按钮js

```js
$(function () {
    $("#topBtn").click(setTop);
    $("#highlightBtn").click(setHighlight);
    $("#deleteBtn").click(setDelete);
});

//置顶
function setTop() {
    $.post({
        url: CONTEXT_PATH + "/discuss/top",
        data: {
            "entityId": $("#postId").val(),
            "entityUserId": $("#userId").val()
        },
        success: function (data) {
            data = $.parseJSON(data);
            if (data.code === 1) {
                if("置顶"===$("#topBtn").text()){
                    $("#topBtn").text("取消置顶");
                }else{
                    $("#topBtn").text("置顶");
                }
                // $("#topBtn").attr("disabled", "disabled");
            }else{
                alert(data.msg);
            }
        }
    });
}

//加精
function setHighlight() {
    $.post({
        url: CONTEXT_PATH + "/discuss/highlight",
        data: {
            "entityId": $("#postId").val(),
            "entityUserId": $("#userId").val()
        },
        success: function (data) {
            data = $.parseJSON(data);
            if (data.code === 1) {
                if("加精"===$("#highlightBtn").text()){
                    $("#highlightBtn").text("取消加精");
                }else{
                    $("#highlightBtnBtn").text("加精");
                }
            }else{
                alert(data.msg);
            }
        }
    });
}

//删除
function setDelete() {
    $.post({
        url: CONTEXT_PATH + "/discuss/delete",
        data: {
            "entityId": $("#postId").val(),
            "entityUserId": $("#userId").val()
        },
        success: function (data) {
            data = $.parseJSON(data);
            if (data.code == 1) {
                location.href = CONTEXT_PATH + "/index";
            }
        }
    });
}
```

## 16.4 权限控制

**在SecurityConfig中添加一个权限路径**

```java
.antMatchers(
        "/discuss/top",
        "/discuss/highlight"
)
.hasAnyAuthority(
        AUTHORITY_MODERATOR
)
.antMatchers(
        "/discuss/delete"
)
.hasAnyAuthority(
        AUTHORITY_ADMIN
)
```

**将没有权限的按钮从页面隐藏**

新增命名空间

多个权限可以用逗号分割

```html
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<button type="button" class="btn btn-danger btn-sm" id="topBtn"
      th:text="${post.type==0?'置顶':'取消置顶'}" sec:authorize="hasAnyAuthority('moderator')">置顶</button>
<button type="button" class="btn btn-danger btn-sm" id="highlightBtn"
      th:text="${post.status==0?'加精':'取消加精'}" sec:authorize="hasAnyAuthority('moderator')">加精</button>
<button type="button" class="btn btn-danger btn-sm" id="deleteBtn" sec:authorize="hasAnyAuthority('admin')">删除</button>
```

# 17 网站数据统计

使用Redis进行网站数据的统计

Redis有两个高级数据类型

- HyperLogLog
  - 采用一种基数算法，用于完成独立总数的统计
  - 占据空间小，无论统计多少个数据，只占12k的内存空间
  - 不精确的统计算法、标准误差为0.81%
- Bitmap
  - 不是一种独立的数据结构，实际上是字符串
  - 支持按位存取数据，可以将其看成是byte数组
  - 适合存储大量连续的数据的布尔值

- UV（Unique Visitor）
  - 独立访客，需要通过用户IP排重统计数据
  - 每次访问都要进行统计
  - HyperLogLog，性能好，存储空间小
- DAU（Daily Active User）
  - 日活跃用户，需通过用户ID排重统计数据
  - 访问过一次，则认为其活跃
  - Bitmap，性能好、且可以统计精确结果

## 17.1 添加RedisKey

```java
private static final String PREFIX_UV = "uv";
private static final String PREFIX_DAU = "dau";

/**
 * 获取单日的uv key
 *
 * @param date
 * @return
 */
public static String getUVKey(String date) {
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_UV)
            .append(SPLIT)
            .append(date);
    return sb.toString();
}

/**
 * 区间uv key
 * @return
 */
public static String getUVKey(String startDate, String endDate) {
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_UV)
            .append(SPLIT)
            .append(startDate)
            .append(SPLIT)
            .append(endDate);
    return sb.toString();
}

/**
 * 获取单日 dau key
 * @param date
 * @return String
 */
public static String getDAUKey(String date){
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_DAU)
            .append(SPLIT)
            .append(date);
    return sb.toString();
}

/**
 * 区间dau key
 * @return
 */
public static String getDAUKey(String startDate, String endDate) {
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_DAU)
            .append(SPLIT)
            .append(startDate)
            .append(SPLIT)
            .append(endDate);
    return sb.toString();
}
```

## 17.2 业务层接口与实现

**新建DataService接口文件**

```java
public interface DataService {

    /**
     * 将指定ip记录进uv
     * @param ip
     */
    void recordUV(String ip);

    /**
     * 计算一个时间段内的uv
     * @param startDate
     * @param endDate
     * @return
     */
    long calculateUV(Date startDate,Date endDate);

    /**
     * 将指定用户记录进dau
     * @param userId
     */
    void recordDAU(int userId);

    /**
     * 计算一个时间段内的dau，任何一天活跃就是这个时间段内活跃
     * @param startDate
     * @param endDate
     * @return
     */
    long calculateDAU(Date startDate,Date endDate);
}
```

**接口实现**

```java
@Service
public class DataServiceImpl implements DataService {

    @Autowired
    private RedisTemplate redisTemplate;

    //日期格式
    private SimpleDateFormat df = new SimpleDateFormat("yyyyMMdd");


    @Override
    public void recordUV(String ip) {
        String uvKey = RedisKeyUtil.getUVKey(df.format(new Date()));
        redisTemplate.opsForHyperLogLog().add(uvKey,ip);
    }

    @Override
    public long calculateUV(Date startDate, Date endDate) {
        if(startDate==null || endDate==null){
            throw new IllegalArgumentException("参数不能为空");
        }

        //整理该日期范围内的key
        List<String> keyList = new ArrayList<>();
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(startDate);
        while(!calendar.getTime().after(endDate)){//不晚于endDate
            String uvKey = RedisKeyUtil.getUVKey(df.format(calendar.getTime()));
            keyList.add(uvKey);
            calendar.add(Calendar.DATE,1);
        }
        //合并数据
        String redisKey = RedisKeyUtil.getUVKey(df.format(startDate),df.format(endDate));
        redisTemplate.opsForHyperLogLog().union(redisKey,keyList.toArray());
        return redisTemplate.opsForHyperLogLog().size(redisKey);
    }

    @Override
    public void recordDAU(int userId) {
        String dauKey = RedisKeyUtil.getDAUKey(df.format(new Date()));
        redisTemplate.opsForValue().setBit(dauKey,userId,true);//类似数组哈希表
    }

    @Override
    public long calculateDAU(Date startDate, Date endDate) {
        if(startDate==null || endDate==null){
            throw new IllegalArgumentException("参数不能为空");
        }

        //整理该日期范围内的key
        List<byte[]> keyList = new ArrayList<>();
        Calendar calendar = Calendar.getInstance();
        calendar.setTime(startDate);
        while(!calendar.getTime().after(endDate)){//不晚于endDate
            String dauKey = RedisKeyUtil.getDAUKey(df.format(calendar.getTime()));
            keyList.add(dauKey.getBytes());
            calendar.add(Calendar.DATE,1);
        }
        //进行OR运算，这段时间有一天活跃就是这段时间活跃
        return (long) redisTemplate.execute(new RedisCallback() {
            @Override
            public Object doInRedis(RedisConnection connection) throws DataAccessException {
                String redisKey = RedisKeyUtil.getDAUKey(df.format(startDate),df.format(endDate));
                connection.bitOp(
                        RedisStringCommands.BitOperation.OR,//进行什么运算
                        redisKey.getBytes(),//运算结果存入哪里
                        keyList.toArray(new byte[0][0])//对keyList做运算
                );
                return connection.bitCount(redisKey.getBytes());
            }
        });
    }
}
```

## 17.3 拦截器记录数据

**新建拦截器DataInterceptor**

```java
@Component
public class DataInterceptor implements HandlerInterceptor {

    @Autowired
    private DataService dataService;

    @Autowired
    private HostHolder hostHolder;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //统计UV
        String ip = request.getRemoteHost();
        dataService.recordUV(ip);

        //统计DAU
        User user = hostHolder.getValue();
        if (user != null) {
            dataService.recordDAU(user.getId());
        }
        return true;
    }
}
```

**在WebMvcConfig中配置**

过滤静态资源

```java
registry.addInterceptor(dataInterceptor)
        .excludePathPatterns("/**/*.js","/**/*.css","/**/*.png","/**/*.jpg","/**/*.jpeg");
```

## 17.4 表现层

**创建DataController**

```java
@Controller
public class DataController {

    @Autowired
    private DataService dataService;

    @RequestMapping(value = "/data", method = {RequestMethod.GET, RequestMethod.POST})
    public String getDataPage() {
        return "site/admin/data";
    }

    @RequestMapping(value = "/data/uv", method = RequestMethod.POST)
    public String getUV(@DateTimeFormat(pattern = "yyyy-MM-dd") Date start,
                        @DateTimeFormat(pattern = "yyyy-MM-dd") Date end, Model model) {//告诉服务器自己传的日期是什么格式
        long uvCount = dataService.calculateUV(start, end);
        model.addAttribute("uvCount",uvCount);
        model.addAttribute("uvStartDate",start);
        model.addAttribute("uvEndDate",end);

        return "forward:/data";
    }

    @RequestMapping(value = "/data/dau", method = RequestMethod.POST)
    public String getDAU(@DateTimeFormat(pattern = "yyyy-MM-dd") Date start,
                        @DateTimeFormat(pattern = "yyyy-MM-dd") Date end, Model model) {//告诉服务器自己传的日期是什么格式
        long dauCount = dataService.calculateDAU(start, end);
        model.addAttribute("dauCount",dauCount);
        model.addAttribute("dauStartDate",start);
        model.addAttribute("dauEndDate",end);

        return "forward:/data";
    }
}
```

**修改页面**

```html
<!-- 内容 -->
<div class="main">
   <!-- 网站UV -->
   <div class="container pl-5 pr-5 pt-3 pb-3 mt-3">
      <h6 class="mt-3"><b class="square"></b> 网站 UV</h6>
      <form class="form-inline mt-3" method="post" th:action="@{/data/uv}">
         <input type="date" class="form-control" name="start" th:value="${#dates.format(uvStartDate,'yyyy-MM-dd')}" required/>
         <input type="date" class="form-control ml-3" name="end" th:value="${#dates.format(uvEndDate,'yyyy-MM-dd')}" required/>
         <button type="submit" class="btn btn-primary ml-3">开始统计</button>
      </form>
      <ul class="list-group mt-3 mb-3">
         <li class="list-group-item d-flex justify-content-between align-items-center">
            统计结果
            <span class="badge badge-primary badge-danger font-size-14" th:text="${uvCount}">0</span>
         </li>
      </ul>
   </div>
   <!-- 活跃用户 -->
   <div class="container pl-5 pr-5 pt-3 pb-3 mt-4">
      <h6 class="mt-3"><b class="square"></b> 活跃用户</h6>
      <form class="form-inline mt-3" method="post" th:action="@{/data/dau}">
         <input type="date" class="form-control" required name="start" th:value="${#dates.format(dauStartDate,'yyyy-MM-dd')}"/>
         <input type="date" class="form-control ml-3" required name="end" th:value="${#dates.format(dauEndDate,'yyyy-MM-dd')}"/>
         <button type="submit" class="btn btn-primary ml-3">开始统计</button>
      </form>
      <ul class="list-group mt-3 mb-3">
         <li class="list-group-item d-flex justify-content-between align-items-center">
            统计结果
            <span class="badge badge-primary badge-danger font-size-14" th:text="${dauCount}">0</span>
         </li>
      </ul>
   </div>          
</div>
```

**最后在增加权限**

在SecurityConfig中增加/data/**路径



# 18 热帖排行

## 18.1 任务执行和调度

- JDK线程池
  - ExecutorService
  - ScheduledExecutorService
- Spring 线程池
  - ThredPoolTaskExecutor
  - ThredPoolTaskScheduler
- 分布式定时任务
  - Spring Quartz

Quartz从数据库中获取配置对分布式节点进行调度，所以库中需要有相关的表，这些表的字段根据Quartz的源码进行定义

```mysql
#
# In your Quartz properties file, you'll need to set
# org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate
# By: Ron Cordell - roncordell
#  I didn't see this anywhere, so I thought I'd post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.

DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;
DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;
DROP TABLE IF EXISTS QRTZ_LOCKS;
DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_TRIGGERS;
DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;
DROP TABLE IF EXISTS QRTZ_CALENDARS;

CREATE TABLE QRTZ_JOB_DETAILS(
SCHED_NAME VARCHAR(120) NOT NULL,
JOB_NAME VARCHAR(190) NOT NULL,
JOB_GROUP VARCHAR(190) NOT NULL,
DESCRIPTION VARCHAR(250) NULL,
JOB_CLASS_NAME VARCHAR(250) NOT NULL,
IS_DURABLE VARCHAR(1) NOT NULL,
IS_NONCONCURRENT VARCHAR(1) NOT NULL,
IS_UPDATE_DATA VARCHAR(1) NOT NULL,
REQUESTS_RECOVERY VARCHAR(1) NOT NULL,
JOB_DATA BLOB NULL,
PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(190) NOT NULL,
TRIGGER_GROUP VARCHAR(190) NOT NULL,
JOB_NAME VARCHAR(190) NOT NULL,
JOB_GROUP VARCHAR(190) NOT NULL,
DESCRIPTION VARCHAR(250) NULL,
NEXT_FIRE_TIME BIGINT(13) NULL,
PREV_FIRE_TIME BIGINT(13) NULL,
PRIORITY INTEGER NULL,
TRIGGER_STATE VARCHAR(16) NOT NULL,
TRIGGER_TYPE VARCHAR(8) NOT NULL,
START_TIME BIGINT(13) NOT NULL,
END_TIME BIGINT(13) NULL,
CALENDAR_NAME VARCHAR(190) NULL,
MISFIRE_INSTR SMALLINT(2) NULL,
JOB_DATA BLOB NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)
REFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_SIMPLE_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(190) NOT NULL,
TRIGGER_GROUP VARCHAR(190) NOT NULL,
REPEAT_COUNT BIGINT(7) NOT NULL,
REPEAT_INTERVAL BIGINT(12) NOT NULL,
TIMES_TRIGGERED BIGINT(10) NOT NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_CRON_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(190) NOT NULL,
TRIGGER_GROUP VARCHAR(190) NOT NULL,
CRON_EXPRESSION VARCHAR(120) NOT NULL,
TIME_ZONE_ID VARCHAR(80),
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_SIMPROP_TRIGGERS
  (
    SCHED_NAME VARCHAR(120) NOT NULL,
    TRIGGER_NAME VARCHAR(190) NOT NULL,
    TRIGGER_GROUP VARCHAR(190) NOT NULL,
    STR_PROP_1 VARCHAR(512) NULL,
    STR_PROP_2 VARCHAR(512) NULL,
    STR_PROP_3 VARCHAR(512) NULL,
    INT_PROP_1 INT NULL,
    INT_PROP_2 INT NULL,
    LONG_PROP_1 BIGINT NULL,
    LONG_PROP_2 BIGINT NULL,
    DEC_PROP_1 NUMERIC(13,4) NULL,
    DEC_PROP_2 NUMERIC(13,4) NULL,
    BOOL_PROP_1 VARCHAR(1) NULL,
    BOOL_PROP_2 VARCHAR(1) NULL,
    PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
    FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
    REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_BLOB_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_NAME VARCHAR(190) NOT NULL,
TRIGGER_GROUP VARCHAR(190) NOT NULL,
BLOB_DATA BLOB NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),
INDEX (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),
FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)
REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_CALENDARS (
SCHED_NAME VARCHAR(120) NOT NULL,
CALENDAR_NAME VARCHAR(190) NOT NULL,
CALENDAR BLOB NOT NULL,
PRIMARY KEY (SCHED_NAME,CALENDAR_NAME))
ENGINE=InnoDB;

CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (
SCHED_NAME VARCHAR(120) NOT NULL,
TRIGGER_GROUP VARCHAR(190) NOT NULL,
PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP))
ENGINE=InnoDB;

CREATE TABLE QRTZ_FIRED_TRIGGERS (
SCHED_NAME VARCHAR(120) NOT NULL,
ENTRY_ID VARCHAR(95) NOT NULL,
TRIGGER_NAME VARCHAR(190) NOT NULL,
TRIGGER_GROUP VARCHAR(190) NOT NULL,
INSTANCE_NAME VARCHAR(190) NOT NULL,
FIRED_TIME BIGINT(13) NOT NULL,
SCHED_TIME BIGINT(13) NOT NULL,
PRIORITY INTEGER NOT NULL,
STATE VARCHAR(16) NOT NULL,
JOB_NAME VARCHAR(190) NULL,
JOB_GROUP VARCHAR(190) NULL,
IS_NONCONCURRENT VARCHAR(1) NULL,
REQUESTS_RECOVERY VARCHAR(1) NULL,
PRIMARY KEY (SCHED_NAME,ENTRY_ID))
ENGINE=InnoDB;

CREATE TABLE QRTZ_SCHEDULER_STATE (
SCHED_NAME VARCHAR(120) NOT NULL,
INSTANCE_NAME VARCHAR(190) NOT NULL,
LAST_CHECKIN_TIME BIGINT(13) NOT NULL,
CHECKIN_INTERVAL BIGINT(13) NOT NULL,
PRIMARY KEY (SCHED_NAME,INSTANCE_NAME))
ENGINE=InnoDB;

CREATE TABLE QRTZ_LOCKS (
SCHED_NAME VARCHAR(120) NOT NULL,
LOCK_NAME VARCHAR(40) NOT NULL,
PRIMARY KEY (SCHED_NAME,LOCK_NAME))
ENGINE=InnoDB;

CREATE INDEX IDX_QRTZ_J_REQ_RECOVERY ON QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);
CREATE INDEX IDX_QRTZ_J_GRP ON QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);

CREATE INDEX IDX_QRTZ_T_J ON QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_T_JG ON QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_T_C ON QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);
CREATE INDEX IDX_QRTZ_T_G ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);
CREATE INDEX IDX_QRTZ_T_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_N_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_N_G_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_NEXT_FIRE_TIME ON QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);
CREATE INDEX IDX_QRTZ_T_NFT_ST ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);
CREATE INDEX IDX_QRTZ_T_NFT_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);
CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);
CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE_GRP ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);

CREATE INDEX IDX_QRTZ_FT_TRIG_INST_NAME ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);
CREATE INDEX IDX_QRTZ_FT_INST_JOB_REQ_RCVRY ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);
CREATE INDEX IDX_QRTZ_FT_J_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_FT_JG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);
CREATE INDEX IDX_QRTZ_FT_T_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);
CREATE INDEX IDX_QRTZ_FT_TG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);

commit;
```

导入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-quartz</artifactId>
</dependency>
```

配置

```yml
# Quartz
quartz:
  job-store-type: jdbc
  scheduler-name: communityScheduler
  properties:
    org:
      quartz:
        scheduler:
          instanceId: AUTO
        jobStore:
          class: org.quartz.impl.jdbcjobstore.JobStoreTX
          driverDelegateClass: org.quartz.impl.jdbcjobstore.StdJDBCDelegate
          isClustered: true
        threadPool:
          class: org.quartz.simpl.SimpleThreadPool
          threadCount: 5

# TaskExecution
task:
  execution:
    pool:
      core-size: 5 # 开启5个线程
      max-size: 15 # 必要时最大开到15
      queue-capacity: 100 # 15还不够用，则用队列将任务阻塞
  # TaskScheduling
  scheduling:
    pool:
      size: 5 # 计划任务线程
```



## 18.2 添加RedisKey

我们将计算帖子的分数，并存入redis

因为网站时间很长的时候帖子会很多，如果把所有帖子统计一遍分数效率是很低的，所以我们只对近期有过修改的帖子进行统计，并将其存入redis，定时任务一道统一计算分数

```java
private static final String PREFIX_POST = "post";

/**
 * 统计帖子分数key
 * @return
 */
public static String getPostScoreKey() {
    StringBuilder sb = new StringBuilder();
    sb.append(PREFIX_POST)
            .append(SPLIT)
            .append("score");
    return sb.toString();
}
```

## 18.3 准备计算

### 18.3.1 发帖

```java
//将有变化的帖子id加入到redis
String postScoreKey = RedisKeyUtil.getPostScoreKey();
redisTemplate.opsForSet().add(postScoreKey, discussPost.getId());
```

### 18.3.2 加精

```java
//将有变化的帖子id加入到redis
String postScoreKey = RedisKeyUtil.getPostScoreKey();
redisTemplate.opsForSet().add(postScoreKey, entityId);
```

### 18.3.3 评论

只对帖子进行评论的时候才计算分数

```java
if (comment.getEntityType() == ENTITY_TYPE_POST) {
    //给帖子得评论，从帖子表查询
    DiscussPost target = discussPostService.selectDiscussPost(comment.getEntityId());
    event.setEntityUserId(target.getUserId());

    //将有变化的帖子id加入到redis
    String postScoreKey = RedisKeyUtil.getPostScoreKey();
    redisTemplate.opsForSet().add(postScoreKey, discussPostId);
    
}
```

### 18.3.4 点赞

```java
if(entityType == ENTITY_TYPE_POST){
    //只对点赞帖子进行分数计算
    //将有变化的帖子id加入到redis
    String postScoreKey = RedisKeyUtil.getPostScoreKey();
    redisTemplate.opsForSet().add(postScoreKey, postId);
}
```

## 18.4 计算分数

### 18.4.1 Quartz

```java
public class PostScoreRefreshJob implements Job, CommunityConstant {

    private static final Logger logger = LoggerFactory.getLogger(PostScoreRefreshJob.class);

    @Autowired
    private RedisTemplate redisTemplate;

    @Autowired
    private LikeService likeService;

    @Autowired
    private DiscussPostService discussPostService;

    private static final Date epoch;

    static {
        try {
            epoch = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").parse("2014-08-01 00:00:00");
        } catch (ParseException e) {
            throw new RuntimeException("初始化牛客纪元失败", e);
        }
    }

    @Override
    public void execute(JobExecutionContext jobExecutionContext) throws JobExecutionException {
        String redisKey = RedisKeyUtil.getPostScoreKey();
        BoundSetOperations operations = redisTemplate.boundSetOps(redisKey);

        if (operations.size() == 0) {
            logger.info("[任务取消] 没有需要刷新的帖子!");
            return;
        }

        logger.info("[任务开始] 正在刷新帖子分数!" + operations.size());
        while (operations.size() > 0) {
            this.refresh((Integer) operations.pop());
        }
        logger.info("[任务结束] 帖子分数刷新完毕!");

    }

    private void refresh(int postId) {
        DiscussPost post = discussPostService.selectDiscussPost(postId);

        if (post == null) {
            logger.error("该帖子不存在:" + postId);
            return;
        }

        //是否精华
        boolean highlight = post.getStatus() == POST_STATUS_HIGHLIGHT;
        //评论数量
        int commentCount = post.getCommentCount();
        //点赞数量
        long likeCount = likeService.selectEntityLikeCount(ENTITY_TYPE_POST, postId);

        //计算权重
        double w = (highlight ? 75 : 0) + commentCount * 10 + likeCount * 2;
        //分数 = 帖子权重 + 距离天数
        double score = Math.log(Math.max(w, 1) + ((post.getCreateTime().getTime() - epoch.getTime()) / (1000 * 3600 * 24)));

        //更新帖子分数
        discussPostService.updateScore(postId,score);
    }
}
```

数据层与业务层增加更新帖子分数的接口与实现

### 18.4.2 QuartzConfig

```java
//配置->数据库->调用
@Configuration
public class QuartzConfig {

    //FactoryBean可简化实例化过程，工厂模式
    //1.通过FactoryBean封装Bean的实例化过程
    //2.将FactoryBean装配到Spring容器中
    //3.将FactoryBean注入给其他Bean
    //4.该Bean得到的是FactoryBean所管理的对象实例

    //配置JobDetail
    //刷新帖子任务
    @Bean
    public JobDetailFactoryBean postScoreRefreshJobDetail(){
        JobDetailFactoryBean factoryBean = new JobDetailFactoryBean();
        factoryBean.setJobClass(PostScoreRefreshJob.class);
        factoryBean.setBeanName("postScoreRefreshJob");//任务名称，不能重复
        factoryBean.setGroup("communityJobGroup");//任务所在组
        factoryBean.setDurability(true);//任务是长久保存吗
        factoryBean.setRequestsRecovery(true);//任务是否可恢复
        return factoryBean;
    }
    //配置Trigger(SimpleTriggerFactoryBean, CronTriggerFactoryBean)
    @Bean
    public SimpleTriggerFactoryBean postScoreRefreshTrigger(JobDetail postScoreRefreshJobDetail){
        SimpleTriggerFactoryBean factoryBean = new SimpleTriggerFactoryBean();
        factoryBean.setJobDetail(postScoreRefreshJobDetail);//触发器对应的任务
        factoryBean.setBeanName("postScoreRefreshTrigger");//任务名称，不能重复
        factoryBean.setGroup("postScoreRefreshTriggerGroup");//任务所在组
        factoryBean.setRepeatInterval(1000 * 60 * 5);//触发间隔，毫秒单位
        factoryBean.setJobDataMap(new JobDataMap());
        return factoryBean;
    }

}
```

## 18.5 热帖显示

### 18.5.1 数据层接口与实现

重构原来的搜索帖子的接口。新增排序模式的参数

```java
/**
 * 查询帖子所有信息，以下参数作为动态sql的条件
 * @param userId 用户id，当在用户页面查询用户发的帖时需要。userId为0则代表查询所有用户的帖子
 * @param orderMode 排序方式
 * @return
 */
List<DiscussPost> selectDiscussPosts(@Param("userId") int userId, @Param("offset")int offset, @Param("limit") int limit, int orderMode);
```

实现

```xml
<select id="selectDiscussPosts" resultType="com.edu.ligen.nowcoder.entity.DiscussPost">
    select <include refid="selectFields"></include>
    from discuss_post
    where status!=2
    <if test="userId!=0">
        and user_id = #{userId}
    </if>
    order by type desc,
    <if test="orderMode==1">
        score desc,
    </if>
    create_time desc
    limit #{offset},#{limit}
</select>
```

### 18.5.2 业务层接口与实现

```java
@Override
public List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit, int orderMode) {
    return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode);
}
```

修改其他调用过该业务的地方

### 18.5.3 表现层

**修改IndexController**

- 传入参数增加一个orderMode
- 分页条件加上排序方式
- 最后将排序方式返回页面

```java
@RequestMapping(value = {"/","/index","/index.html"},method = RequestMethod.GET)
public String index(Model model, Page page,
                    @RequestParam(name="orderMode",defaultValue = "0") int orderMode ){//如果没有传该参数，默认为零
	 page.setPath("/index?orderMode=" + orderMode);   
    
    
    
    model.addAttribute("orderMode",orderMode);
    
}
```

**修改页面**

```html
<div class="position-relative">
   <!-- 筛选条件 -->
   <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
         <a th:class="|nav-link ${orderMode==0?'active':''}|" th:href="@{/index(orderMode=0)}">最新</a>
      </li>
      <li class="nav-item">
         <a th:class="|nav-link ${orderMode==1?'active':''}|" th:href="@{/index(orderMode=1)}">最热</a>
      </li>
   </ul>
   <button type="button" class="btn btn-primary btn-sm position-absolute rt-0"
         data-toggle="modal" data-target="#publishModal" th:if="${loginUser!=null}">我要发布</button>
</div>
```

# 19 项目结尾

## 19.1 压力测试

- 本地缓存
  - 将数据缓存再应用服务器上，性能最好
  - 常用缓存工具：Ehcache、Guava、Caffeine
- 分布式缓存
  - 将数据缓存在NoSql数据库上，跨服务器
  - 常用缓存工具：MemCache、Redis
- 多级缓存：
  - 一级缓存（本地缓存）->二级缓存（二级缓存）->DB
  - 避免缓存雪崩（缓存失效，大量请求直达DB），提高系统可用性



### 19.1.1 本地缓存

此处我们使用Caffeine进行本地缓存

```xml
<!--        Caffeine-->
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>2.7.0</version>
</dependency>
```

自定义配置参数

```yml
# Caffeine，自定义参数
caffeine:
  posts:
    max-size: 15 # 可以缓存多少帖子
    expire-seconds: 180 # 缓存失效时间
```

### 19.1.2 优化Service

**优先优化DiscussPostService**

需要注意的几个问题：

- 首页的帖子更新十分频繁，如果缓存进去反而会拉低性能。我们只缓存热门帖子

- 先定义需要缓存哪些信息
- 首次调用service时进行缓存

```java
@Value("${caffeine.posts.max-size}")
private int maxSize;

@Value("${caffeine.posts.expire-seconds}")
private int expireSeconds;

//Caffeine核心接口：
// Cache
// LoadingCache：同步的，多线程下，如果缓存中没有，会阻塞线程，然后从DB中获取缓存
// AsyncLoadingCache

//帖子列表的缓存
private LoadingCache<String, List<DiscussPost>> postListCache;

//帖子总数缓存
private LoadingCache<Integer, Integer> postRowsCache;

@PostConstruct
public void init(){
    //初始化帖子列表缓存
    postListCache = Caffeine.newBuilder()
            .maximumSize(maxSize)
            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)
            .build(new CacheLoader<String, List<DiscussPost>>() {
                @Override
                public @Nullable List<DiscussPost> load(@NonNull String key) throws Exception {
                    //如果缓存中没有该数据，Caffeine该怎么将这个数据查询到
                    if(key==null||key.length()==0){
                        throw new IllegalArgumentException("参数错误");
                    }
                    String[] params = key.split(":");
                    if(params==null||params.length!=2){
                        throw new IllegalArgumentException("参数错误");
                    }
                    int offset = Integer.parseInt(params[0]);
                    int limit = Integer.parseInt(params[1]);

                    //可以加一个二级缓存，访问redis
                    logger.debug("load post list from DB.");
                    return discussPostMapper.selectDiscussPosts(0,offset,limit,1);
                }
            });
    //初始化帖子总数缓存
    postRowsCache = Caffeine.newBuilder()
            .maximumSize(maxSize)
            .expireAfterWrite(expireSeconds, TimeUnit.SECONDS)
            .build(new CacheLoader<Integer, Integer>() {
                @Override
                public @Nullable Integer load(@NonNull Integer key) throws Exception {
                    logger.debug("load post rows from DB.");
                    return discussPostMapper.selectDiscussPostRows(key);
                }
            });

}

@Override
public List<DiscussPost> selectDiscussPosts(int userId, int offset, int limit, int orderMode) {
    //只缓存热门帖子
    if(userId==0 && orderMode==1){
        return postListCache.get(offset+":"+limit);
    }
    logger.debug("load post list from DB.");
    return discussPostMapper.selectDiscussPosts(userId, offset, limit, orderMode);
}

@Override
public int selectDiscussPostRows(int userId) {
    if(userId==0){
        return postRowsCache.get(userId);
    }
    logger.debug("load post rows from DB.");
    return discussPostMapper.selectDiscussPostRows(userId);
}
```

### 19.1.3 压力测试

使用JMeter进行压力测试，[下载地址](https://jmeter.apache.org/download_jmeter.cgi)

无缓存情况下,注解掉日志和缓存

软件解压后直接使用，打开 jMeter.bat

该软件模拟多用户访问应用

## 19.2 单元测试

- Spring Boot Testing
  - 依赖：spring-boot-stater-test
  - 包括：Junit、Spring Test、AssertJ
- Test Case
  - 要求：保证测试方法的独立性
  - 步骤：初始化数据、执行测试代码、验证测试结果、清理测试数据
  - 常用注解：@BeforeClass、@AfterClass、@Before、@After

## 19.3 项目监控

- Spring Boot Actuator
  - Endpoints：监控应用的入口，Spring Boot内置了很多端点，也支持自定义端点
  - 监控方式：HTTP或JMX
  - 访问路径：例如："/actuator/health"
  - 注意事项：按需配置暴露的端点，并对所有端点进行权限控制

导入依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

配置

```yml
# actuator
management:
  endpoints:
    web:
      exposure:
        include: "*" # 暴露所有端点
        exclude: "info,cache" # 排除端点
```

Actuator有内置的20多个端点，可以监控各种各样的信息，我们还可以自定义端点

```java
@Component
@Endpoint(id = "database")//该自定义端点的id，通过这个id访问
public class DataBaseEndpoint {

    private static final Logger logger = LoggerFactory.getLogger(DataBaseEndpoint.class);

    @Autowired
    private DataSource dataSource;
    Connection conn;
    @ReadOperation//通过get请求访问
    public String checkConnection(){

        try {
            conn = dataSource.getConnection();
            return CommunityUtils.getJSONString(0,"获取链接成功");
        } catch (SQLException throwables) {
            logger.error("获取链接失败"+throwables.getMessage());
            return CommunityUtils.getJSONString(1,"获取链接失败");
        }finally {
            try {
                conn.close();
            } catch (SQLException throwables) {
                throwables.printStackTrace();
            }
        }
    }
}

```

最后进行权限管理

## 19.4 项目部署

[完整流程](https://www.nowcoder.com/study/live/246/8/3)

## 19.5 项目总结

![](https://github.com/LiMuwenan/PicBed/blob/master/img/dev/java/project/nowcoder/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84.png?raw=true)


1.核心功能：
  \- 发帖、评论、私信、转发；
  \- 点赞、关注、通知、搜索；
  \- 权限、统计、调度、监控；
2.核心技术：
  \- Spring Boot、SSM
  \- Redis、Kafka、ElasticSearch
  \- Spring Security、Quartz、Caffeine
3.项目亮点：
  \- 项目构建在Spring Boot+SSM框架之上，并统一的进行了状态管理、事务管理、异常处理；
  \- 利用Redis实现了点赞和关注功能，单机可达5000TPS；
  \- 利用Kafka实现了异步的站内通知，单机可达7000TPS；
  \- 利用ElasticSearch实现了全文搜索功能，可准确匹配搜索结果，并高亮显示关键词；
  \- 利用Caffeine+Redis实现了两级缓存，并优化了热门帖子的访问，单机可达8000QPS。
  \- 利用Spring Security实现了权限控制，实现了多重角色、URL级别的权限管理；
  \- 利用HyperLogLog、Bitmap分别实现了UV、DAU的统计功能，100万用户数据只需*M内存空间；
  \- 利用Quartz实现了任务调度功能，并实现了定时计算帖子分数、定时清理垃圾文件等功能；
  \- 利用Actuator对应用的Bean、缓存、日志、路径等多个维度进行了监控，并通过自定义的端点对数据库连接进行了监控。